<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataWhiz - Advanced Business Analytics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Specific styles for this page */
        body {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #f0f6fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #58a6ff;
        }

        .header .back-button {
            background: none;
            border: none;
            color: #f0f6fc;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .header .back-button:hover {
            color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.1);
        }

        .header h1 {
            color: #f0f6fc;
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .header .btn-secondary {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        .header .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header .btn-secondary:hover {
            background: rgba(88, 166, 255, 0.2);
            border-color: rgba(88, 166, 255, 0.5);
        }

        /* Layout: simple two-column with natural page scroll */
        .main-content {
            padding: 20px;
            display: flex;
            flex-direction: column; /* stack control panel above results */
            align-items: center; /* center the control panel */
            gap: 24px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .control-panel {
            width: 100%;
            max-width: 900px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.4),
                0 0 0 1px rgba(88, 166, 255, 0.1),
                inset 0 1px 0 rgba(255,255,255,0.05);
            border: 1px solid rgba(88, 166, 255, 0.2);
            position: static;
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        /* -------- Dashboard responsive grid (replace older conflicting blocks) -------- */
        .dashboard-area { min-width: 0; width: 100%; }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* 1 / 2 / 3 columns responsive */
            gap: 24px;
            align-items: start;
            width: 100%;
            margin: 0 auto;
        }
        
        /* EDA Card specific styling for better layout */
        .eda-card {
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .eda-card .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-grid::-webkit-scrollbar {
            width: 8px;
        }
        
        .dashboard-grid::-webkit-scrollbar-track {
            background: #21262d;
            border-radius: 4px;
        }
        
        .dashboard-grid::-webkit-scrollbar-thumb {
            background: #58a6ff;
            border-radius: 4px;
        }
        
        .dashboard-grid::-webkit-scrollbar-thumb:hover {
            background: #79c0ff;
        }

        /* Sticky top overview section */
        .top-overview {
            position: relative;
            z-index: 2;
            padding: 12px 0 24px 0;
            background: transparent;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto 24px auto;
        }
        .top-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(460px, 1fr));
            gap: 20px;
            position: relative;
            z-index: 2;
        }

        /* Dashboard card overflow safety */
        /* Card base */
        .dashboard-card {
            background: linear-gradient(145deg, #161b22, #0d1117);
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
            border: 1px solid #263445;
            display: flex;
            flex-direction: column;
            min-height: 360px; /* give space for chart/controls */
            max-height: none; /* let card grow with content but internal area scrolls */
            box-sizing: border-box;
        }

        /* card header area remains visible */
        .card-header { z-index: 5; position: relative; }

        /* Internal scroll area inside a card */
        .card-content {
            flex: 1 1 auto;
            min-height: 0; /* allow flex children to shrink properly */
            overflow-y: auto;
            padding-top: 12px;
            padding-bottom: 6px;
            box-sizing: border-box;
            max-height: calc(100vh - 220px); /* sensible max height so internal scroll works */
        }

        /* explicit helper for sections that MUST be scrollable */
        .card-scroll {
            overflow-y: auto;
            max-height: 300px;
        }

        /* Chart wrapper: fixed visual height so chart canvas has a stable drawing area */
        .chart-wrapper {
            width: 100%;
            min-height: 220px;
            height: 260px;
            border-radius: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.12);
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Force canvas to fill chart-wrapper while respecting aspect */
        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        /* Product lists */
        .product-list-item { min-height: 64px; display:flex; gap:12px; align-items:flex-start; }
        .product-name-text { line-height: 1.25; word-wrap: break-word; }

        /* scrollbar styling (optional) */
        .card-content::-webkit-scrollbar { width: 8px; }
        .card-content::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.12); border-radius: 8px; }


        /* Scrollbar styling */
        .accordion-item.open .accordion-body::-webkit-scrollbar { width: 8px; }
        .accordion-item.open .accordion-body::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.3); border-radius: 8px; }
        .control-panel h3 {
            color: #f0f6fc;
            margin-bottom: 24px;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            letter-spacing: -0.02em;
        }

        .control-panel h3 i {
            margin-right: 12px;
            color: #58a6ff;
            font-size: 1.2em;
            filter: drop-shadow(0 2px 4px rgba(88, 166, 255, 0.3));
        }

        .analysis-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }

        .analysis-section:last-child {
            border-bottom: none;
        }

        .analysis-section h4 {
            color: #f0f6fc;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .analysis-section h4 i {
            margin-right: 8px;
            color: #58a6ff;
        }

        .analysis-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(88, 166, 255, 0.05);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            background: rgba(88, 166, 255, 0.1);
            border-color: #58a6ff;
        }

        .option-item.selected {
            background: rgba(88, 166, 255, 0.2);
            border-color: #58a6ff;
        }

        .option-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #58a6ff;
        }

        .option-item label {
            cursor: pointer;
            color: #f0f6fc;
            font-size: 0.9em;
            flex: 1;
        }

        .run-analysis-btn {
            width: 100%;
            background: linear-gradient(45deg, #58a6ff, #79c0ff);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .run-analysis-btn:hover {
            background: linear-gradient(45deg, #79c0ff, #58a6ff);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }

        .run-analysis-btn:disabled {
            background: #30363d;
            color: #8b949e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .dashboard-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 1400px; /* center results grid container */
            margin: 0 auto;
        }



        .dashboard-card .card-content { flex: 1 1 auto; }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #30363d;
        }

        .card-header h3 {
            color: #58a6ff;
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .card-header h3 i {
            margin-right: 10px;
        }

        .card-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .status-running {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
            border: 1px solid #58a6ff;
        }

        .status-completed {
            background: rgba(63, 185, 80, 0.2);
            color: #3fb950;
            border: 1px solid #3fb950;
        }

        .status-error {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid #f85149;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-item {
            text-align: center;
            padding: 12px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(88, 166, 255, 0.2);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
        }

        .kpi-value {
            font-size: 1.0em;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 5px;
            word-break: break-word;
            line-height: 1.0;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 8px;
            box-sizing: border-box;
            width: 100%;
        }

        /* Special handling for very large monetary values */
        .kpi-value[data-large="true"] {
            font-size: 0.9em;
            line-height: 1.0;
        }

        /* Ultra-compact styling for extremely large values */
        .kpi-value.ultra-compact {
            font-size: 0.8em;
            line-height: 0.9;
            padding: 0 4px;
        }

        /* Ensure KPI items have proper width constraints */
        .kpi-item {
            max-width: 100%;
            min-width: 0;
        }

        .kpi-label {
            font-size: 0.8em;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            word-break: break-word;
            line-height: 1.2;
        }


        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 140px;
            height: auto;
            color: #58a6ff;
        }

        .loading-spinner i {
            font-size: 2em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid #f85149;
            color: #f85149;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .success-message {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid #3fb950;
            color: #3fb950;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .insights-list li i {
            margin-right: 12px;
            color: #3fb950;
            font-size: 1.1em;
        }

        .insights-list li span {
            color: #f0f6fc;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #30363d;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #79c0ff);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .ml-model-card {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 2px solid #58a6ff;
        }

        .model-performance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .performance-metric {
            text-align: center;
            padding: 10px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(88, 166, 255, 0.2);
        }

        .performance-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #58a6ff;
        }

        .performance-label {
            font-size: 0.8em;
            color: #8b949e;
        }
        
        /* Theme colors update */
        body {
            background-color: #0f172a; /* dark background */
        }
        .control-panel {
            background: #1e293b; /* panel background */
            border: 1px solid #263445;
            border-radius: 12px;
            width: 720px; /* wider rectangular panel */
        }
        @media (min-width: 1440px) {
            .control-panel { width: 900px; }
        }
        .dashboard-card, .analysis-section {
            background: #111827;
            border: 1px solid #263445;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        }
        .control-panel h3, .analysis-section h4 {
            color: #e2e8f0; /* text */
        }
        .analysis-section h4 i {
            color: #3b82f6; /* accent */
        }
        .option-item:hover {
            background: rgba(59, 130, 246, 0.12);
            border-color: rgba(59, 130, 246, 0.35);
        }

        /* Accordion categories */
        .accordion {
            display: flex;
            flex-direction: column;
            gap: 12px; /* consistent spacing */
        }
        .accordion-item {
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(88, 166, 255, 0.15);
            box-shadow: 
                0 8px 24px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        
        .accordion-item:hover {
            border-color: rgba(88, 166, 255, 0.3);
            box-shadow: 
                0 12px 32px rgba(0,0,0,0.3),
                0 0 0 1px rgba(88, 166, 255, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            color: #f0f6fc;
            position: sticky;
            top: 0;
            z-index: 1;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(88, 166, 255, 0.1);
        }
        
        .accordion-header:hover {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #58a6ff;
        }
        .accordion-actions {
            display: flex;
            gap: 8px;
            margin-right: 6px;
        }
        .mini-btn {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(88, 166, 255, 0.05) 100%);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        }
        
        .mini-btn:hover {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2) 0%, rgba(88, 166, 255, 0.1) 100%);
            border-color: rgba(88, 166, 255, 0.5);
            color: #79c0ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
        }
        .accordion-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 1.1em;
            color: #f0f6fc;
        }
        
        .accordion-title span:first-child {
            font-size: 1.3em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-top: 1px solid rgba(88, 166, 255, 0.1);
        }
        .accordion-item.open .accordion-body {
            max-height: 640px; /* allow internal scroll */
            overflow-y: auto;
        }
        /* Scrollbar styling for bodies */
        .accordion-item.open .accordion-body::-webkit-scrollbar {
            width: 10px;
        }
        .accordion-item.open .accordion-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .accordion-item.open .accordion-body::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.35); /* secondary */
            border-radius: 8px;
        }

        /* Checkbox cards */
        .card-grid {
            display: grid; /* responsive grid */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px; /* neat spacing */
            padding: 12px 12px 14px;
            align-items: stretch;
            align-content: start;
        }
        .check-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 14px;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid rgba(88, 166, 255, 0.15);
            border-radius: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow, border-color;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }
        
        .check-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .check-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 16px 32px rgba(0,0,0,0.4),
                0 0 0 1px rgba(88, 166, 255, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.1);
            border-color: rgba(88, 166, 255, 0.5);
        }
        
        .check-card:hover::before {
            opacity: 1;
        }
        .check-card .icon {
            font-size: 20px;
            color: #58a6ff;
            filter: drop-shadow(0 2px 4px rgba(88, 166, 255, 0.3));
            transition: all 0.3s ease;
        }
        
        .check-card:hover .icon {
            color: #79c0ff;
            transform: scale(1.1);
        }
        
        .check-card .info .title {
            color: #f0f6fc;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 2px;
        }
        .check-card .info .desc {
            color: #8b949e;
            font-size: 12px;
            line-height: 1.4;
            margin-top: 4px;
        }
        .check-card .tick input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #58a6ff;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .check-card .tick input[type="checkbox"]:hover {
            transform: scale(1.1);
        }
        
        /* Selected chips */
        .selected-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(59, 130, 246, 0.15);
            color: #c9d1d9;
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 999px;
            font-size: 12px;
            line-height: 1;
        }
        .chip .remove {
            cursor: pointer;
            color: #79c0ff;
        }
        .chip .remove:hover {
            color: #79c0ff;
        }
        
        /* Hide legacy checkbox UI */
        .legacy-checkboxes {
            display: none;
        }

        /* Run button disabled state */
        .run-analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.2);
        }
        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }
        .btn-primary-gradient {
            background: linear-gradient(135deg, #58a6ff 0%, #3fb950 100%);
            border: none;
            color: #0d1117;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 24px rgba(88, 166, 255, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 32px rgba(88, 166, 255, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .btn-primary-gradient:hover::before {
            left: 100%;
        }
        
        .btn-primary-gradient:disabled {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-outline {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(88, 166, 255, 0.05) 100%);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .btn-outline:hover {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2) 0%, rgba(88, 166, 255, 0.1) 100%);
            border-color: rgba(88, 166, 255, 0.5);
            color: #79c0ff;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(88, 166, 255, 0.2);
        }
        @media (max-width: 1100px) {
            .control-panel { position: static; }
            .sticky-actions { position: sticky; bottom: 16px; background: #182330; padding-top: 8px; }
        }

        /* ----- Dashboard layout fixes ----- */

        /* Simple working layout */
        .dashboard-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .control-panel {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Dashboard area: allow shrinking and ensure grid has no intrinsic min-width overflow */
        .dashboard-area {
            min-width: 0;  /* important for flex/grid children so they can shrink properly */
        }

        /* Simple responsive grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Simple card styling */

        /* Card inner scroll area when content is long */
        .card-scroll {
            overflow-y: auto;
            max-height: calc(100vh - 260px); /* keeps internal scroll sensible */
            padding-right: 8px;
            box-sizing: border-box;
        }


        /* keep dropdowns, selects and cards above charts */
        .card-header, .card-status, .control-panel *, .dashboard-card * {
            z-index: 10;
            position: relative;
        }

        /* Avoid any accidental reparenting / portal-like overflow by ensuring popovers have high z-index */
        .popover,
        .dropdown-menu,
        .select-options {
            z-index: 6000 !important;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .dashboard-grid { 
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 15px;
            }
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid { 
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 0 5px;
            }
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
            }
            .kpi-item {
                padding: 10px;
                min-height: 70px;
            }
            .kpi-value {
                font-size: 0.9em;
            }
            .kpi-label {
                font-size: 0.7em;
            }
            .top-overview-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .product-list-item {
                min-height: 50px;
                padding: 8px 0;
            }
            .product-name-container {
                max-width: calc(100% - 100px);
            }
            .product-stats {
                min-width: 80px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .product-list-item {
                min-height: 45px;
                padding: 6px 0;
            }
            .product-name-text {
                font-size: 0.9em;
                line-height: 1.2;
            }
            .product-id-text {
                font-size: 0.8em;
            }
            .product-stats {
                min-width: 70px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .dashboard-grid { 
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 0;
            }
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .kpi-item {
                padding: 8px;
                min-height: 60px;
            }
            .kpi-value {
                font-size: 0.8em;
            }
            .kpi-label {
                font-size: 0.6em;
            }
        }

        /* Text overflow handling for product lists and long content */
        .product-list, .product-item {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-name {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        /* Ensure all text content is responsive */
        .card-content p, .card-content div {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* Fix for long product names in lists */
        .product-list-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 60px;
        }

        .product-list-item:last-child {
            border-bottom: none;
        }

        .product-name-container {
            flex: 1;
            min-width: 0;
            margin-right: 15px;
            max-width: calc(100% - 120px);
        }

        .product-stats {
            flex-shrink: 0;
            text-align: right;
            white-space: nowrap;
            min-width: 100px;
        }

        /* Enhanced product name styling for better text wrapping */
        .product-name-text {
            color: #f0f6fc;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
            display: block;
        }

        .product-id-text {
            color: #8b949e;
            font-size: 0.9em;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }


        /* Scrollbar styling for card content */
        .card-content::-webkit-scrollbar {
            width: 6px;
        }

        .card-content::-webkit-scrollbar-track {
            background: #0d1117;
            border-radius: 3px;
        }

        .card-content::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }

        .card-content::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-button" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
            Back to Data Preview
        </button>
        <h1><i class="fas fa-chart-line"></i> Advanced Business Analytics</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportAllResults()">
                <i class="fas fa-download"></i> Export All
            </button>
        </div>
    </div>

    <div class="main-content">
        <div id="topOverview" class="top-overview" aria-live="polite"></div>
        <!-- rolled back wrapper -->
            <div class="dashboard-layout">
            <!-- Control Panel -->
            <div class="control-panel">
            <h3><i class="fas fa-cogs"></i> Analysis Control Panel</h3>

            <!-- Accordion categories with checkbox cards -->
            <div class="accordion" id="analysis-accordion">
                <!-- Revenue Analysis -->
                <div class="accordion-item open" data-category="revenue">
                    <div class="accordion-header">
                        <div class="accordion-title"><span>üíµ</span><span>Revenue Analysis</span></div>
                        <div class="accordion-actions">
                            <button class="mini-btn" data-action="select-all">Select All</button>
                            <button class="mini-btn" data-action="clear">Clear</button>
                            <span>‚ñæ</span>
                        </div>
                    </div>
                    <div class="accordion-body">
                        <div class="card-grid">
                            <label class="check-card">
                                <div class="icon">üí∞</div>
                                <div class="info">
                                    <div class="title">Total Revenue Calculation</div>
                                    <div class="desc">Sum of all order amounts</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="total_revenue"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üßÆ</div>
                                <div class="info">
                                    <div class="title">Average Order Value (AOV)</div>
                                    <div class="desc">Revenue divided by number of orders</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="avg_order_value"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üìà</div>
                                <div class="info">
                                    <div class="title">Revenue Growth Rates (MoM, YoY)</div>
                                    <div class="desc">Month-over-month and year-over-year growth</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="revenue_growth"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üìâ</div>
                                <div class="info">
                                    <div class="title">Revenue Volatility Analysis</div>
                                    <div class="desc">Variability and stability over time</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="revenue_volatility"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Sales Insights -->
                <div class="accordion-item" data-category="sales">
                    <div class="accordion-header">
                        <div class="accordion-title"><span>üíπ</span><span>Sales Insights</span></div>
                        <div class="accordion-actions">
                            <button class="mini-btn" data-action="select-all">Select All</button>
                            <button class="mini-btn" data-action="clear">Clear</button>
                            <span>‚ñæ</span>
                        </div>
                    </div>
                    <div class="accordion-body">
                        <div class="card-grid">
                            <label class="check-card">
                                <div class="icon">üìä</div>
                                <div class="info">
                                    <div class="title">Daily/Weekly/Monthly Trends</div>
                                    <div class="desc">Time-series patterns across periods</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="revenue_trends"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üìÜ</div>
                                <div class="info">
                                    <div class="title">Seasonal Analysis</div>
                                    <div class="desc">Seasonality effects and cycles</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="seasonal_analysis"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">‚è∞</div>
                                <div class="info">
                                    <div class="title">Peak/Off-Peak Periods</div>
                                    <div class="desc">Identify high and low demand windows</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="peak_periods"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Customer Analytics -->
                <div class="accordion-item" data-category="customer">
                    <div class="accordion-header">
                        <div class="accordion-title"><span>üë•</span><span>Customer Analytics</span></div>
                        <div class="accordion-actions">
                            <button class="mini-btn" data-action="select-all">Select All</button>
                            <button class="mini-btn" data-action="clear">Clear</button>
                            <span>‚ñæ</span>
                        </div>
                    </div>
                    <div class="accordion-body">
                        <div class="card-grid">
                            <label class="check-card">
                                <div class="icon">üîñ</div>
                                <div class="info">
                                    <div class="title">RFM Analysis</div>
                                    <div class="desc">Recency, Frequency, Monetary segments</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="rfm_analysis"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üíé</div>
                                <div class="info">
                                    <div class="title">Customer Lifetime Value</div>
                                    <div class="desc">Projected value across lifecycle</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="customer_clv"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üó∫Ô∏è</div>
                                <div class="info">
                                    <div class="title">Geographic Customer Analysis</div>
                                    <div class="desc">Distribution and clusters by region</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="customer_geo"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">‚ö†Ô∏è</div>
                                <div class="info">
                                    <div class="title">Customer Churn Prediction</div>
                                    <div class="desc">At-risk customers and factors</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="customer_churn"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Product Performance -->
                <div class="accordion-item" data-category="product">
                    <div class="accordion-header">
                        <div class="accordion-title"><span>üì¶</span><span>Product Performance</span></div>
                        <div class="accordion-actions">
                            <button class="mini-btn" data-action="select-all">Select All</button>
                            <button class="mini-btn" data-action="clear">Clear</button>
                            <span>‚ñæ</span>
                        </div>
                    </div>
                    <div class="accordion-body">
                        <div class="card-grid">
                            <label class="check-card">
                                <div class="icon">üèÜ</div>
                                <div class="info">
                                    <div class="title">Top Products by Revenue</div>
                                    <div class="desc">Best performers by sales</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="top_products"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üóÇÔ∏è</div>
                                <div class="info">
                                    <div class="title">Category Analysis</div>
                                    <div class="desc">Breakdown by product categories</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="category_analysis"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">‚ûï</div>
                                <div class="info">
                                    <div class="title">Cross-selling Opportunities</div>
                                    <div class="desc">Frequently bought together items</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="cross_selling"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üß∫</div>
                                <div class="info">
                                    <div class="title">Market Basket Analysis</div>
                                    <div class="desc">Association rules and affinities</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="market_basket"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- EDA (Exploratory Data Analysis) -->
                <div class="accordion-item open" data-category="eda">
                    <div class="accordion-header">
                        <div class="accordion-title"><span>üîç</span><span>Exploratory Data Analysis (EDA)</span></div>
                        <div class="accordion-actions">
                            <button class="mini-btn" data-action="select-all">Select All</button>
                            <button class="mini-btn" data-action="clear">Clear</button>
                            <span>‚ñæ</span>
                        </div>
                    </div>
                    <div class="accordion-body">
                        <div class="card-grid">
                            <label class="check-card">
                                <div class="icon">üìä</div>
                                <div class="info">
                                    <div class="title">Data Overview</div>
                                    <div class="desc">Basic statistics and data summary</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="data_overview"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üìà</div>
                                <div class="info">
                                    <div class="title">Distribution Analysis</div>
                                    <div class="desc">Histograms and distribution plots</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="distribution_analysis"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üîó</div>
                                <div class="info">
                                    <div class="title">Correlation Matrix</div>
                                    <div class="desc">Feature relationships and correlations</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="correlation_matrix"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üìã</div>
                                <div class="info">
                                    <div class="title">Missing Data Analysis</div>
                                    <div class="desc">Identify and analyze missing values</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="missing_data_analysis"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üì¶</div>
                                <div class="info">
                                    <div class="title">Box Plots</div>
                                    <div class="desc">Outlier detection and quartile analysis</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="box_plots"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üéØ</div>
                                <div class="info">
                                    <div class="title">Scatter Plots</div>
                                    <div class="desc">Variable relationships and patterns</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="scatter_plots"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üìä</div>
                                <div class="info">
                                    <div class="title">Categorical Analysis</div>
                                    <div class="desc">Bar charts and frequency analysis</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="categorical_analysis"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">‚è∞</div>
                                <div class="info">
                                    <div class="title">Time Series Analysis</div>
                                    <div class="desc">Temporal patterns and trends</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="time_series_analysis"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Predictive Models -->
                <div class="accordion-item" data-category="ml">
                    <div class="accordion-header">
                        <div class="accordion-title"><span>üß†</span><span>Predictive Models</span></div>
                        <div class="accordion-actions">
                            <button class="mini-btn" data-action="select-all">Select All</button>
                            <button class="mini-btn" data-action="clear">Clear</button>
                            <span>‚ñæ</span>
                        </div>
                    </div>
                    <div class="accordion-body">
                        <div class="card-grid">
                            <label class="check-card">
                                <div class="icon">üìà</div>
                                <div class="info">
                                    <div class="title">Demand Forecasting</div>
                                    <div class="desc">Predict future sales demand</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="demand_forecasting"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üö™</div>
                                <div class="info">
                                    <div class="title">Churn Prediction</div>
                                    <div class="desc">Identify customers likely to leave</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="churn_prediction"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üß©</div>
                                <div class="info">
                                    <div class="title">Customer Segmentation</div>
                                    <div class="desc">Group customers by behavior</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="customer_segmentation"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">üîé</div>
                                <div class="info">
                                    <div class="title">Anomaly Detection</div>
                                    <div class="desc">Outliers in transactions or traffic</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="anomaly_detection"></div>
                            </label>
                            <label class="check-card">
                                <div class="icon">ü§ù</div>
                                <div class="info">
                                    <div class="title">Product Recommendation</div>
                                    <div class="desc">Suggest items users will like</div>
                                </div>
                                <div class="tick"><input type="checkbox" value="recommendation_system"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="selected-chips" class="selected-chips"></div>
            <div class="action-bar sticky-actions">
                <button class="btn-primary-gradient run-analysis-btn" onclick="runSelectedAnalysis()" disabled>
                    ‚ñ∂ Run Selected Analysis
                </button>
                <button class="btn-outline" id="reset-selection">Reset Selection</button>
            </div>
            
            <div class="legacy-checkboxes">
            <!-- Revenue Analysis -->
            <div class="analysis-section">
                <h4><i class="fas fa-dollar-sign"></i> Revenue Analysis</h4>
                <div class="analysis-options">
                    <div class="option-item">
                        <input type="checkbox" id="revenue-total" value="total_revenue">
                        <label for="revenue-total">Total Revenue Calculation</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="revenue-aov" value="avg_order_value">
                        <label for="revenue-aov">Average Order Value (AOV)</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="revenue-trends" value="revenue_trends">
                        <label for="revenue-trends">Daily/Weekly/Monthly Trends</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="revenue-growth" value="revenue_growth">
                        <label for="revenue-growth">Revenue Growth Rates (MoM, YoY)</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="revenue-volatility" value="revenue_volatility">
                        <label for="revenue-volatility">Revenue Volatility Analysis</label>
                    </div>
                </div>
            </div>

            <!-- Sales Trends -->
            <div class="analysis-section">
                <h4><i class="fas fa-trending-up"></i> Sales Trends</h4>
                <div class="analysis-options">
                    <div class="option-item">
                        <input type="checkbox" id="sales-daily" value="daily_patterns">
                        <label for="sales-daily">Daily Sales Patterns</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="sales-weekly" value="weekly_analysis">
                        <label for="sales-weekly">Weekly Performance Analysis</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="sales-seasonal" value="seasonal_analysis">
                        <label for="sales-seasonal">Seasonal Analysis</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="sales-peak" value="peak_periods">
                        <label for="sales-peak">Peak/Off-Peak Periods</label>
                    </div>
                </div>
            </div>

            <!-- Customer Segmentation -->
            <div class="analysis-section">
                <h4><i class="fas fa-users"></i> Customer Segmentation (RFM)</h4>
                <div class="analysis-options">
                    <div class="option-item">
                        <input type="checkbox" id="rfm-analysis" value="rfm_analysis">
                        <label for="rfm-analysis">RFM Analysis</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="customer-clv" value="customer_clv">
                        <label for="customer-clv">Customer Lifetime Value</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="customer-geo" value="customer_geo">
                        <label for="customer-geo">Geographic Customer Analysis</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="customer-churn" value="customer_churn">
                        <label for="customer-churn">Customer Churn Prediction</label>
                    </div>
                </div>
            </div>

            <!-- Product Performance -->
            <div class="analysis-section">
                <h4><i class="fas fa-box"></i> Product Performance</h4>
                <div class="analysis-options">
                    <div class="option-item">
                        <input type="checkbox" id="product-top" value="top_products">
                        <label for="product-top">Top Products by Revenue</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="product-category" value="category_analysis">
                        <label for="product-category">Category Analysis</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="product-cross" value="cross_selling">
                        <label for="product-cross">Cross-selling Opportunities</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="product-basket" value="market_basket">
                        <label for="product-basket">Market Basket Analysis</label>
                    </div>
                </div>
            </div>

            <!-- ML Models -->
            <div class="analysis-section">
                <h4><i class="fas fa-brain"></i> Machine Learning Models</h4>
                <div class="analysis-options">
                    <div class="option-item">
                        <input type="checkbox" id="ml-demand" value="demand_forecasting">
                        <label for="ml-demand">Demand Forecasting</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="ml-churn" value="churn_prediction">
                        <label for="ml-churn">Churn Prediction</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="ml-segmentation" value="customer_segmentation">
                        <label for="ml-segmentation">Customer Segmentation</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="ml-anomaly" value="anomaly_detection">
                        <label for="ml-anomaly">Anomaly Detection</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="ml-recommendation" value="recommendation_system">
                        <label for="ml-recommendation">Product Recommendation</label>
                    </div>
                </div>
            </div>

            <!-- Geographic Analysis -->
            <div class="analysis-section">
                <h4><i class="fas fa-globe"></i> Geographic Analysis</h4>
                <div class="analysis-options">
                    <div class="option-item">
                        <input type="checkbox" id="geo-revenue" value="revenue_by_country">
                        <label for="geo-revenue">Revenue by Country</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="geo-customer" value="customer_distribution">
                        <label for="geo-customer">Customer Distribution</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="geo-market" value="market_concentration">
                        <label for="geo-market">Market Concentration</label>
                    </div>
                </div>
            </div>
            </div>

            <button class="run-analysis-btn" onclick="runSelectedAnalysis()" disabled>
                <i class="fas fa-play"></i> Run Selected Analysis
            </button>
        </div>

            <!-- Dashboard Area -->
            <div class="dashboard-area">
                <div class="dashboard-grid" id="dashboardGrid">
                    <!-- Cards will be dynamically generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Minimal, scoped overrides to stabilize layout and avoid clipping
        // removed intrusive shell overrides and dropdown reparenter
        let selectedAnalyses = new Set();
        let analysisResults = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Advanced Business Analytics Dashboard...');
            initializeDashboard();
        });

        function initializeDashboard() {
            // Checkbox cards selection handling
            document.querySelectorAll('.check-card input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        selectedAnalyses.add(this.value);
                    } else {
                        selectedAnalyses.delete(this.value);
                    }
                    updateRunButton();
                    renderSelectedChips();
                    persistSelections();
                    updateOverviewCard();
                });
            });

            // Accordion toggle handling
            document.querySelectorAll('.accordion-item .accordion-header').forEach(header => {
                header.addEventListener('click', function() {
                    const item = this.parentElement;
                    item.classList.toggle('open');
                    persistAccordionStates();
                });
            });

            // Category select all / clear
            document.querySelectorAll('.accordion-item').forEach(item => {
                item.querySelectorAll('.accordion-actions .mini-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const action = this.getAttribute('data-action');
                        const checkboxes = item.querySelectorAll('.check-card input[type="checkbox"]');
                        if (action === 'select-all') {
                            checkboxes.forEach(cb => { cb.checked = true; selectedAnalyses.add(cb.value); });
                        } else if (action === 'clear') {
                            checkboxes.forEach(cb => { cb.checked = false; selectedAnalyses.delete(cb.value); });
                        }
                        updateRunButton();
                        renderSelectedChips();
                        persistSelections();
                        updateOverviewCard();
                    });
                });
            });

            // Reset selection
            const resetBtn = document.getElementById('reset-selection');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    // Uncheck all checkboxes
                    document.querySelectorAll('.check-card input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    selectedAnalyses.clear();
                    updateRunButton();
                    renderSelectedChips();
                    persistSelections();
                    updateOverviewCard();
                });
            }

            // Initialize with some default cards
            createDefaultCards();
            
            // Initialize overview card
            updateOverviewCard();
            renderSelectedChips();
            
            // Apply compact styling to any existing KPI values
            setTimeout(() => {
                applyCompactKpiStyling();
            }, 200);
            
            // Add page refresh cleanup
            window.addEventListener('beforeunload', function() {
                destroyAllCharts();
            });
            
            // Add error handling for Chart.js conflicts
            window.addEventListener('error', function(event) {
                if (event.message && event.message.includes('Canvas is already in use')) {
                    console.warn('üîÑ Chart.js conflict detected, cleaning up...');
                    destroyAllCharts();
                }
            });
            
            // Wait until Chart is available and DOM loaded
            // Note: whenChartReady is now defined globally

            // Simple chart cleanup helper (no aggressive overrides)
            function createSimpleChart(canvasId, config) {
                console.log('üéØ Creating chart for canvas:', canvasId);
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error('‚ùå Canvas not found:', canvasId);
                    return null;
                }
                
                console.log('üìè Canvas dimensions:', {
                    width: canvas.clientWidth,
                    height: canvas.clientHeight,
                    offsetWidth: canvas.offsetWidth,
                    offsetHeight: canvas.offsetHeight
                });
                
                // Ensure canvas has size ‚Äî if not, wait a tick
                if (canvas.clientHeight === 0) {
                    console.log('‚è≥ Canvas has no height, retrying in 50ms...');
                    setTimeout(() => createSimpleChart(canvasId, config), 50);
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                // Destroy old chart if any
                if (canvas._chartInstance) { 
                    console.log('üóëÔ∏è Destroying existing chart');
                    canvas._chartInstance.destroy(); 
                }
                
                console.log('üöÄ Creating new Chart instance');
                canvas._chartInstance = new Chart(ctx, config);
                console.log('‚úÖ Chart created successfully');
                return canvas._chartInstance;
            }

            // Restore persisted state
            restoreSelections();
            restoreAccordionStates();
        }

        function updateRunButton() {
            const runBtn = document.querySelector('.run-analysis-btn');
            if (selectedAnalyses.size > 0) {
                runBtn.disabled = false;
                runBtn.innerHTML = `<i class="fas fa-play"></i> Run ${selectedAnalyses.size} Selected Analysis`;
            } else {
                runBtn.disabled = true;
                runBtn.innerHTML = `<i class="fas fa-play"></i> Run Selected Analysis`;
            }
        }

        function renderSelectedChips() {
            const chipsContainer = document.getElementById('selected-chips');
            if (!chipsContainer) return;

            const labelsMap = new Map();
            document.querySelectorAll('.check-card').forEach(card => {
                const input = card.querySelector('input[type="checkbox"]');
                const titleEl = card.querySelector('.title');
                if (input && titleEl) labelsMap.set(input.value, titleEl.textContent.trim());
            });

            chipsContainer.innerHTML = '';
            Array.from(selectedAnalyses).forEach(value => {
                const chip = document.createElement('span');
                chip.className = 'chip';
                const label = labelsMap.get(value) || value;
                chip.innerHTML = `${label} <span class="remove" title="Remove">√ó</span>`;
                chip.querySelector('.remove').addEventListener('click', () => {
                    // Uncheck matching checkbox
                    document.querySelectorAll('.check-card input[type="checkbox"]').forEach(cb => {
                        if (cb.value === value) cb.checked = false;
                    });
                    selectedAnalyses.delete(value);
                    updateRunButton();
                    renderSelectedChips();
                    persistSelections();
                    updateOverviewCard();
                });
                chipsContainer.appendChild(chip);
            });
        }

        // Persistence helpers
        const STORAGE_KEYS = {
            selections: 'dw_selected_analyses',
            accordions: 'dw_open_accordions'
        };

        function persistSelections() {
            try {
                localStorage.setItem(STORAGE_KEYS.selections, JSON.stringify(Array.from(selectedAnalyses)));
            } catch (e) {}
        }

        function restoreSelections() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.selections);
                if (!raw) return;
                const values = JSON.parse(raw);
                if (Array.isArray(values)) {
                    // Apply to checkboxes
                    document.querySelectorAll('.check-card input[type="checkbox"]').forEach(cb => {
                        cb.checked = values.includes(cb.value);
                        if (cb.checked) selectedAnalyses.add(cb.value); else selectedAnalyses.delete(cb.value);
                    });
                    updateRunButton();
                    renderSelectedChips();
                    updateOverviewCard();
                }
            } catch (e) {}
        }

        function persistAccordionStates() {
            try {
                const openIds = Array.from(document.querySelectorAll('.accordion-item.open')).map(item => item.getAttribute('data-category'));
                localStorage.setItem(STORAGE_KEYS.accordions, JSON.stringify(openIds));
            } catch (e) {}
        }

        function restoreAccordionStates() {
            try {
                const raw = localStorage.getItem(STORAGE_KEYS.accordions);
                if (!raw) return;
                const openIds = JSON.parse(raw);
                if (Array.isArray(openIds)) {
                    document.querySelectorAll('.accordion-item').forEach(item => {
                        const id = item.getAttribute('data-category');
                        if (openIds.includes(id)) item.classList.add('open'); else item.classList.remove('open');
                    });
                }
            } catch (e) {}
        }

        function createDefaultCards() {
            // Render sticky top overview instead of placing cards in grid
            const top = document.getElementById('topOverview');
            if (top) {
                top.innerHTML = `
                    <div class="top-overview-grid">
                        <div class="dashboard-card" id="welcomeCard">
                            <div class="card-header">
                                <h3><i class="fas fa-info-circle"></i> Welcome to Advanced Analytics</h3>
                                <div class="card-status status-pending">Ready</div>
                            </div>
                            <p style="color: #8b949e; line-height: 1.6; margin: 0 16px 16px 16px;">
                                Select the analyses you want to run from the control panel below. 
                                Choose from Revenue Analysis, Sales Trends, Customer Segmentation, 
                                Product Performance, ML Models, and Geographic Analysis.
                            </p>
                            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px; margin: 0 16px 16px 16px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <i class="fas fa-clock" style="color: #ffc107; margin-right: 8px;"></i>
                                    <strong style="color: #ffc107; font-size: 14px;">Processing Time Notice</strong>
                                </div>
                                <p style="color: #8b949e; font-size: 13px; margin: 0; line-height: 1.4;">
                                    <strong>Some analyses may take time to generate</strong> - Complex ML models and large datasets 
                                    can require 30 seconds to 2 minutes to process. Please be patient during analysis generation.
                                </p>
                            </div>
                        </div>
                        <div class="dashboard-card" id="quickOverviewCard">
                            <div class="card-header">
                                <h3><i class="fas fa-tachometer-alt"></i> Quick Overview</h3>
                                <div class="card-status status-pending">Pending</div>
                            </div>
                            <div class="kpi-grid" id="topKpis">
                                <div class="kpi-item">
                                    <div class="kpi-value">0</div>
                                    <div class="kpi-label">Analyses Selected</div>
                                </div>
                                <div class="kpi-item">
                                    <div class="kpi-value">0</div>
                                    <div class="kpi-label">Results Generated</div>
                                </div>
                                <div class="kpi-item">
                                    <div class="kpi-value">0</div>
                                    <div class="kpi-label">ML Models Trained</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }

            // Clear dashboard grid starter content
            const dashboardGrid = document.getElementById('dashboardGrid');
            if (dashboardGrid) dashboardGrid.innerHTML = '';
        }

        async function runSelectedAnalysis() {
            console.log('üîç DEBUG: runSelectedAnalysis called');
            console.log('üöÄ Running selected analyses:', Array.from(selectedAnalyses));
            console.log('üîç DEBUG: selectedAnalyses size:', selectedAnalyses.size);
            
            // Show loading message
            const dashboardGrid = document.getElementById('dashboardGrid');
            if (!dashboardGrid) {
                console.log('‚ùå DEBUG: dashboardGrid not found!');
                return;
            }
            
            // Display loading message
            dashboardGrid.innerHTML = `
                <div class="dashboard-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #58a6ff;"></i>
                    </div>
                    <h3 style="color: #f0f6fc; margin-bottom: 16px;">Generating Advanced Analytics</h3>
                    <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 16px; margin: 0 auto; max-width: 500px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px; justify-content: center;">
                            <i class="fas fa-clock" style="color: #ffc107; margin-right: 8px;"></i>
                            <strong style="color: #ffc107;">Processing Time Notice</strong>
                        </div>
                        <p style="color: #8b949e; margin: 0; line-height: 1.5;">
                            <strong>Complex analyses are being generated...</strong><br>
                            ML models and large datasets may take 30 seconds to 2 minutes to process.<br>
                            Please be patient while we analyze your data.
                        </p>
                    </div>
                    <div style="margin-top: 20px; color: #8b949e; font-size: 14px;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        Do not close this window during processing
                    </div>
                </div>
            `;
            
            console.log('üîç DEBUG: Displayed loading message...');
            
            // Skip overview card for now - focus on analysis cards
            console.log('üîç DEBUG: Skipping overview card update...');
            
            // Create cards for selected analyses
            console.log('üîç DEBUG: Creating cards for analyses...');
            for (const analysis of selectedAnalyses) {
                console.log(`üîç DEBUG: Creating card for analysis: ${analysis}`);
                await createAnalysisCard(analysis);
                // Clear loading state after each card is created
                clearLoadingState();
            }
            console.log('üîç DEBUG: Finished creating all cards');
        }

        function clearLoadingState() {
            console.log('üîç DEBUG: Clearing loading state...');
            const dashboardGrid = document.getElementById('dashboardGrid');
            if (!dashboardGrid) return;
            
            // Find all analysis cards that were created
            const analysisCards = [];
            for (const analysis of selectedAnalyses) {
                const cardId = `card-${analysis}`;
                const card = document.getElementById(cardId);
                if (card) {
                    analysisCards.push(card);
                }
            }
            
            console.log(`üîç DEBUG: Found ${analysisCards.length} analysis cards`);
            
            // If we have cards, replace the loading message with them
            if (analysisCards.length > 0) {
                dashboardGrid.innerHTML = '';
                analysisCards.forEach(card => {
                    dashboardGrid.appendChild(card);
                });
                console.log(`üîç DEBUG: Loading state cleared, ${analysisCards.length} cards displayed`);
            } else {
                console.log('üîç DEBUG: No analysis cards found, keeping loading state');
            }
        }

        function updateOverviewCard() {
            // Update Quick Overview KPIs
            const quickOverview = document.getElementById('quickOverviewCard');
            if (!quickOverview) return;
            const kpiValues = quickOverview.querySelectorAll('.kpi-value');
            if (kpiValues && kpiValues.length >= 3) {
                kpiValues[0].textContent = selectedAnalyses.size;
                kpiValues[1].textContent = Object.keys(analysisResults).length;
                kpiValues[2].textContent = getMLModelCount();
                
                // Apply compact styling to large values
                applyCompactKpiStyling();
                
                // Update status based on results
                const statusElement = quickOverview.querySelector('.card-status');
                if (statusElement) {
                    if (Object.keys(analysisResults).length > 0) {
                        statusElement.textContent = 'Active';
                        statusElement.className = 'card-status status-completed';
                    } else if (selectedAnalyses.size > 0) {
                        statusElement.textContent = 'Running';
                        statusElement.className = 'card-status status-running';
                    } else {
                        statusElement.textContent = 'Pending';
                        statusElement.className = 'card-status status-pending';
                    }
                }
            }
            
            // Update export button state based on results
            updateExportButtonState();
        }

        function updateExportButtonState() {
            const exportBtn = document.querySelector('button[onclick="exportAllResults()"]');
            if (!exportBtn) return;
            
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            
            if (hasResults) {
                // Enable export button
                exportBtn.disabled = false;
                exportBtn.style.opacity = '1';
                exportBtn.style.cursor = 'pointer';
                exportBtn.title = `Export ${Object.keys(analysisResults || {}).length} analysis result(s)`;
            } else {
                // Disable export button
                exportBtn.disabled = true;
                exportBtn.style.opacity = '0.5';
                exportBtn.style.cursor = 'not-allowed';
                exportBtn.title = 'No analysis results available. Run analyses first.';
            }
        }

        function applyCompactKpiStyling() {
            // Apply compact styling to all KPI values across the dashboard
            const allKpiValues = document.querySelectorAll('.kpi-value');
            allKpiValues.forEach(element => {
                const text = element.textContent;
                // Check if the value is a large monetary amount (contains $ and large numbers)
                if (text.includes('$') && (text.includes('000') || text.length > 8)) {
                    element.classList.add('ultra-compact');
                    element.setAttribute('data-large', 'true');
                }
                // Check for very long text that might overflow
                if (text.length > 10) {
                    element.classList.add('ultra-compact');
                }
            });
        }

        function getMLModelCount() {
            const mlAnalyses = ['demand_forecasting', 'churn_prediction', 'customer_segmentation', 'anomaly_detection', 'recommendation_system'];
            return mlAnalyses.filter(analysis => selectedAnalyses.has(analysis)).length;
        }

        async function createAnalysisCard(analysisType) {
            console.log(`üîç DEBUG: createAnalysisCard called for: ${analysisType}`);
            
            const dashboardGrid = document.getElementById('dashboardGrid');
            if (!dashboardGrid) {
                console.log(`‚ùå DEBUG: dashboardGrid not found in createAnalysisCard`);
                return;
            }
            
            // Check if card already exists - but allow recreation if it's in loading state
            const existingCard = document.getElementById(`card-${analysisType}`);
            if (existingCard) {
                const cardContent = existingCard.querySelector('.card-content');
                const isStillLoading = cardContent && cardContent.textContent.includes('Loading');
                if (isStillLoading) {
                    console.log(`üîÑ Card for ${analysisType} exists but still loading, recreating...`);
                    existingCard.remove();
                } else {
                    console.log(`‚ö†Ô∏è Card for ${analysisType} already exists and has data, skipping`);
                    return;
                }
            }

            const cardId = `card-${analysisType}`;
            let cardHTML = '';
            
            console.log(`üîç DEBUG: Creating card with ID: ${cardId}`);

            console.log(`üîç DEBUG: Determining card HTML for analysis type: ${analysisType}`);
            switch (analysisType) {
                case 'total_revenue':
                    cardHTML = await createRevenueCard();
                    break;
                case 'avg_order_value':
                    cardHTML = await createAOVCard();
                    break;
                case 'revenue_trends':
                    cardHTML = await createTrendsCard();
                    break;
                case 'rfm_analysis':
                    cardHTML = await createRFMCard();
                    break;
                case 'top_products':
                    cardHTML = await createTopProductsCard();
                    break;
                case 'demand_forecasting':
                    cardHTML = await createMLModelCard('Demand Forecasting', 'Random Forest Regressor');
                    break;
                case 'churn_prediction':
                    cardHTML = await createMLModelCard('Churn Prediction', 'Random Forest Classifier');
                    break;
                case 'customer_segmentation':
                    cardHTML = await createMLModelCard('Customer Segmentation', 'K-Means Clustering');
                    break;
                case 'anomaly_detection':
                    cardHTML = await createMLModelCard('Anomaly Detection', 'Isolation Forest');
                    break;
                case 'recommendation_system':
                    cardHTML = await createMLModelCard('Product Recommendation', 'Collaborative Filtering');
                    break;
                case 'revenue_by_country':
                case 'customer_distribution':
                case 'market_concentration':
                case 'geographic_customer_analysis':
                    cardHTML = await createGeographicCard();
                    break;
                case 'cross_selling_opportunities':
                case 'category_analysis':
                    cardHTML = await createTopProductsCard();
                    break;
                case 'seasonal_analysis':
                case 'peak_off_peak':
                case 'weekly_performance':
                    cardHTML = await createTrendsCard();
                    break;
                case 'customer_lifetime_value':
                    cardHTML = await createRFMCard();
                    break;
                case 'market_basket_analysis':
                    cardHTML = await createMLModelCard('Market Basket Analysis', 'Association Rules');
                    break;
                default:
                    cardHTML = await createGenericCard(analysisType);
            }

            // Add card to dashboard
            console.log(`üîç DEBUG: Adding card to dashboard...`);
            const cardElement = document.createElement('div');
            cardElement.innerHTML = cardHTML;
            cardElement.id = cardId;
            
            // Get the actual card element before appending
            const actualCard = cardElement.firstElementChild;
            console.log(`üîç DEBUG: Got actual card element before append:`, actualCard);
            
            // Append the card to dashboard
            dashboardGrid.appendChild(actualCard);
            
            // Set the ID on the actual card element
            actualCard.id = cardId;

            console.log(`‚úÖ Created card for ${analysisType}`);
            console.log(`üîç DEBUG: Card added to DOM with ID: ${cardId}`);

            // Run actual analysis
            console.log(`üîç DEBUG: About to call runActualAnalysis for ${analysisType}...`);
            
            await runActualAnalysis(cardId, analysisType, actualCard);
            console.log(`üîç DEBUG: runActualAnalysis completed for ${analysisType}`);
        }

        async function createRevenueCard() {
            return `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-dollar-sign"></i> Revenue Analysis</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading revenue data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createAOVCard() {
            return `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-shopping-cart"></i> Average Order Value Analysis</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading AOV data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createTrendsCard() {
            return `
                <div class="dashboard-card full-width">
                    <div class="card-header">
                        <h3><i class="fas fa-trending-up"></i> Revenue Trends Analysis</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading trends data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createRFMCard() {
            return `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> Customer Segmentation (RFM)</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading RFM analysis...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createTopProductsCard() {
            return `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-box"></i> Top Performing Products</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading product data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createMLModelCard(modelName, algorithm) {
            return `
                <div class="dashboard-card ml-model-card">
                    <div class="card-header">
                        <h3><i class="fas fa-brain"></i> ${modelName}</h3>
                        <div class="card-status status-running">Training...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Training ${modelName} model...</p>
                            <p style="font-size: 0.9em; margin-top: 10px;"><strong>Algorithm:</strong> ${algorithm}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createGeographicCard() {
            return `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-globe"></i> Geographic Analysis</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading geographic data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createGenericCard(analysisType) {
            return `
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-calculator"></i> ${analysisType.replace(/_/g, ' ').toUpperCase()}</h3>
                        <div class="card-status status-running">Running...</div>
                    </div>
                    <div class="card-content">
                        <div style="padding: 20px; text-align: center; color: #8b949e;">
                            <div class="loading-spinner"></div>
                            <p>Loading ${analysisType.replace(/_/g, ' ')} data...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function runActualAnalysis(cardId, analysisType, cardElement = null) {
            console.log(`üîç DEBUG: runActualAnalysis called with cardId: ${cardId}, analysisType: ${analysisType}`);
            
            let card = cardElement;
            
            // If no card element passed, try to find it
            if (!card) {
                console.log(`üîç DEBUG: No card element passed, trying to find by ID: ${cardId}`);
                card = document.getElementById(cardId);
                if (!card) {
                    console.log(`‚ùå DEBUG: Card not found for cardId: ${cardId}, retrying...`);
                    // Wait a bit and try again
                    await new Promise(resolve => setTimeout(resolve, 200));
                    card = document.getElementById(cardId);
                    if (!card) {
                        console.log(`‚ùå DEBUG: Card still not found after retry for cardId: ${cardId}`);
                        return;
                    }
                }
            } else {
                console.log(`‚úÖ DEBUG: Using passed card element for cardId: ${cardId}`);
            }
            
            console.log(`‚úÖ DEBUG: Card found/using for cardId: ${cardId}`);

            const statusElement = card.querySelector('.card-status');
            const progressBar = card.querySelector('.progress-fill');
            
            console.log(`üîç DEBUG: Status element found: ${!!statusElement}, Progress bar found: ${!!progressBar}`);
            
            try {
                console.log(`üöÄ Starting analysis: ${analysisType}`);
                
                // Update status to running
                if (statusElement) {
                    statusElement.textContent = 'Running...';
                    statusElement.className = 'card-status status-running';
                    console.log(`üîç DEBUG: Updated status to Running...`);
                }

                // Show progress
                if (progressBar) {
                    progressBar.style.width = '30%';
                }
                
                // Show loading message in card content
                const cardContent = card.querySelector('.card-content');
                if (cardContent) {
                    cardContent.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="margin-bottom: 20px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #58a6ff;"></i>
                            </div>
                            <h3 style="color: #f0f6fc; margin-bottom: 12px;">Processing ${analysisType.replace('_', ' ').toUpperCase()}</h3>
                            <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px; margin: 0 auto; max-width: 400px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px; justify-content: center;">
                                    <i class="fas fa-clock" style="color: #ffc107; margin-right: 8px;"></i>
                                    <strong style="color: #ffc107; font-size: 14px;">Processing Time</strong>
                                </div>
                                <p style="color: #8b949e; margin: 0; font-size: 13px; line-height: 1.4;">
                                    ${analysisType.includes('ml') ? 'ML models may take 30-60 seconds' : 'Analysis may take 10-30 seconds'} to complete.<br>
                                    Please wait while we process your data...
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                console.log(`üîç DEBUG: Updated progress to 30%`);

                let result = {};
                let apiUrl = '';
                
                console.log(`üîç DEBUG: About to determine API endpoint for: ${analysisType}`);
                
                // Determine API endpoint
                switch (analysisType) {
                    case 'total_revenue':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/total';
                        break;
                    case 'avg_order_value':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/total';
                        break;
                    case 'revenue_trends':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'rfm_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/customer/rfm';
                        break;
                    case 'top_products':
                        apiUrl = 'http://localhost:5000/api/analytics/products/top';
                        break;
                    case 'revenue_by_country':
                        apiUrl = 'http://localhost:5000/api/analytics/geographic/analysis';
                        break;
                    case 'customer_distribution':
                        apiUrl = 'http://localhost:5000/api/analytics/geographic/analysis';
                        break;
                    case 'daily_patterns':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'demand_forecasting':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/demand-forecasting';
                        break;
                    case 'churn_prediction':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/churn-prediction';
                        break;
                    case 'customer_segmentation':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/customer-segmentation';
                        break;
                    case 'anomaly_detection':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/anomaly-detection';
                        break;
                    case 'recommendation_system':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/recommendation-system';
                        break;
                    case 'market_basket_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/recommendation-system';
                        break;
                    case 'cross_selling_opportunities':
                        apiUrl = 'http://localhost:5000/api/analytics/products/top';
                        break;
                    case 'market_concentration':
                        apiUrl = 'http://localhost:5000/api/analytics/geographic/analysis';
                        break;
                    case 'category_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/products/top';
                        break;
                    case 'seasonal_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'peak_off_peak':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'weekly_performance':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'revenue_growth':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'revenue_volatility':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'peak_periods':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'weekly_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/revenue/trends';
                        break;
                    case 'customer_clv':
                        apiUrl = 'http://localhost:5000/api/analytics/customer/rfm';
                        break;
                    case 'customer_geo':
                        apiUrl = 'http://localhost:5000/api/analytics/geographic/analysis';
                        break;
                    case 'customer_churn':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/churn-prediction';
                        method = 'POST';
                        break;
                    case 'customer_lifetime_value':
                        apiUrl = 'http://localhost:5000/api/analytics/customer/rfm';
                        break;
                    case 'geographic_customer_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/geographic/analysis';
                        break;
                    case 'market_basket':
                        apiUrl = 'http://localhost:5000/api/analytics/ml/recommendation-system';
                        method = 'POST';
                        break;
                    case 'cross_selling':
                        apiUrl = 'http://localhost:5000/api/analytics/products/cross-selling';
                        break;
                    // EDA Analysis Cases
                    case 'data_overview':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/data-overview';
                        break;
                    case 'distribution_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/distribution-analysis';
                        break;
                    case 'correlation_matrix':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/correlation-matrix';
                        break;
                    case 'missing_data_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/missing-data-analysis';
                        break;
                    case 'box_plots':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/box-plots';
                        break;
                    case 'scatter_plots':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/scatter-plots';
                        break;
                    case 'categorical_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/categorical-analysis';
                        break;
                    case 'time_series_analysis':
                        apiUrl = 'http://localhost:5000/api/analytics/eda/time-series-analysis';
                        break;
                    default:
                        console.log(`‚ö†Ô∏è Unknown analysis type: ${analysisType}`);
                        result = { status: 'completed', message: 'Analysis completed' };
                }

                console.log(`üîç DEBUG: API URL determined: ${apiUrl}`);
                
                if (apiUrl) {
                    console.log(`üì° Calling API: ${apiUrl}`);
                    console.log(`üîç DEBUG: Making ${analysisType.includes('ml') ? 'POST' : 'GET'} request to ${apiUrl}`);
                    
                    try {
                        console.log(`üîç DEBUG: About to make fetch request...`);
                        
                        // Show progress for long-running requests
                        if (analysisType.includes('ml') || analysisType === 'market_basket' || analysisType === 'top_products') {
                            console.log(`üîÑ Processing large dataset for ${analysisType} - this may take up to 2 minutes...`);
                        }
                        
                        // Add a small delay to prevent concurrent request issues
                        if (analysisType === 'top_products' || analysisType === 'cross_selling') {
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                        }
                        
                        const mlTypes = new Set(['demand_forecasting','churn_prediction','customer_segmentation','anomaly_detection','recommendation_system','market_basket','market_basket_analysis','customer_churn']);
                        const methodToUse = mlTypes.has(analysisType) ? 'POST' : 'GET';
                        const response = await fetch(apiUrl, {
                            method: methodToUse,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            mode: 'cors',
                            body: methodToUse === 'POST' ? JSON.stringify({}) : undefined
                        });
                        
                        console.log(`üîç DEBUG: Fetch response received: ${response.status} ${response.statusText}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        console.log(`üîç DEBUG: About to parse JSON response...`);
                        result = await response.json();
                        console.log(`‚úÖ API Response for ${analysisType}:`, result);
                    } catch (fetchError) {
                        console.error(`‚ùå Fetch error for ${analysisType}:`, fetchError);
                        console.log(`üîç DEBUG: Fetch error details:`, {
                            name: fetchError.name,
                            message: fetchError.message,
                            stack: fetchError.stack
                        });
                        
                        // Show error in card instead of throwing
                        const card = document.getElementById(cardId);
                        if (card) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'error-message';
                            errorDiv.style.cssText = 'color: #f85149; padding: 10px; background: rgba(248, 81, 73, 0.1); border-radius: 4px; margin: 10px 0;';
                            errorDiv.textContent = `Error: ${fetchError.message}`;
                            card.appendChild(errorDiv);
                        }
                        
                        // Set error status
                        if (statusElement) {
                            statusElement.textContent = 'Error';
                            statusElement.className = 'card-status status-error';
                        }
                        return; // Exit early on error
                    }
                } else {
                    console.log(`‚ö†Ô∏è DEBUG: No API URL found for analysis type: ${analysisType}`);
                }

                // Update progress
                if (progressBar) {
                    progressBar.style.width = '100%';
                }
                
                // Show processing message for large datasets
                if (statusElement) {
                    statusElement.textContent = 'Processing Full Dataset...';
                    statusElement.className = 'card-status status-running';
                }

                // Update card with real data
                updateCardWithResults(cardId, analysisType, result);
                
                // Complete analysis
                completeAnalysis(cardId, analysisType, result);
                
            } catch (error) {
                console.error(`‚ùå Error running ${analysisType}:`, error);
                
                // Handle specific error types
                let errorMessage = 'Analysis failed';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout - analysis took too long';
                } else if (error.message.includes('aborted')) {
                    errorMessage = 'Request was cancelled';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Backend server not responding';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                
                // Show error status
                if (statusElement) {
                    statusElement.textContent = 'Error';
                    statusElement.className = 'card-status status-error';
                }
                
                // Show error message in card
                const card = document.getElementById(cardId);
                if (card) {
                    const cardContent = card.querySelector('.card-content');
                    if (cardContent) {
                        cardContent.innerHTML = `
                            <div style="padding: 20px; text-align: center;">
                                <div style="color: #f85149; font-size: 2em; margin-bottom: 10px;">‚ùå</div>
                                <div style="color: #f85149; font-size: 1.2em; margin-bottom: 10px;">Analysis Failed</div>
                                <div style="color: #8b949e; font-size: 0.9em;">${errorMessage}</div>
                            </div>
                        `;
                    }
                }
            }
        }

        function updateCardWithResults(cardId, analysisType, result) {
            console.log(`üîç DEBUG: updateCardWithResults called with cardId: ${cardId}, analysisType: ${analysisType}`);
            const card = document.getElementById(cardId);
            console.log(`üîç DEBUG: Card found: ${!!card}`);
            
            if (!card || !result) {
                console.log('‚ùå Card not found or no result data');
                return;
            }

            console.log(`üîÑ Updating card ${cardId} with results for ${analysisType}:`, result);

            // Update based on analysis type
            switch (analysisType) {
                case 'total_revenue':
                case 'avg_order_value':
                    updateRevenueCard(card, result, analysisType);
                    break;
                case 'revenue_trends':
                case 'daily_patterns':
                    updateTrendsCard(card, result, analysisType);
                    break;
                case 'rfm_analysis':
                    updateRFMCard(card, result);
                    break;
                case 'top_products':
                case 'cross_selling_opportunities':
                case 'category_analysis':
                    updateTopProductsCard(card, result, analysisType);
                    break;
                case 'revenue_by_country':
                case 'customer_distribution':
                case 'market_concentration':
                case 'geographic_customer_analysis':
                case 'customer_geo':
                    updateGeographicCard(card, result, analysisType);
                    break;
                case 'revenue_trends':
                case 'daily_patterns':
                case 'seasonal_analysis':
                case 'peak_off_peak':
                case 'weekly_performance':
                case 'revenue_growth':
                case 'revenue_volatility':
                case 'peak_periods':
                case 'weekly_analysis':
                    updateTrendsCard(card, result, analysisType);
                    break;
                case 'rfm_analysis':
                case 'customer_lifetime_value':
                case 'customer_clv':
                    updateRFMCard(card, result, analysisType);
                    break;
                case 'demand_forecasting':
                case 'churn_prediction':
                case 'customer_segmentation':
                case 'anomaly_detection':
                case 'recommendation_system':
                case 'market_basket_analysis':
                case 'market_basket':
                case 'customer_churn':
                    updateMLModelCard(card, result);
                    break;
                case 'cross_selling':
                    updateTopProductsCard(card, result, analysisType);
                    break;
                // EDA Analysis Cases
                case 'data_overview':
                case 'distribution_analysis':
                case 'correlation_matrix':
                case 'missing_data_analysis':
                case 'box_plots':
                case 'scatter_plots':
                case 'categorical_analysis':
                case 'time_series_analysis':
                    updateEDACard(card, result, analysisType);
                    break;
                default:
                    console.log(`‚ö†Ô∏è Unknown analysis type for card update: ${analysisType}`);
                    // Try to update with generic content
                    updateGenericCard(card, result, analysisType);
            }
        }

        function updateGenericCard(card, result, analysisType) {
            console.log('üîß Generic card update for:', analysisType);
            console.log('üîß Result data:', result);
            
            // Find the card content area
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }
            
            // Create a generic display for any analysis type
            const title = analysisType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const content = `
                <div style="padding: 20px;">
                    <h3 style="color: #58a6ff; margin-bottom: 15px;">${title}</h3>
                    <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                        <div style="color: #3fb950; font-size: 2em; font-weight: 600; margin-bottom: 10px;">‚úÖ</div>
                        <div style="color: #8b949e; font-size: 1.2em;">Analysis Completed</div>
                    </div>
                    <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                        <h4 style="color: #58a6ff; margin-bottom: 10px;">Analysis Results</h4>
                        <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Status: ${result.status || 'Completed'}</p>
                        <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Analysis type: ${analysisType}</p>
                        <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Data points: ${Object.keys(result).length}</p>
                        <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Completed: ${new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;
            
            cardContent.innerHTML = content;
            console.log(`‚úÖ Generic card updated for ${analysisType}`);
        }

        function updateRevenueCard(card, result, analysisType) {
            console.log('üí∞ Revenue data:', result);
            console.log('üí∞ Analysis type:', analysisType);
            
            // Find the card content area
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }
            
            // Display different aspects based on analysis type
            let title = 'Revenue Analysis';
            let content = '';
            
            if (analysisType === 'total_revenue') {
                title = 'Total Revenue Analysis';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Total Revenue Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Revenue Metrics</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total Revenue: $${result.total_revenue ? result.total_revenue.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total Profit: $${result.total_profit ? result.total_profit.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Profit Margin: ${result.profit_margin ? result.profit_margin.toFixed(1) : 'N/A'}%</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Financial Health</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Revenue Growth: ${result.revenue_growth ? result.revenue_growth.toFixed(1) : 'N/A'}%</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Operating Margin: ${result.operating_margin ? result.operating_margin.toFixed(1) : 'N/A'}%</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Net Margin: ${result.net_margin ? result.net_margin.toFixed(1) : 'N/A'}%</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Performance Indicators</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Revenue per Transaction: $${result.avg_revenue_per_transaction ? result.avg_revenue_per_transaction.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total Transactions: ${result.total_transactions ? result.total_transactions.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Revenue Volatility: ${result.revenue_volatility ? result.revenue_volatility.toFixed(1) : 'N/A'}%</p>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Revenue Summary</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total Revenue: $${result.total_revenue ? result.total_revenue.toLocaleString() : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total Profit: $${result.total_profit ? result.total_profit.toLocaleString() : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Profit Margin: ${result.profit_margin ? result.profit_margin.toFixed(1) : 'N/A'}%</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'avg_order_value') {
                title = 'Average Order Value Analysis';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Average Order Value Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Order Metrics</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Average Order Value: $${result.average_order_value ? result.average_order_value.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total Orders: ${result.total_orders ? result.total_orders.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Order Frequency: ${result.order_frequency ? result.order_frequency.toFixed(1) : 'N/A'} per month</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Revenue Impact</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total Revenue: $${result.total_revenue ? result.total_revenue.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Revenue per Customer: $${result.revenue_per_customer ? result.revenue_per_customer.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Revenue Growth: ${result.revenue_growth ? result.revenue_growth.toFixed(1) : 'N/A'}%</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Performance Analysis</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Order Value Trend: ${result.order_value_trend ? result.order_value_trend : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ High Value Orders: ${result.high_value_orders ? result.high_value_orders.toLocaleString() : 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Order Value Volatility: ${result.order_value_volatility ? result.order_value_volatility.toFixed(1) : 'N/A'}%</p>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Order Value Summary</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Average Order Value: $${result.average_order_value ? result.average_order_value.toLocaleString() : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total Orders: ${result.total_orders ? result.total_orders.toLocaleString() : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total Revenue: $${result.total_revenue ? result.total_revenue.toLocaleString() : 'N/A'}</p>
                        </div>
                    </div>
                `;
            } else {
                // Default revenue analysis
                title = 'Revenue Analysis';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Revenue Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #58a6ff; font-size: 1.2em; font-weight: 600; margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word;">
                                    $${result.total_revenue ? result.total_revenue.toLocaleString() : 'N/A'}
                                </div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Revenue</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #3fb950; font-size: 1.2em; font-weight: 600; margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word;">
                                    $${result.total_profit ? result.total_profit.toLocaleString() : 'N/A'}
                                </div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Profit</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f85149; font-size: 1.2em; font-weight: 600; margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word;">
                                    ${result.profit_margin ? result.profit_margin.toFixed(1) : 'N/A'}%
                                </div>
                                <div style="color: #8b949e; font-size: 0.9em;">Profit Margin</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #58a6ff; font-size: 1.2em; font-weight: 600; margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word;">
                                    $${result.average_order_value ? result.average_order_value.toFixed(2) : 'N/A'}
                                </div>
                                <div style="color: #8b949e; font-size: 0.9em;">Avg Order Value</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Revenue Summary</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total transactions analyzed: ${result.total_transactions || 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Revenue per transaction: $${result.average_revenue ? result.average_revenue.toFixed(2) : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Analysis completed: ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                `;
            }
            
            if (!content) {
                content = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <p>No revenue data available</p>
                    </div>
                `;
            }
            
            cardContent.innerHTML = content;
            console.log(`‚úÖ ${title} card updated with data`);

            // Create visualization if data is available
        }

        function updateTrendsCard(card, result, analysisType) {
            console.log('üìà Trends data:', result);
            console.log('üìà Analysis type:', analysisType);
            
            // Find the card content area
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }
            
            // Display different aspects based on analysis type
            let title = 'Trends Analysis';
            let content = '';
            
            if (analysisType === 'revenue_trends') {
                title = 'Revenue Trends Analysis';
                // Extract data from backend response structure
                const dailyTrends = result.daily_trends || {};
                const weeklyTrends = result.weekly_trends || {};
                const monthlyTrends = result.monthly_trends || {};
                const volatility = result.volatility || {};
                
                // Calculate derived metrics
                const avgDailyRevenue = dailyTrends.revenue ? (dailyTrends.revenue.reduce((a, b) => a + b, 0) / dailyTrends.revenue.length) : 0;
                const avgWeeklyRevenue = weeklyTrends.revenue ? (weeklyTrends.revenue.reduce((a, b) => a + b, 0) / weeklyTrends.revenue.length) : 0;
                const dailyGrowth = dailyTrends.growth_rate || 0;
                const weeklyGrowth = weeklyTrends.growth_rate || 0;
                const monthlyGrowth = monthlyTrends.growth_rate || 0;
                const dailyVolatility = volatility.daily_std || 0;
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Revenue Trends Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Daily Patterns</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Daily growth rate: ${dailyGrowth.toFixed(1)}%</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Average daily revenue: $${avgDailyRevenue.toLocaleString()}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Daily volatility: $${dailyVolatility.toLocaleString()}</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Weekly Performance</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Weekly growth rate: ${weeklyGrowth.toFixed(1)}%</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Average weekly revenue: $${avgWeeklyRevenue.toLocaleString()}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total weeks: ${weeklyTrends.revenue ? weeklyTrends.revenue.length : 0}</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Monthly Trends</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Monthly growth rate: ${monthlyGrowth.toFixed(1)}%</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Total months: ${monthlyTrends.revenue ? monthlyTrends.revenue.length : 0}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Monthly volatility: $${volatility.monthly_std ? volatility.monthly_std.toLocaleString() : 'N/A'}</p>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Growth Analysis</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Daily growth: ${dailyGrowth.toFixed(1)}%</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Weekly growth: ${weeklyGrowth.toFixed(1)}%</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Monthly growth: ${monthlyGrowth.toFixed(1)}%</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'daily_patterns') {
                title = 'Daily Sales Patterns';
                // Extract data from backend response structure
                const dailyTrends = result.daily_trends || {};
                const volatility = result.volatility || {};
                
                // Calculate derived metrics
                const avgDailyRevenue = dailyTrends.revenue ? (dailyTrends.revenue.reduce((a, b) => a + b, 0) / dailyTrends.revenue.length) : 0;
                const totalDays = dailyTrends.revenue ? dailyTrends.revenue.length : 0;
                const maxRevenue = dailyTrends.revenue ? Math.max(...dailyTrends.revenue) : 0;
                const maxRevenueIndex = dailyTrends.revenue ? dailyTrends.revenue.indexOf(maxRevenue) : 0;
                const peakDay = dailyTrends.dates ? dailyTrends.dates[maxRevenueIndex] : 'N/A';
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Daily Sales Patterns</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #3fb950; font-size: 2em; font-weight: 600; margin-bottom: 10px;">
                                ${peakDay}
                            </div>
                            <div style="color: #8b949e;">Peak Sales Day</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">$${avgDailyRevenue.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Avg Daily Revenue</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">${totalDays}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Days</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">$${maxRevenue.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Peak Day Revenue</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'seasonal_analysis') {
                title = 'Seasonal Analysis';
                // Extract data from backend response structure
                const monthlyTrends = result.monthly_trends || {};
                const volatility = result.volatility || {};
                
                // Calculate seasonal metrics
                const monthlyRevenue = monthlyTrends.revenue || [];
                const monthlyLabels = monthlyTrends.months || [];
                const maxRevenue = monthlyRevenue.length > 0 ? Math.max(...monthlyRevenue) : 0;
                const minRevenue = monthlyRevenue.length > 0 ? Math.min(...monthlyRevenue) : 0;
                const maxIndex = monthlyRevenue.indexOf(maxRevenue);
                const minIndex = monthlyRevenue.indexOf(minRevenue);
                const peakMonth = monthlyLabels[maxIndex] || 'N/A';
                const lowMonth = monthlyLabels[minIndex] || 'N/A';
                const seasonalVariance = maxRevenue > 0 ? ((maxRevenue - minRevenue) / maxRevenue * 100) : 0;
                const monthlyStd = volatility.monthly_std || 0;
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Seasonal Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #58a6ff; font-size: 2em; font-weight: 600; margin-bottom: 10px;">
                                ${peakMonth}
                            </div>
                            <div style="color: #8b949e;">Peak Month</div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Seasonal Metrics</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Seasonal variance: ${seasonalVariance.toFixed(1)}%</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak month: ${peakMonth}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Low month: ${lowMonth}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Monthly volatility: $${monthlyStd.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'peak_off_peak') {
                title = 'Peak/Off-Peak Analysis';
                // Extract data from backend response structure
                const dailyTrends = result.daily_trends || {};
                const weeklyTrends = result.weekly_trends || {};
                const monthlyTrends = result.monthly_trends || {};
                
                // Calculate peak/off-peak periods
                const dailyRevenue = dailyTrends.revenue || [];
                const weeklyRevenue = weeklyTrends.revenue || [];
                const monthlyRevenue = monthlyTrends.revenue || [];
                
                // Find peak and off-peak periods
                const dailyMax = dailyRevenue.length > 0 ? Math.max(...dailyRevenue) : 0;
                const dailyMin = dailyRevenue.length > 0 ? Math.min(...dailyRevenue) : 0;
                const weeklyMax = weeklyRevenue.length > 0 ? Math.max(...weeklyRevenue) : 0;
                const weeklyMin = weeklyRevenue.length > 0 ? Math.min(...weeklyRevenue) : 0;
                const monthlyMax = monthlyRevenue.length > 0 ? Math.max(...monthlyRevenue) : 0;
                const monthlyMin = monthlyRevenue.length > 0 ? Math.min(...monthlyRevenue) : 0;
                
                // Determine peak and off-peak periods
                const peakPeriod = monthlyMax > weeklyMax ? 'Monthly' : weeklyMax > dailyMax ? 'Weekly' : 'Daily';
                const offPeakPeriod = monthlyMin < weeklyMin ? 'Monthly' : weeklyMin < dailyMin ? 'Weekly' : 'Daily';
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Peak/Off-Peak Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #3fb950; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #0d1117; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">Peak Period</div>
                                <div style="color: #0d1117; font-size: 1.2em;">${peakPeriod}</div>
                            </div>
                            <div style="background: #f85149; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">Off-Peak Period</div>
                                <div style="color: #f0f6fc; font-size: 1.2em;">${offPeakPeriod}</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Performance Metrics</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak daily revenue: $${dailyMax.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak weekly revenue: $${weeklyMax.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak monthly revenue: $${monthlyMax.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Off-peak daily revenue: $${dailyMin.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'weekly_performance') {
                title = 'Weekly Performance Analysis';
                // Extract data from backend response structure
                const weeklyTrends = result.weekly_trends || {};
                const dailyTrends = result.daily_trends || {};
                
                // Calculate weekly performance metrics
                const weeklyRevenue = weeklyTrends.revenue || [];
                const weeklyLabels = weeklyTrends.weeks || [];
                const dailyRevenue = dailyTrends.revenue || [];
                const dailyDates = dailyTrends.dates || [];
                
                const avgWeeklyRevenue = weeklyRevenue.length > 0 ? (weeklyRevenue.reduce((a, b) => a + b, 0) / weeklyRevenue.length) : 0;
                const maxWeeklyRevenue = weeklyRevenue.length > 0 ? Math.max(...weeklyRevenue) : 0;
                const maxWeeklyIndex = weeklyRevenue.indexOf(maxWeeklyRevenue);
                const bestWeek = weeklyLabels[maxWeeklyIndex] || 'N/A';
                
                // Find best performing day from daily data
                const maxDailyRevenue = dailyRevenue.length > 0 ? Math.max(...dailyRevenue) : 0;
                const maxDailyIndex = dailyRevenue.indexOf(maxDailyRevenue);
                const bestDay = dailyDates[maxDailyIndex] || 'N/A';
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Weekly Performance Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #3fb950; font-size: 2em; font-weight: 600; margin-bottom: 10px;">
                                ${bestWeek}
                            </div>
                            <div style="color: #8b949e;">Best Performing Week</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">$${avgWeeklyRevenue.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Avg Weekly Revenue</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">$${maxWeeklyRevenue.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Peak Weekly Revenue</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">${weeklyRevenue.length}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Weeks</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-top: 20px;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Performance Insights</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Best performing day: ${bestDay}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak daily revenue: $${maxDailyRevenue.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Weekly growth rate: ${weeklyTrends.growth_rate ? weeklyTrends.growth_rate.toFixed(1) : 'N/A'}%</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'revenue_growth') {
                title = 'Revenue Growth Analysis';
                // Extract growth data from backend response
                const dailyTrends = result.daily_trends || {};
                const weeklyTrends = result.weekly_trends || {};
                const monthlyTrends = result.monthly_trends || {};
                const volatility = result.volatility || {};
                
                const dailyGrowth = dailyTrends.growth_rate || 0;
                const weeklyGrowth = weeklyTrends.growth_rate || 0;
                const monthlyGrowth = monthlyTrends.growth_rate || 0;
                const avgVolatility = volatility.daily_std || 0;
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Revenue Growth Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #3fb950; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #0d1117; font-size: 2em; font-weight: 600; margin-bottom: 5px;">${monthlyGrowth.toFixed(1)}%</div>
                                <div style="color: #0d1117; font-size: 1.1em;">Monthly Growth</div>
                            </div>
                            <div style="background: #58a6ff; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 2em; font-weight: 600; margin-bottom: 5px;">${weeklyGrowth.toFixed(1)}%</div>
                                <div style="color: #f0f6fc; font-size: 1.1em;">Weekly Growth</div>
                            </div>
                            <div style="background: #f85149; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 2em; font-weight: 600; margin-bottom: 5px;">${dailyGrowth.toFixed(1)}%</div>
                                <div style="color: #f0f6fc; font-size: 1.1em;">Daily Growth</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Growth Metrics</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Daily volatility: $${avgVolatility.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Growth trend: ${monthlyGrowth > 0 ? 'Positive' : monthlyGrowth < 0 ? 'Negative' : 'Stable'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Analysis period: ${dailyTrends.revenue ? dailyTrends.revenue.length : 0} days</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'revenue_volatility') {
                title = 'Revenue Volatility Analysis';
                // Extract volatility data from backend response
                const volatility = result.volatility || {};
                const dailyTrends = result.daily_trends || {};
                
                const dailyStd = volatility.daily_std || 0;
                const weeklyStd = volatility.weekly_std || 0;
                const monthlyStd = volatility.monthly_std || 0;
                const avgDailyRevenue = dailyTrends.revenue ? (dailyTrends.revenue.reduce((a, b) => a + b, 0) / dailyTrends.revenue.length) : 0;
                const coefficientVariation = avgDailyRevenue > 0 ? (dailyStd / avgDailyRevenue * 100) : 0;
                
                // Determine volatility level
                let volatilityLevel = 'Low';
                if (coefficientVariation > 50) volatilityLevel = 'High';
                else if (coefficientVariation > 25) volatilityLevel = 'Medium';
                
                // Determine risk level
                let riskLevel = 'Low';
                if (coefficientVariation > 75) riskLevel = 'High';
                else if (coefficientVariation > 40) riskLevel = 'Medium';
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Revenue Volatility Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #f85149; font-size: 3em; font-weight: 600; margin-bottom: 10px;">${coefficientVariation.toFixed(1)}%</div>
                            <div style="color: #8b949e; font-size: 1.2em;">Coefficient of Variation</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${volatilityLevel}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Volatility Level</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #58a6ff; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${riskLevel}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Risk Level</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-top: 20px;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Volatility Insights</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Daily standard deviation: $${dailyStd.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Weekly standard deviation: $${weeklyStd.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Monthly standard deviation: $${monthlyStd.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Coefficient of variation: ${coefficientVariation.toFixed(2)}%</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'peak_periods') {
                title = 'Peak/Off-Peak Analysis';
                // Extract data from backend response structure
                const dailyTrends = result.daily_trends || {};
                const weeklyTrends = result.weekly_trends || {};
                const monthlyTrends = result.monthly_trends || {};
                
                // Calculate peak/off-peak periods
                const dailyRevenue = dailyTrends.revenue || [];
                const weeklyRevenue = weeklyTrends.revenue || [];
                const monthlyRevenue = monthlyTrends.revenue || [];
                
                // Find peak and off-peak periods
                const dailyMax = dailyRevenue.length > 0 ? Math.max(...dailyRevenue) : 0;
                const dailyMin = dailyRevenue.length > 0 ? Math.min(...dailyRevenue) : 0;
                const weeklyMax = weeklyRevenue.length > 0 ? Math.max(...weeklyRevenue) : 0;
                const weeklyMin = weeklyRevenue.length > 0 ? Math.min(...weeklyRevenue) : 0;
                const monthlyMax = monthlyRevenue.length > 0 ? Math.max(...monthlyRevenue) : 0;
                const monthlyMin = monthlyRevenue.length > 0 ? Math.min(...monthlyRevenue) : 0;
                
                // Determine peak and off-peak periods
                const peakPeriod = monthlyMax > weeklyMax ? 'Monthly' : weeklyMax > dailyMax ? 'Weekly' : 'Daily';
                const offPeakPeriod = monthlyMin < weeklyMin ? 'Monthly' : weeklyMin < dailyMin ? 'Weekly' : 'Daily';
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Peak/Off-Peak Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #3fb950; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #0d1117; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">Peak Period</div>
                                <div style="color: #0d1117; font-size: 1.2em;">${peakPeriod}</div>
                            </div>
                            <div style="background: #f85149; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">Off-Peak Period</div>
                                <div style="color: #f0f6fc; font-size: 1.2em;">${offPeakPeriod}</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Performance Metrics</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak daily revenue: $${dailyMax.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak weekly revenue: $${weeklyMax.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak monthly revenue: $${monthlyMax.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Off-peak daily revenue: $${dailyMin.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'weekly_analysis') {
                title = 'Weekly Performance Analysis';
                // Extract data from backend response structure
                const weeklyTrends = result.weekly_trends || {};
                const dailyTrends = result.daily_trends || {};
                
                // Calculate weekly performance metrics
                const weeklyRevenue = weeklyTrends.revenue || [];
                const weeklyLabels = weeklyTrends.weeks || [];
                const dailyRevenue = dailyTrends.revenue || [];
                const dailyDates = dailyTrends.dates || [];
                
                const avgWeeklyRevenue = weeklyRevenue.length > 0 ? (weeklyRevenue.reduce((a, b) => a + b, 0) / weeklyRevenue.length) : 0;
                const maxWeeklyRevenue = weeklyRevenue.length > 0 ? Math.max(...weeklyRevenue) : 0;
                const maxWeeklyIndex = weeklyRevenue.indexOf(maxWeeklyRevenue);
                const bestWeek = weeklyLabels[maxWeeklyIndex] || 'N/A';
                
                // Find best performing day from daily data
                const maxDailyRevenue = dailyRevenue.length > 0 ? Math.max(...dailyRevenue) : 0;
                const maxDailyIndex = dailyRevenue.indexOf(maxDailyRevenue);
                const bestDay = dailyDates[maxDailyIndex] || 'N/A';
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Weekly Performance Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #3fb950; font-size: 2em; font-weight: 600; margin-bottom: 10px;">
                                ${bestWeek}
                            </div>
                            <div style="color: #8b949e;">Best Performing Week</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">$${avgWeeklyRevenue.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Avg Weekly Revenue</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">$${maxWeeklyRevenue.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Peak Weekly Revenue</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">${weeklyRevenue.length}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Weeks</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-top: 20px;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Performance Insights</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Best performing day: ${bestDay}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Peak daily revenue: $${maxDailyRevenue.toLocaleString()}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Weekly growth rate: ${weeklyTrends.growth_rate ? weeklyTrends.growth_rate.toFixed(1) : 'N/A'}%</p>
                        </div>
                    </div>
                `;
            } else {
                // Default trends analysis
                title = 'Trends Analysis';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Trends Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Daily Patterns</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Peak day: ${result.peak_day || 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Average daily revenue: $${result.avg_daily_revenue ? result.avg_daily_revenue.toLocaleString() : 'N/A'}</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Weekly Performance</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Best performing day: ${result.best_day || 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Weekly revenue: $${result.weekly_revenue ? result.weekly_revenue.toLocaleString() : 'N/A'}</p>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #f0f6fc; margin-bottom: 10px;">Seasonal Analysis</h4>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Peak season: ${result.peak_season || 'N/A'}</p>
                                <p style="color: #8b949e; margin: 5px 0;">‚Ä¢ Seasonal variance: ${result.seasonal_variance ? result.seasonal_variance.toFixed(1) : 'N/A'}%</p>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Growth Analysis</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Month-over-month growth: ${result.mom_growth ? result.mom_growth.toFixed(1) : 'N/A'}%</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Year-over-year growth: ${result.yoy_growth ? result.yoy_growth.toFixed(1) : 'N/A'}%</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Revenue volatility: ${result.revenue_volatility ? result.revenue_volatility.toFixed(1) : 'N/A'}%</p>
                        </div>
                    </div>
                `;
            }
            
            if (!content) {
                content = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <p>No trends data available</p>
                    </div>
                `;
            }
            
            cardContent.innerHTML = content;
            console.log(`‚úÖ ${title} card updated with data`);

        }

        function updateRFMCard(card, result, analysisType) {
            console.log('üë• RFM data:', result);
            console.log('üë• Analysis type:', analysisType);
            
            // Find the card content area
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }
            
            // Display different aspects based on analysis type
            let title = 'Customer Analysis';
            let content = '';
            
            if (analysisType === 'rfm_analysis') {
                title = 'Customer Segmentation (RFM)';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Customer Segmentation (RFM Analysis)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #3fb950; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #0d1117; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Champions || '0' : '0'}
                                </div>
                                <div style="color: #0d1117; font-size: 0.9em;">Champions</div>
                            </div>
                            <div style="background: #58a6ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments['Loyal Customers'] || '0' : '0'}
                                </div>
                                <div style="color: #f0f6fc; font-size: 0.9em;">Loyal Customers</div>
                            </div>
                            <div style="background: #f85149; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments['At Risk'] || '0' : '0'}
                                </div>
                                <div style="color: #f0f6fc; font-size: 0.9em;">At Risk</div>
                            </div>
                            <div style="background: #8b949e; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Lost || '0' : '0'}
                                </div>
                                <div style="color: #f0f6fc; font-size: 0.9em;">Lost Customers</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Customer Insights</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total customers analyzed: ${result.rfm_analysis && result.rfm_analysis.total_customers ? result.rfm_analysis.total_customers.toLocaleString() : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Average customer lifetime value: $${result.rfm_analysis && result.rfm_analysis.average_clv ? result.rfm_analysis.average_clv.toFixed(2) : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Champions: ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Champions || '0' : '0'}</p>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'customer_lifetime_value') {
                title = 'Customer Lifetime Value Analysis';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Customer Lifetime Value Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #3fb950; font-size: 3em; font-weight: 600; margin-bottom: 10px;">$${result.avg_clv ? result.avg_clv.toLocaleString() : 'N/A'}</div>
                            <div style="color: #8b949e; font-size: 1.2em;">Average Customer Lifetime Value</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${result.total_customers || 'N/A'}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Customers</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #58a6ff; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${result.high_value_customers || 'N/A'}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">High-Value Customers</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #3fb950; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Champions || '0' : '0'}
                                </div>
                                <div style="color: #8b949e; font-size: 0.9em;">Champions</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (analysisType === 'customer_clv') {
                title = 'Customer Lifetime Value Analysis';
                // Extract data from backend response structure
                const rfmAnalysis = result.rfm_analysis || {};
                const avgClv = rfmAnalysis.average_clv || 0;
                const totalCustomers = rfmAnalysis.total_customers || 0;
                const segments = rfmAnalysis.segments || {};
                const champions = segments.Champions || 0;
                
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Customer Lifetime Value Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #3fb950; font-size: 3em; font-weight: 600; margin-bottom: 10px;">$${avgClv.toLocaleString()}</div>
                            <div style="color: #8b949e; font-size: 1.2em;">Average Customer Lifetime Value</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${totalCustomers.toLocaleString()}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Customers</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${champions}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Champions</div>
                            </div>
                            <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-weight: 600; font-size: 1.5em; margin-bottom: 5px;">${segments['Loyal Customers'] || 0}</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Loyal Customers</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-top: 20px;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">CLV Insights</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Average CLV: $${avgClv.toFixed(2)}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Champions: ${champions} customers</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total customers analyzed: ${totalCustomers.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } else {
                // Default customer analysis
                title = 'Customer Analysis';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Customer Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #3fb950; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #0d1117; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Champions || '0' : '0'}
                                </div>
                                <div style="color: #0d1117; font-size: 0.9em;">Champions</div>
                            </div>
                            <div style="background: #58a6ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments['Loyal Customers'] || '0' : '0'}
                                </div>
                                <div style="color: #f0f6fc; font-size: 0.9em;">Loyal Customers</div>
                            </div>
                            <div style="background: #f85149; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments['At Risk'] || '0' : '0'}
                                </div>
                                <div style="color: #f0f6fc; font-size: 0.9em;">At Risk</div>
                            </div>
                            <div style="background: #8b949e; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #f0f6fc; font-size: 1.5em; font-weight: 600; margin-bottom: 5px;">
                                    ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Lost || '0' : '0'}
                                </div>
                                <div style="color: #f0f6fc; font-size: 0.9em;">Lost Customers</div>
                            </div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <h4 style="color: #58a6ff; margin-bottom: 10px;">Customer Insights</h4>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total customers analyzed: ${result.rfm_analysis && result.rfm_analysis.total_customers ? result.rfm_analysis.total_customers.toLocaleString() : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Average customer lifetime value: $${result.rfm_analysis && result.rfm_analysis.average_clv ? result.rfm_analysis.average_clv.toFixed(2) : 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Champions: ${result.rfm_analysis && result.rfm_analysis.segments ? result.rfm_analysis.segments.Champions || '0' : '0'}</p>
                        </div>
                    </div>
                `;
            }
            
            if (!content) {
                content = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <p>No customer data available</p>
                    </div>
                `;
            }
            
            cardContent.innerHTML = content;
            console.log(`‚úÖ ${title} card updated with data`);

        }

        function updateTopProductsCard(card, result, analysisType) {
            console.log('üì¶ Top Products data:', result);
            console.log('üì¶ Analysis type:', analysisType);
            
            // Find the card content area
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }
            
            // Display different aspects based on analysis type
            let title = 'Product Analysis';
            let content = '';
            
            if (analysisType === 'top_products') {
                title = 'Top Performing Products';
                if (result.top_products && result.top_products.length > 0) {
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Top Performing Products</h3>
                            <div style="margin-bottom: 20px;">
                                ${result.top_products.slice(0, 5).map((product, index) => `
                                    <div class="product-list-item">
                                        <div style="display: flex; align-items: flex-start;">
                                            <div style="background: #58a6ff; color: #0d1117; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 12px; font-size: 0.8em; flex-shrink: 0;">
                                                ${index + 1}
                                            </div>
                                            <div class="product-name-container">
                                                <div class="product-name-text">${product.ProductName || 'Unknown Product'}</div>
                                                <div class="product-id-text">Product ID: ${(() => {
                                                    const idKeys = Object.keys(product).filter(key => 
                                                        key !== 'ProductName' && 
                                                        key !== 'Total_Revenue' && 
                                                        key !== 'Total_Quantity' && 
                                                        key !== 'Avg_Revenue' && 
                                                        key !== 'Transaction_Count' && 
                                                        key !== 'Avg_Price'
                                                    );
                                                    return idKeys.length > 0 ? product[idKeys[0]] : 'N/A';
                                                })()}</div>
                                            </div>
                                        </div>
                                        <div class="product-stats">
                                            <div style="color: #3fb950; font-weight: 600; font-size: 1.1em;">$${product.Total_Revenue ? product.Total_Revenue.toLocaleString() : '0'}</div>
                                            <div style="color: #8b949e; font-size: 0.9em;">${product.Total_Quantity || '0'} units</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${result.category_performance ? `
                            <h3 style="color: #58a6ff; margin: 10px 0 15px;">Category Performance</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${Object.entries(result.category_performance).slice(0, 6).map(([category, data]) => `
                                    <div style=\"background: #161b22; padding: 15px; border-radius: 8px; text-align: center;\">
                                        <div style=\"color: #f0f6fc; font-weight: 600; font-size: 1.2em; margin-bottom: 5px;\">${category}</div>
                                        <div style=\"color: #3fb950; font-weight: 600;\">$${(data?.revenue ?? 0).toLocaleString?.() || data?.revenue || 0}</div>
                                        <div style=\"color: #8b949e; font-size: 0.9em;\">${data?.products ?? 0} products</div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            } else if (analysisType === 'cross_selling' || analysisType === 'cross_selling_opportunities') {
                title = 'Cross-Selling Opportunities';
                const pairs = result.pairs || [];
                if (pairs.length > 0) {
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Top Co‚ÄëPurchased Pairs</h3>
                            <div style="margin-bottom: 10px; color: #8b949e;">Showing ${Math.min(10, pairs.length)} of ${pairs.length} pairs</div>
                            ${pairs.slice(0, 10).map((p, idx) => `
                                <div class="product-list-item">
                                    <div style="display:flex; align-items:flex-start; gap:10px;">
                                        <div style="background:#58a6ff; color:#0d1117; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.8em; flex-shrink: 0;">${idx+1}</div>
                                        <div class="product-name-container">
                                            <div class="product-name-text">${p.Product_A || '‚Äî'} ‚Üî ${p.Product_B || '‚Äî'}</div>
                                            <div class="product-id-text">Co‚Äëpurchases: ${p.CoPurchases || 0}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            
                        </div>
                    `;
                } else {
                    content = `<div style="padding:20px; color:#8b949e;">No cross‚Äëselling pairs found
                        <details style="margin-top:8px;"><summary style="color:#8b949e; cursor:pointer;">Debug</summary>
                        <pre style="white-space:pre-wrap; color:#8b949e; background:#0d1117; border:1px solid #30363d; padding:10px; border-radius:6px;">${(() => { try { return JSON.stringify(result, null, 2); } catch(e) { return 'N/A'; } })()}</pre>
                        </details>
                    </div>`;
                }
            } else if (analysisType === 'category_analysis') {
                title = 'Category Analysis';
                if (result) {
                    let entries = Object.entries(result.category_performance || {});
                    if (!entries.length && Array.isArray(result.top_products)) {
                        const derived = {};
                        result.top_products.forEach(p => {
                            const name = (p.ProductName || '').toString();
                            if (!name) return;
                            const cat = name.split(/\s+/)[0];
                            if (!derived[cat]) derived[cat] = { revenue: 0, products: 0 };
                            const rev = Number(p.Total_Revenue) || 0;
                            derived[cat].revenue += rev;
                            derived[cat].products += 1;
                        });
                        entries = Object.entries(derived).sort((a,b) => (b[1].revenue||0) - (a[1].revenue||0));
                    }
                    const hasData = entries.length > 0;
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Category Performance</h3>
                            ${hasData ? `
                                <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;\">
                                    ${entries.slice(0, 6).map(([category, data]) => `
                                        <div style=\"background: #161b22; padding: 15px; border-radius: 8px; text-align: center;\">
                                            <div style=\"color: #f0f6fc; font-weight: 600; font-size: 1.2em; margin-bottom: 5px;\">${category}</div>
                                            <div style=\"color: #3fb950; font-weight: 600;\">$${(data?.revenue ?? 0).toLocaleString?.() || data?.revenue || 0}</div>
                                            <div style=\"color: #8b949e; font-size: 0.9em;\">${data?.products ?? 0} products</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style=\"text-align:center; color:#8b949e; padding:20px;\">No category data available</div>
                            `}
                            <div style=\"margin-top:10px; color:#8b949e; font-size:0.9em;\">Categories ${hasData ? `(showing ${Math.min(6, entries.length)} of ${entries.length})` : '(none)'} | Data source: ${result.category_performance && Object.keys(result.category_performance).length ? 'backend' : 'derived from top products'}</div>
                        </div>
                    `;
                } else {
                    // Fallback to top products if no category data
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Category Analysis</h3>
                            <div style="text-align: center; color: #8b949e; padding: 20px;">
                                <p>Category analysis data not available</p>
                                <p style="font-size: 0.9em;">Showing top products instead</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Default product analysis
                title = 'Product Analysis';
                if (result.top_products && result.top_products.length > 0) {
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Product Overview</h3>
                            <div style="margin-bottom: 20px;">
                                ${result.top_products.slice(0, 5).map((product, index) => `
                                    <div class="product-list-item">
                                        <div style="display: flex; align-items: flex-start;">
                                            <div style="background: #58a6ff; color: #0d1117; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 12px; font-size: 0.8em; flex-shrink: 0;">
                                                ${index + 1}
                                            </div>
                                            <div class="product-name-container">
                                                <div class="product-name-text">${product.ProductName || 'Unknown Product'}</div>
                                                <div class="product-id-text">Product ID: ${(() => {
                                                    const idKeys = Object.keys(product).filter(key => 
                                                        key !== 'ProductName' && 
                                                        key !== 'Total_Revenue' && 
                                                        key !== 'Total_Quantity' && 
                                                        key !== 'Avg_Revenue' && 
                                                        key !== 'Transaction_Count' && 
                                                        key !== 'Avg_Price'
                                                    );
                                                    return idKeys.length > 0 ? product[idKeys[0]] : 'N/A';
                                                })()}</div>
                                            </div>
                                        </div>
                                        <div class="product-stats">
                                            <div style="color: #3fb950; font-weight: 600; font-size: 1.1em;">$${product.Total_Revenue ? product.Total_Revenue.toLocaleString() : '0'}</div>
                                            <div style="color: #8b949e; font-size: 0.9em;">${product.Total_Quantity || '0'} units</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!content) {
                content = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <p>No product data available</p>
                    </div>
                `;
            }
            
            cardContent.innerHTML = content;
            console.log(`‚úÖ ${title} card updated with data`);
        }

        function updateGeographicCard(card, result, analysisType) {
            console.log('üåç Geographic data:', result);
            console.log('üåç Analysis type:', analysisType);
            
            // Find the card content area
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }
            
            // Display different aspects based on analysis type
            let title = 'Geographic Analysis';
            let content = '';
            
            if (analysisType === 'revenue_by_country') {
                title = 'Revenue by Country';
                if (result.country_analysis && Array.isArray(result.country_analysis)) {
                    const topCountries = result.country_analysis.slice(0, 5);
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Top Countries by Revenue</h3>
                            <div>
                                ${topCountries.map((country, index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #30363d;">
                                        <div>
                                            <div style="font-weight: 600; color: #f0f6fc;">${index + 1}. ${country.Country}</div>
                                            <div style="font-size: 0.9em; color: #8b949e;">${country.Transaction_Count} transactions</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: #3fb950; font-weight: 600;">$${country.Total_Revenue.toLocaleString()}</div>
                                            <div style="font-size: 0.8em; color: #8b949e;">${country.Market_Share.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } else if (analysisType === 'customer_distribution') {
                title = 'Customer Distribution';
                if (result.customer_distribution) {
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Customer Distribution by Country</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${Object.entries(result.customer_distribution).slice(0, 6).map(([country, count]) => `
                                    <div style="background: #161b22; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="color: #f0f6fc; font-weight: 600; font-size: 1.2em;">${count.toLocaleString()}</div>
                                        <div style="color: #8b949e; font-size: 0.9em;">${country}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } else if (analysisType === 'market_concentration') {
                title = 'Market Concentration';
                content = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Market Concentration Analysis</h3>
                        <div style="background: #161b22; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <div style="color: #f85149; font-size: 2em; font-weight: 600; margin-bottom: 10px;">
                                ${result.market_concentration ? result.market_concentration.toFixed(1) : 'N/A'}%
                            </div>
                            <div style="color: #8b949e;">Market Concentration</div>
                        </div>
                        <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Total Countries: ${result.total_countries || 'N/A'}</p>
                            <p style="color: #f0f6fc; margin: 5px 0;">‚Ä¢ Top country dominance: ${result.country_analysis && result.country_analysis[0] ? result.country_analysis[0].Market_Share.toFixed(1) + '%' : 'N/A'}</p>
                        </div>
                    </div>
                `;
            } else {
                // Default geographic analysis
                title = 'Geographic Analysis';
                if (result.country_analysis && Array.isArray(result.country_analysis)) {
                    const topCountries = result.country_analysis.slice(0, 5);
                    content = `
                        <div style="padding: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Geographic Overview</h3>
                            <div>
                                ${topCountries.map((country, index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #30363d;">
                                        <div>
                                            <div style="font-weight: 600; color: #f0f6fc;">${index + 1}. ${country.Country}</div>
                                            <div style="font-size: 0.9em; color: #8b949e;">${country.Transaction_Count} transactions</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: #58a6ff; font-weight: 600;">$${country.Total_Revenue.toLocaleString()}</div>
                                            <div style="font-size: 0.8em; color: #8b949e;">${country.Market_Share.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: #161b22; border-radius: 6px;">
                                <div style="color: #f0f6fc; font-weight: 600;">Market Concentration: ${result.market_concentration ? result.market_concentration.toFixed(1) : 'N/A'}%</div>
                                <div style="color: #8b949e; font-size: 0.9em;">Total Countries: ${result.total_countries || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!content) {
                content = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <p>No geographic data available</p>
                    </div>
                `;
            }
            
            cardContent.innerHTML = content;
            console.log(`‚úÖ ${title} card updated with data`);
        }

        function updateEDACard(card, result, analysisType) {
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) return;
            
            console.log(`üîç Updating EDA card for ${analysisType}:`, result);
            
            let title = '';
            let content = '';
            
            switch(analysisType) {
                case 'data_overview':
                    title = 'Data Overview';
                    content = generateDataOverviewContent(result);
                    break;
                case 'distribution_analysis':
                    title = 'Distribution Analysis';
                    content = generateDistributionAnalysisContent(result);
                    break;
                case 'correlation_matrix':
                    title = 'Correlation Matrix';
                    content = generateCorrelationMatrixContent(result);
                    break;
                case 'missing_data_analysis':
                    title = 'Missing Data Analysis';
                    content = generateMissingDataContent(result);
                    break;
                case 'box_plots':
                    title = 'Box Plots Analysis';
                    content = generateBoxPlotsContent(result);
                    break;
                case 'scatter_plots':
                    title = 'Scatter Plots Analysis';
                    content = generateScatterPlotsContent(result);
                    break;
                case 'categorical_analysis':
                    title = 'Categorical Analysis';
                    content = generateCategoricalAnalysisContent(result);
                    break;
                case 'time_series_analysis':
                    title = 'Time Series Analysis';
                    content = generateTimeSeriesContent(result);
                    break;
                default:
                    title = 'EDA Analysis';
                    content = generateGenericEDAContent(result, analysisType);
            }
            
            cardContent.innerHTML = `
                <div style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
                    <h3 style="color: #58a6ff; margin-bottom: 15px; font-size: 18px; font-weight: 700;">${title}</h3>
                    <div class="card-scroll">
                        ${content}
                    </div>
                </div>
            `;
            
            // Create charts for EDA content
            setTimeout(() => {
                // Create box plots chart if available
                const boxChart = cardContent.querySelector('#boxPlotsChart');
                if (boxChart && result.data && result.data.chart_data) {
                    console.log('üìä Creating box plots chart');
                    whenChartReady(() => {
                        createBoxPlotsChart('boxPlotsChart', result.data.chart_data);
                    });
                }
                
                // Create scatter plots chart if available
                const scatterChart = cardContent.querySelector('#scatterPlotsChart');
                if (scatterChart && result.data && result.data.chart_data) {
                    console.log('üìä Creating scatter plots chart');
                    whenChartReady(() => {
                        createScatterPlotsChart('scatterPlotsChart', result.data.chart_data);
                    });
                }
                
                // Create categorical chart if available
                const categoricalChart = cardContent.querySelector('#categoricalChart');
                if (categoricalChart && result.data && result.data.chart_data) {
                    console.log('üìä Creating categorical chart');
                    whenChartReady(() => {
                        createCategoricalChart('categoricalChart', result.data.chart_data);
                    });
                }
            }, 200);
            
            console.log(`‚úÖ ${title} card updated with EDA data`);
        }

        // EDA Content Generation Functions
        function generateDataOverviewContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No data overview available</div>';
            }
            
            const data = result.data;
            const totalRows = data.total_rows || 0;
            const totalColumns = data.total_columns || 0;
            const memoryUsage = data.memory_usage || 'N/A';
            const numericColumns = data.numeric_columns || 0;
            const categoricalColumns = data.categorical_columns || 0;
            const dataTypes = data.data_types || {};
            const columnNames = data.column_names || [];
            
            return `
                <!-- Key Metrics -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(88, 166, 255, 0.15) 0%, rgba(88, 166, 255, 0.05) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(88, 166, 255, 0.3); text-align: center;">
                        <div style="color: #58a6ff; font-weight: bold; font-size: 28px; margin-bottom: 5px;">${totalRows.toLocaleString()}</div>
                        <div style="color: #8b949e; font-size: 14px; font-weight: 500;">Total Rows</div>
                        <div style="color: #6b7280; font-size: 12px; margin-top: 5px;">Data Points</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(88, 166, 255, 0.15) 0%, rgba(88, 166, 255, 0.05) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(88, 166, 255, 0.3); text-align: center;">
                        <div style="color: #58a6ff; font-weight: bold; font-size: 28px; margin-bottom: 5px;">${totalColumns}</div>
                        <div style="color: #8b949e; font-size: 14px; font-weight: 500;">Total Columns</div>
                        <div style="color: #6b7280; font-size: 12px; margin-top: 5px;">Features</div>
                    </div>
                </div>
                
                <!-- Memory and Column Types -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(63, 185, 80, 0.15) 0%, rgba(63, 185, 80, 0.05) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(63, 185, 80, 0.3); text-align: center;">
                        <div style="color: #3fb950; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${memoryUsage}</div>
                        <div style="color: #8b949e; font-size: 14px; font-weight: 500;">Memory Usage</div>
                        <div style="color: #6b7280; font-size: 12px; margin-top: 5px;">Dataset Size</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.05) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.3); text-align: center;">
                        <div style="color: #ffc107; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${numericColumns + categoricalColumns}</div>
                        <div style="color: #8b949e; font-size: 14px; font-weight: 500;">Column Types</div>
                        <div style="color: #6b7280; font-size: 12px; margin-top: 5px;">${numericColumns} Numeric, ${categoricalColumns} Categorical</div>
                    </div>
                </div>
                
                <!-- Data Types Breakdown -->
                <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Data Types Distribution</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                        ${Object.entries(dataTypes).map(([type, count]) => {
                            const percentage = totalColumns > 0 ? ((count / totalColumns) * 100).toFixed(1) : 0;
                            return `
                                <div style="background: rgba(88, 166, 255, 0.08); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; font-size: 18px; margin-bottom: 5px;">${count}</div>
                                    <div style="color: #8b949e; font-size: 12px; font-weight: 500; margin-bottom: 3px;">${type}</div>
                                    <div style="color: #6b7280; font-size: 11px;">${percentage}%</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Column Names Preview -->
                <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Column Names Preview</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto;">
                        ${columnNames.map((name, index) => `
                            <span style="background: rgba(88, 166, 255, 0.1); color: #58a6ff; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid rgba(88, 166, 255, 0.2);">
                                ${name}
                            </span>
                        `).join('')}
                        ${columnNames.length > 20 ? `
                            <span style="background: rgba(139, 148, 158, 0.1); color: #8b949e; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; border: 1px solid rgba(139, 148, 158, 0.2);">
                                +${totalColumns - 20} more...
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function generateDistributionAnalysisContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No distribution analysis available</div>';
            }
            
            const data = result.data;
            const distributions = data.distributions || {};
            const totalNumericColumns = data.total_numeric_columns || 0;
            
            return `
                <!-- Summary Stats -->
                <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Distribution Analysis Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 20px;">${Object.keys(distributions).length}</div>
                            <div style="color: #8b949e; font-size: 12px;">Columns Analyzed</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 20px;">${totalNumericColumns}</div>
                            <div style="color: #8b949e; font-size: 12px;">Total Numeric Columns</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 20px;">${Object.keys(distributions).length > 0 ? Math.round(Object.values(distributions).reduce((sum, stats) => sum + (stats.count || 0), 0) / Object.keys(distributions).length) : 0}</div>
                            <div style="color: #8b949e; font-size: 12px;">Avg Data Points</div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Distributions -->
                <div style="max-height: 300px; overflow-y: auto;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Column Distribution Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        ${Object.entries(distributions).map(([column, stats]) => {
                            const mean = stats.mean || 0;
                            const std = stats.std || 0;
                            const skewness = stats.skewness || 0;
                            const kurtosis = stats.kurtosis || 0;
                            const min = stats.min || 0;
                            const max = stats.max || 0;
                            const count = stats.count || 0;
                            
                            // Determine distribution shape
                            let shape = 'Normal';
                            let shapeColor = '#3fb950';
                            if (Math.abs(skewness) > 1) {
                                shape = skewness > 0 ? 'Right Skewed' : 'Left Skewed';
                                shapeColor = '#ffc107';
                            } else if (Math.abs(skewness) > 0.5) {
                                shape = skewness > 0 ? 'Slightly Right' : 'Slightly Left';
                                shapeColor = '#58a6ff';
                            }
                            
                            return `
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 18px; border-radius: 10px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">${column}</div>
                                    
                                    <!-- Key Statistics -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #8b949e; font-size: 11px;">Mean:</span>
                                            <span style="color: #f0f6fc; font-weight: bold; font-size: 12px;">${mean.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #8b949e; font-size: 11px;">Std Dev:</span>
                                            <span style="color: #f0f6fc; font-weight: bold; font-size: 12px;">${std.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #8b949e; font-size: 11px;">Min:</span>
                                            <span style="color: #3fb950; font-weight: bold; font-size: 12px;">${min.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #8b949e; font-size: 11px;">Max:</span>
                                            <span style="color: #f85149; font-weight: bold; font-size: 12px;">${max.toFixed(2)}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Distribution Shape -->
                                    <div style="border-top: 1px solid rgba(88, 166, 255, 0.1); padding-top: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: #8b949e; font-size: 11px;">Shape:</span>
                                            <span style="color: ${shapeColor}; font-weight: bold; font-size: 12px;">${shape}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: #8b949e; font-size: 11px;">Skewness:</span>
                                            <span style="color: ${Math.abs(skewness) > 1 ? '#ffc107' : '#58a6ff'}; font-weight: bold; font-size: 12px;">${skewness.toFixed(3)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #8b949e; font-size: 11px;">Count:</span>
                                            <span style="color: #58a6ff; font-weight: bold; font-size: 12px;">${count.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function generateCorrelationMatrixContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No correlation matrix available</div>';
            }
            
            const data = result.data;
            const correlationMatrix = data.correlation_matrix || {};
            const strongCorrelations = data.strong_correlations || [];
            const totalColumns = data.total_columns || 0;
            
            if (Object.keys(correlationMatrix).length === 0) {
                return `
                    <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; text-align: center;">
                        <div style="color: #8b949e; font-size: 48px; margin-bottom: 15px;">üîó</div>
                        <div style="color: #f0f6fc; font-size: 16px; margin-bottom: 5px;">No Correlation Data Available</div>
                        <div style="color: #6b7280; font-size: 14px;">Not enough numeric columns for correlation analysis</div>
                    </div>
                `;
            }
            
            return `
                <!-- Summary Statistics -->
                <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Correlation Analysis Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 20px;">${totalColumns}</div>
                            <div style="color: #8b949e; font-size: 12px;">Variables Analyzed</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 20px;">${strongCorrelations.length}</div>
                            <div style="color: #8b949e; font-size: 12px;">Strong Correlations</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 20px;">${Math.round((totalColumns * (totalColumns - 1)) / 2)}</div>
                            <div style="color: #8b949e; font-size: 12px;">Total Pairs</div>
                        </div>
                    </div>
                </div>
                
                <!-- Strong Correlations -->
                ${strongCorrelations.length > 0 ? `
                    <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                        <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Strong Correlations (|r| > 0.7)</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                            ${strongCorrelations.map(corr => {
                                const strength = corr.strength || 'moderate';
                                const strengthColor = strength === 'strong' ? '#3fb950' : '#58a6ff';
                                const corrValue = corr.correlation || 0;
                                const corrColor = corrValue > 0 ? '#3fb950' : '#f85149';
                                
                                return `
                                    <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                        <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">${corr.pair}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <span style="color: #8b949e; font-size: 12px;">Correlation:</span>
                                            <span style="color: ${corrColor}; font-weight: bold; font-size: 14px;">${corrValue.toFixed(3)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #8b949e; font-size: 12px;">Strength:</span>
                                            <span style="color: ${strengthColor}; font-weight: bold; font-size: 12px; text-transform: uppercase;">${strength}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Interactive Correlation Heatmap -->
                <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Interactive Correlation Heatmap</h4>
                    <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; min-width: 600px;">
                            <thead>
                                <tr>
                                    <th style="padding: 12px 8px; background: #1e293b; color: #f0f6fc; border: 1px solid #30363d; font-weight: 600; position: sticky; top: 0; z-index: 10;"></th>
                                    ${Object.keys(correlationMatrix).map(col => `
                                        <th style="padding: 12px 8px; background: #1e293b; color: #f0f6fc; border: 1px solid #30363d; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10; min-width: 100px;">${col.length > 15 ? col.substring(0, 15) + '...' : col}</th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(correlationMatrix).map(([row, correlations]) => `
                                    <tr>
                                        <td style="padding: 12px 8px; background: #1e293b; color: #f0f6fc; border: 1px solid #30363d; font-weight: 600; position: sticky; left: 0; z-index: 5; min-width: 120px;">${row.length > 15 ? row.substring(0, 15) + '...' : row}</td>
                                        ${Object.entries(correlations).map(([col, value]) => {
                                            const absValue = Math.abs(value);
                                            let bgColor = '';
                                            let textColor = '#f0f6fc';
                                            let borderColor = '#30363d';
                                            
                                            if (absValue >= 0.7) {
                                                bgColor = value > 0 ? 'rgba(63, 185, 80, 0.8)' : 'rgba(248, 81, 73, 0.8)';
                                                textColor = '#ffffff';
                                                borderColor = value > 0 ? '#3fb950' : '#f85149';
                                            } else if (absValue >= 0.3) {
                                                bgColor = value > 0 ? 'rgba(88, 166, 255, 0.8)' : 'rgba(255, 193, 7, 0.8)';
                                                textColor = '#ffffff';
                                                borderColor = value > 0 ? '#58a6ff' : '#ffc107';
                                            } else {
                                                bgColor = 'rgba(139, 148, 158, 0.3)';
                                                textColor = '#8b949e';
                                                borderColor = '#30363d';
                                            }
                                            
                                            return `
                                                <td style="
                                                    padding: 12px 8px; 
                                                    background: ${bgColor}; 
                                                    color: ${textColor}; 
                                                    border: 1px solid ${borderColor}; 
                                                    text-align: center; 
                                                    font-weight: bold; 
                                                    font-size: 13px;
                                                    cursor: pointer;
                                                    transition: all 0.2s ease;
                                                " 
                                                onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(88, 166, 255, 0.3)'"
                                                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
                                                onclick="showCorrelationDetails('${row}', '${col}', ${value})"
                                                title="Click for details: ${row} vs ${col} = ${value.toFixed(3)}">
                                                    ${value.toFixed(2)}
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <div style="display: inline-flex; align-items: center; gap: 15px; background: rgba(88, 166, 255, 0.05); padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2); flex-wrap: wrap; justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 12px; height: 12px; background: #f85149; border-radius: 2px;"></div>
                                <span style="color: #8b949e; font-size: 12px;">Strong Negative (-1.0 to -0.7)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 12px; height: 12px; background: #ffc107; border-radius: 2px;"></div>
                                <span style="color: #8b949e; font-size: 12px;">Moderate (-0.7 to -0.3)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 12px; height: 12px; background: #8b949e; border-radius: 2px;"></div>
                                <span style="color: #8b949e; font-size: 12px;">Weak (-0.3 to 0.3)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 12px; height: 12px; background: #58a6ff; border-radius: 2px;"></div>
                                <span style="color: #8b949e; font-size: 12px;">Moderate (0.3 to 0.7)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 12px; height: 12px; background: #3fb950; border-radius: 2px;"></div>
                                <span style="color: #8b949e; font-size: 12px;">Strong Positive (0.7 to 1.0)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="correlationHeatmapContainer" data-matrix='${JSON.stringify(correlationMatrix)}'></div>
            `;
        }
        
        // Function to show correlation details in a modal
        function showCorrelationDetails(row, col, value) {
            const absValue = Math.abs(value);
            let strength = 'Weak';
            let strengthColor = '#8b949e';
            
            if (absValue >= 0.7) {
                strength = 'Strong';
                strengthColor = '#3fb950';
            } else if (absValue >= 0.3) {
                strength = 'Moderate';
                strengthColor = '#58a6ff';
            }
            
            const relationship = value > 0 ? 'Positive' : value < 0 ? 'Negative' : 'None';
            const relationshipColor = value > 0 ? '#3fb950' : value < 0 ? '#f85149' : '#8b949e';
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #0d1117;
                    border: 1px solid #30363d;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                ">
                    <h3 style="color: #f0f6fc; margin-bottom: 20px; font-size: 20px; text-align: center;">Correlation Details</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #8b949e;">Variables:</span>
                            <span style="color: #58a6ff; font-weight: bold;">${row} vs ${col}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #8b949e;">Correlation:</span>
                            <span style="color: #f0f6fc; font-weight: bold; font-size: 18px;">${value.toFixed(3)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #8b949e;">Strength:</span>
                            <span style="color: ${strengthColor}; font-weight: bold; text-transform: uppercase;">${strength}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #8b949e;">Relationship:</span>
                            <span style="color: ${relationshipColor}; font-weight: bold;">${relationship}</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="this.closest('.modal').remove()" style="
                            background: linear-gradient(135deg, #58a6ff 0%, #3fb950 100%);
                            border: none;
                            color: #0d1117;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function generateMissingDataContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No missing data analysis available</div>';
            }
            
            const data = result.data;
            const missingData = data.missing_data || {};
            const totalRows = data.total_rows || 0;
            const columnsWithMissing = data.columns_with_missing || 0;
            const totalMissing = data.total_missing_values || 0;
            const overallPercentage = data.overall_missing_percentage || 0;
            
            // Sort columns by missing percentage
            const sortedColumns = Object.entries(missingData).sort((a, b) => b[1].missing_percentage - a[1].missing_percentage);
            
            return `
                <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px;">Missing Data Summary</h4>
                    
                    <!-- Overall Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 18px;">${totalRows.toLocaleString()}</div>
                            <div style="color: #8b949e; font-size: 12px;">Total Rows</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 18px;">${columnsWithMissing}</div>
                            <div style="color: #8b949e; font-size: 12px;">Columns with Missing</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 18px;">${totalMissing.toLocaleString()}</div>
                            <div style="color: #8b949e; font-size: 12px;">Total Missing</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 18px;">${overallPercentage.toFixed(2)}%</div>
                            <div style="color: #8b949e; font-size: 12px;">Overall Missing</div>
                        </div>
                    </div>
                    
                    <!-- Column Details -->
                    <div style="max-height: 300px; overflow-y: auto;">
                        <h5 style="color: #f0f6fc; margin-bottom: 10px;">Column Details</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            ${sortedColumns.map(([column, info]) => {
                                const missingCount = info.missing_count || 0;
                                const missingPercentage = info.missing_percentage || 0;
                                const dataType = info.data_type || 'unknown';
                                const nonMissing = info.non_missing_count || 0;
                                
                                // Color coding based on missing percentage
                                let colorClass = '';
                                if (missingPercentage > 50) colorClass = 'rgba(248, 81, 73, 0.1)'; // Red for high missing
                                else if (missingPercentage > 20) colorClass = 'rgba(255, 193, 7, 0.1)'; // Yellow for medium missing
                                else colorClass = 'rgba(88, 166, 255, 0.05)'; // Blue for low missing
                                
                                return `
                                    <div style="background: ${colorClass}; padding: 12px; border-radius: 6px; border: 1px solid ${missingPercentage > 50 ? 'rgba(248, 81, 73, 0.3)' : missingPercentage > 20 ? 'rgba(255, 193, 7, 0.3)' : 'rgba(88, 166, 255, 0.2)'};">
                                        <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">${column}</div>
                                        <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span>Missing:</span>
                                                <span style="color: ${missingPercentage > 50 ? '#f85149' : missingPercentage > 20 ? '#ffc107' : '#58a6ff'}; font-weight: bold;">${missingCount.toLocaleString()}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span>Percentage:</span>
                                                <span style="color: ${missingPercentage > 50 ? '#f85149' : missingPercentage > 20 ? '#ffc107' : '#58a6ff'}; font-weight: bold;">${missingPercentage.toFixed(2)}%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span>Complete:</span>
                                                <span style="color: #3fb950; font-weight: bold;">${nonMissing.toLocaleString()}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>Type:</span>
                                                <span style="color: #8b949e;">${dataType}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateBoxPlotsContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No box plots analysis available</div>';
            }
            
            const data = result.data;
            return `
                <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 10px;">Box Plot Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        ${Object.entries(data.box_plots || {}).map(([column, stats]) => `
                            <div style="background: rgba(88, 166, 255, 0.05); padding: 12px; border-radius: 6px;">
                                <div style="color: #58a6ff; font-weight: bold; margin-bottom: 5px;">${column}</div>
                                <div style="color: #8b949e; font-size: 12px;">
                                    Q1: ${stats.q1?.toFixed(2) || 'N/A'}<br>
                                    Median: ${stats.median?.toFixed(2) || 'N/A'}<br>
                                    Q3: ${stats.q3?.toFixed(2) || 'N/A'}<br>
                                    Outliers: ${stats.outliers || 0}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${data.chart_data ? `
                    <div style="text-align: center; margin-top: 15px;">
                        <div class="chart-wrapper">
                            <canvas id="boxPlotsChart" aria-label="Box plots visualization" role="img"></canvas>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function generateScatterPlotsContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No scatter plots analysis available</div>';
            }
            
            const data = result.data;
            return `
                <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 10px;">Scatter Plot Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        ${Object.entries(data.scatter_plots || {}).map(([pair, stats]) => `
                            <div style="background: rgba(88, 166, 255, 0.05); padding: 12px; border-radius: 6px;">
                                <div style="color: #58a6ff; font-weight: bold; margin-bottom: 5px;">${pair}</div>
                                <div style="color: #8b949e; font-size: 12px;">
                                    Correlation: ${stats.correlation?.toFixed(3) || 'N/A'}<br>
                                    R¬≤: ${stats.r_squared?.toFixed(3) || 'N/A'}<br>
                                    Points: ${stats.point_count || 0}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${data.chart_data ? `
                    <div style="text-align: center; margin-top: 15px;">
                        <div class="chart-wrapper">
                            <canvas id="scatterPlotsChart" aria-label="Scatter plots visualization" role="img"></canvas>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function generateCategoricalAnalysisContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No categorical analysis available</div>';
            }
            
            const data = result.data;
            return `
                <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 10px;">Categorical Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        ${Object.entries(data.categorical_analysis || {}).map(([column, analysis]) => `
                            <div style="background: rgba(88, 166, 255, 0.05); padding: 12px; border-radius: 6px;">
                                <div style="color: #58a6ff; font-weight: bold; margin-bottom: 5px;">${column}</div>
                                <div style="color: #8b949e; font-size: 12px;">
                                    Unique Values: ${analysis.unique_count || 0}<br>
                                    Most Frequent: ${analysis.most_frequent || 'N/A'}<br>
                                    Frequency: ${analysis.frequency || 0}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${data.chart_data ? `
                    <div style="text-align: center; margin-top: 15px;">
                        <div class="chart-wrapper">
                            <canvas id="categoricalChart" aria-label="Categorical data visualization" role="img"></canvas>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function generateTimeSeriesContent(result) {
            if (!result || !result.data) {
                return '<div style="color: #8b949e;">No time series analysis available</div>';
            }
            
            const data = result.data;
            const timeSeries = data.time_series || {};
            const dateColumnsFound = data.date_columns_found || 0;
            const totalSeriesAnalyzed = data.total_series_analyzed || 0;
            
            if (Object.keys(timeSeries).length === 0) {
                return `
                    <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                        <h4 style="color: #f0f6fc; margin-bottom: 10px;">Time Series Analysis</h4>
                        <div style="color: #8b949e; text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚è∞</div>
                            <div style="font-size: 16px; margin-bottom: 5px;">No Time Series Data Available</div>
                            <div style="font-size: 14px; color: #6b7280;">
                                ${data.message || 'No date columns found for time series analysis'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px;">
                    <h4 style="color: #f0f6fc; margin-bottom: 15px;">Time Series Analysis</h4>
                    
                    <!-- Summary Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 16px;">${dateColumnsFound}</div>
                            <div style="color: #8b949e; font-size: 11px;">Date Columns</div>
                        </div>
                        <div style="background: rgba(88, 166, 255, 0.1); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="color: #58a6ff; font-weight: bold; font-size: 16px;">${totalSeriesAnalyzed}</div>
                            <div style="color: #8b949e; font-size: 11px;">Series Analyzed</div>
                        </div>
                    </div>
                    
                    <!-- Time Series Details -->
                    <div style="max-height: 400px; overflow-y: auto;">
                        <h5 style="color: #f0f6fc; margin-bottom: 10px;">Time Series Details</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            ${Object.entries(timeSeries).map(([seriesName, stats]) => {
                                const trend = stats.trend || 'unknown';
                                const seasonality = stats.seasonality || 'unknown';
                                const period = stats.period || 'N/A';
                                const trendStrength = stats.trend_strength || 'unknown';
                                const volatility = stats.volatility || 'unknown';
                                const rSquared = stats.r_squared || 0;
                                const dataPoints = stats.data_points || 0;
                                const meanValue = stats.mean_value || 0;
                                const stdValue = stats.std_value || 0;
                                
                                // Color coding for trend
                                let trendColor = '#8b949e';
                                if (trend === 'increasing') trendColor = '#3fb950';
                                else if (trend === 'decreasing') trendColor = '#f85149';
                                else if (trend === 'stable') trendColor = '#58a6ff';
                                
                                // Color coding for seasonality
                                let seasonalityColor = '#8b949e';
                                if (seasonality === 'detected') seasonalityColor = '#3fb950';
                                else if (seasonality === 'not_detected') seasonalityColor = '#58a6ff';
                                else if (seasonality === 'insufficient_data') seasonalityColor = '#ffc107';
                                
                                return `
                                    <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                        <div style="color: #58a6ff; font-weight: bold; margin-bottom: 12px; font-size: 14px;">${seriesName}</div>
                                        
                                        <!-- Key Metrics -->
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: #8b949e; font-size: 12px;">Trend:</span>
                                                <span style="color: ${trendColor}; font-weight: bold; font-size: 12px;">${trend}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: #8b949e; font-size: 12px;">Strength:</span>
                                                <span style="color: #58a6ff; font-weight: bold; font-size: 12px;">${trendStrength}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: #8b949e; font-size: 12px;">Seasonality:</span>
                                                <span style="color: ${seasonalityColor}; font-weight: bold; font-size: 12px;">${seasonality}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: #8b949e; font-size: 12px;">Period:</span>
                                                <span style="color: #58a6ff; font-weight: bold; font-size: 12px;">${period}</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Statistical Details -->
                                        <div style="border-top: 1px solid rgba(88, 166, 255, 0.1); padding-top: 10px;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #8b949e;">R¬≤:</span>
                                                    <span style="color: #58a6ff; font-weight: bold;">${(rSquared * 100).toFixed(1)}%</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #8b949e;">Points:</span>
                                                    <span style="color: #58a6ff; font-weight: bold;">${dataPoints.toLocaleString()}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #8b949e;">Mean:</span>
                                                    <span style="color: #58a6ff; font-weight: bold;">${meanValue.toFixed(2)}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #8b949e;">Volatility:</span>
                                                    <span style="color: ${volatility === 'high' ? '#f85149' : volatility === 'medium' ? '#ffc107' : '#3fb950'}; font-weight: bold;">${volatility}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateGenericEDAContent(result, analysisType) {
            return `
                <div style="background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid #30363d;">
                    <h4 style="color: #f0f6fc; margin-bottom: 10px;">${analysisType.replace('_', ' ').toUpperCase()}</h4>
                    <div style="color: #8b949e;">
                        ${result.message || 'Analysis completed successfully'}
                    </div>
                    ${result.data ? `
                        <details style="margin-top: 10px;">
                            <summary style="color: #58a6ff; cursor: pointer;">View Raw Data</summary>
                            <pre style="background: #0d1117; padding: 10px; border-radius: 6px; overflow-x: auto; color: #8b949e; font-size: 12px; margin-top: 10px;">
${JSON.stringify(result.data, null, 2)}
                            </pre>
                        </details>
                    ` : ''}
                </div>
            `;
        }

        function updateMLModelCard(card, result) {
            console.log('ü§ñ ML Model data:', result);
            
            const cardContent = card.querySelector('.card-content');
            if (!cardContent) {
                console.log('‚ùå Card content area not found');
                return;
            }

            const isClassification = !!(result.metrics && (result.metrics.accuracy || result.metrics.f1_score));
            const isRecommendation = !!(result.model_type && result.model_type.toLowerCase().includes('collaborative'));
            const isRegression = !!(
                (result.model_type && /regressor|regression/i.test(result.model_type)) ||
                (result.metrics && (typeof result.metrics.rmse !== 'undefined' || typeof result.metrics.mae !== 'undefined' || typeof result.metrics.r2_score !== 'undefined'))
            );
            const isSegmentation = !!((result.model_type || '').toLowerCase().includes('k-means') || result.cluster_sizes);
            const isAnomaly = !!((result.model_type || '').toLowerCase().includes('isolation forest') || (typeof result.anomaly_rate !== 'undefined'));

            if (isClassification) {
                const accuracy = result.metrics.accuracy || 0;
                const precision = result.metrics.precision || 0;
                const recall = result.metrics.recall || 0;
                const f1Score = result.metrics.f1_score || 0;
                const totalCustomers = result.churn_statistics?.total_customers || 0;
                const churnRate = result.churn_statistics?.churn_rate || 0;
                const highRiskCustomers = result.churn_statistics?.high_risk_customers || 0;
                
                cardContent.innerHTML = `
                    <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">
                        <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px; font-weight: 700;">Machine Learning Model Results</h3>
                        
                        <!-- Performance Metrics with Visual Bars -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Model Performance Metrics</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #8b949e; font-size: 14px;">Accuracy</span>
                                        <span style="color: #3fb950; font-weight: bold; font-size: 16px;">${(accuracy * 100).toFixed(1)}%</span>

                                    </div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.3);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #8b949e; font-size: 14px;">Precision</span>
                                        <span style="color: #58a6ff; font-weight: bold; font-size: 16px;">${(precision * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div style="background: rgba(248, 81, 73, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.3);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #8b949e; font-size: 14px;">Recall</span>
                                        <span style="color: #f85149; font-weight: bold; font-size: 16px;">${(recall * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="color: #8b949e; font-size: 14px;">F1-Score</span>
                                        <span style="color: #ffc107; font-weight: bold; font-size: 16px;">${(f1Score * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Model Statistics -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Model Statistics</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; font-size: 18px; margin-bottom: 5px;">${totalCustomers.toLocaleString()}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Total Samples</div>
                                </div>
                                <div style="background: rgba(248, 81, 73, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.2);">
                                    <div style="color: #f85149; font-weight: bold; font-size: 18px; margin-bottom: 5px;">${(churnRate * 100).toFixed(1)}%</div>
                                    <div style="color: #8b949e; font-size: 12px;">Churn Rate</div>
                                </div>
                                <div style="background: rgba(255, 193, 7, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.2);">
                                    <div style="color: #ffc107; font-weight: bold; font-size: 18px; margin-bottom: 5px;">${highRiskCustomers.toLocaleString()}</div>
                                    <div style="color: #8b949e; font-size: 12px;">High-Risk Customers</div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; font-size: 18px; margin-bottom: 5px;">${result.model_type || 'N/A'}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Model Type</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Model Performance Analysis -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Performance Analysis</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div style="background: rgba(63, 185, 80, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.2);">
                                    <div style="color: #3fb950; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Model Quality</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${accuracy > 0.8 ? '‚úÖ Excellent performance (Accuracy > 80%)' : accuracy > 0.7 ? '‚ö†Ô∏è Good performance (Accuracy > 70%)' : '‚ùå Needs improvement (Accuracy < 70%)'}
                                    </div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Precision vs Recall</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${precision > recall ? 'Higher precision - fewer false positives' : 'Higher recall - fewer false negatives'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Business Impact -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Business Impact</h4>
                            <div class="card-scroll">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div style="background: rgba(248, 81, 73, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.2);">
                                    <div style="color: #f85149; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Risk Assessment</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${highRiskCustomers} customers identified as high churn risk
                                    </div>
                                </div>
                                <div style="background: rgba(63, 185, 80, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.2);">
                                    <div style="color: #3fb950; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Retention Strategy</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        Focus retention efforts on high-risk segments
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-top: 20px;">
                        <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Detailed Classification Performance</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3);">
                                <div style="color: #3fb950; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Accuracy</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(accuracy * 100).toFixed(1)}%</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">${accuracy > 0.8 ? 'Excellent' : accuracy > 0.7 ? 'Good' : accuracy > 0.6 ? 'Fair' : 'Poor'} performance</div>
                            </div>
                            <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.3);">
                                <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Precision</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(precision * 100).toFixed(1)}%</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">True positives / (True + False positives)</div>
                            </div>
                            <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
                                <div style="color: #ffc107; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Recall (Sensitivity)</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(recall * 100).toFixed(1)}%</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">True positives / (True + False negatives)</div>
                            </div>
                            <div style="background: rgba(138, 43, 226, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.3);">
                                <div style="color: #8a2be2; font-weight: bold; margin-bottom: 8px; font-size: 14px;">F1-Score</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(f1Score * 100).toFixed(1)}%</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">Harmonic mean of precision and recall</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(88, 166, 255, 0.05); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; margin-bottom: 10px; font-size: 14px;">Model Performance Analysis</div>
                            <div style="color: #8b949e; font-size: 13px; line-height: 1.5;">
                                ‚Ä¢ <strong>Accuracy:</strong> ${(accuracy * 100).toFixed(1)}% of predictions are correct<br>
                                ‚Ä¢ <strong>Precision:</strong> ${(precision * 100).toFixed(1)}% of positive predictions are actually positive<br>
                                ‚Ä¢ <strong>Recall:</strong> ${(recall * 100).toFixed(1)}% of actual positives are correctly identified<br>
                                ‚Ä¢ <strong>F1-Score:</strong> ${(f1Score * 100).toFixed(1)}% balanced measure of precision and recall
                            </div>
                        </div>
                    </div>
                `;
                console.log('‚úÖ ML (classification) card updated with enhanced visualization');
                
                // Chart generation removed - using detailed text information instead
                return;
            }

            if (isRecommendation) {
                const totalProducts = result.total_products ?? Object.keys(result.product_popularity || {}).length;
                const totalCustomers = result.total_customers ?? 0;
                const pop = result.product_popularity || {};
                const popList = Object.entries(pop).slice(0, 10);

                cardContent.innerHTML = `
                    <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">
                        <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px; font-weight: 700;">Market Basket Analysis</h3>
                        
                        <!-- Summary Statistics -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Analysis Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3); text-align: center;">
                                    <div style="color: #3fb950; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${totalProducts.toLocaleString()}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Total Products</div>
                                    <div style="color: #8b949e; font-size: 10px; margin-top: 4px;">In Catalog</div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.3); text-align: center;">
                                    <div style="color: #58a6ff; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${totalCustomers.toLocaleString()}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Total Customers</div>
                                    <div style="color: #8b949e; font-size: 10px; margin-top: 4px;">Active Users</div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Top Popular Products -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Top Popular Products</h4>
                            <div class="card-scroll">
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${popList.length ? popList.map(([name, count], i) => `
                                    <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2); margin-bottom: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="color: #58a6ff; font-weight: bold; font-size: 16px;">#${i + 1}</div>
                                            <div style="color: #3fb950; font-weight: bold; font-size: 16px;">${count.toLocaleString()} purchases</div>
                                        </div>
                                        <div style="color: #f0f6fc; font-size: 14px; line-height: 1.4; word-wrap: break-word; margin-bottom: 10px;">
                                            ${name.length > 60 ? name.substring(0, 60) + '...' : name}
                                        </div>
                                    </div>
                                `).join('') : '<div style="color: #8b949e; text-align: center; padding: 30px; font-size: 14px;">No popularity data available</div>'}
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-top: 20px;">
                        <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Top Recommended Products</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${popList.slice(0, 10).map(([product, count], index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: rgba(88, 166, 255, 0.05); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.1);">
                                    <div style="display: flex; align-items: center;">
                                        <div style="background: #58a6ff; color: #f0f6fc; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px;">${index + 1}</div>
                                        <div>
                                            <div style="color: #f0f6fc; font-weight: 500; font-size: 14px;">${product.length > 40 ? product.substring(0, 40) + '...' : product}</div>
                                            <div style="color: #8b949e; font-size: 12px;">Product ID: ${product.substring(0, 20)}...</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #3fb950; font-weight: bold; font-size: 16px;">${count}</div>
                                        <div style="color: #8b949e; font-size: 11px;">purchases</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(88, 166, 255, 0.05); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; margin-bottom: 10px; font-size: 14px;">Recommendation Summary</div>
                            <div style="color: #8b949e; font-size: 13px; line-height: 1.5;">
                                ‚Ä¢ <strong>Total Products:</strong> ${totalProducts} items in catalog<br>
                                ‚Ä¢ <strong>Top Product:</strong> "${popList[0] ? popList[0][0].substring(0, 30) + '...' : 'N/A'}" with ${popList[0] ? popList[0][1] : 0} purchases<br>
                                ‚Ä¢ <strong>Recommendation Engine:</strong> Collaborative filtering based on customer behavior patterns
                            </div>
                        </div>
                    </div>
                `;
                console.log('‚úÖ ML (recommendation) card updated with enhanced visualization');
                
                // Chart generation removed - using detailed text information instead
                return;
            }

            if (isRegression) {
                const m = result.metrics || {};
                const r2 = typeof m.r2_score === 'number' ? m.r2_score : null;
                const rmse = typeof m.rmse === 'number' ? m.rmse : null;
                const mae = typeof m.mae === 'number' ? m.mae : null;
                const fi = result.feature_importance || {};
                const fiList = Object.entries(fi).sort((a,b)=>b[1]-a[1]).slice(0,5);
                const preds = Array.isArray(result.predictions_sample) ? result.predictions_sample : [];

                cardContent.innerHTML = `
                    <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">
                        <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px; font-weight: 700;">Demand Forecasting Results</h3>
                        
                        <!-- Performance Metrics with Visual Bars -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Model Performance Metrics</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3); text-align: center;">
                                    <div style="color: #3fb950; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${r2 ? r2.toFixed(3) : 'N/A'}</div>
                                    <div style="color: #8b949e; font-size: 12px;">R¬≤ Score</div>
                                </div>
                                <div style="background: rgba(248, 81, 73, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.3); text-align: center;">
                                    <div style="color: #f85149; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${rmse ? rmse.toFixed(2) : 'N/A'}</div>
                                    <div style="color: #8b949e; font-size: 12px;">RMSE</div>
                                    <div style="color: #8b949e; font-size: 10px; margin-top: 4px;">Root Mean Square Error</div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.3); text-align: center;">
                                    <div style="color: #58a6ff; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${mae ? mae.toFixed(2) : 'N/A'}</div>
                                    <div style="color: #8b949e; font-size: 12px;">MAE</div>
                                    <div style="color: #8b949e; font-size: 10px; margin-top: 4px;">Mean Absolute Error</div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Feature Importance -->
                        ${fiList.length > 0 ? `
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Feature Importance</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${fiList.map(([feature, importance], index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #30363d;">
                                        <span style="color: #f0f6fc; font-size: 14px;">${index + 1}. ${feature}</span>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="color: #58a6ff; font-weight: bold; font-size: 12px;">${(importance * 100).toFixed(1)}%</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Model Insights -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Model Insights</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Model Performance</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${r2 > 0.7 ? '‚úÖ Excellent model fit (R¬≤ > 0.7)' : r2 > 0.5 ? '‚ö†Ô∏è Moderate model fit (R¬≤ > 0.5)' : '‚ùå Poor model fit (R¬≤ < 0.5)'}
                                    </div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Prediction Accuracy</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${rmse < 50 ? '‚úÖ High accuracy predictions' : rmse < 100 ? '‚ö†Ô∏è Moderate accuracy' : '‚ùå Low accuracy predictions'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Predictions Sample -->
                        ${preds.length > 0 ? `
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Sample Predictions</h4>
                            <div class="card-scroll">
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${preds.slice(0, 15).map((pred, index) => `
                                    <div style="background: rgba(88, 166, 255, 0.05); padding: 12px; border-radius: 6px; border: 1px solid rgba(88, 166, 255, 0.2); margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <span style="color: #58a6ff; font-weight: bold; font-size: 14px;">Prediction ${index + 1}</span>
                                            <span style="color: #3fb950; font-weight: bold; font-size: 16px;">${typeof pred === 'number' ? pred.toFixed(2) : pred}</span>
                                        </div>
                                        <div style="color: #8b949e; font-size: 11px;">Forecasted Value</div>
                                    </div>
                                `).join('')}
                            </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Additional Model Information -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Model Details</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Algorithm</div>
                                    <div style="color: #8b949e; font-size: 12px;">Random Forest Regressor</div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Training Status</div>
                                    <div style="color: #3fb950; font-size: 12px;">‚úÖ Model Trained Successfully</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-top: 20px;">
                        <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Detailed Model Performance</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3);">
                                <div style="color: #3fb950; font-weight: bold; margin-bottom: 8px; font-size: 14px;">R¬≤ Score (Coefficient of Determination)</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(r2 || 0).toFixed(4)}</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">${r2 > 0.8 ? 'Excellent fit' : r2 > 0.6 ? 'Good fit' : r2 > 0.4 ? 'Moderate fit' : 'Poor fit'}</div>
                            </div>
                            <div style="background: rgba(248, 81, 73, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.3);">
                                <div style="color: #f85149; font-weight: bold; margin-bottom: 8px; font-size: 14px;">RMSE (Root Mean Square Error)</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(rmse || 0).toFixed(2)}</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">Lower is better</div>
                            </div>
                            <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.3);">
                                <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">MAE (Mean Absolute Error)</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${(mae || 0).toFixed(2)}</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">Average prediction error</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(88, 166, 255, 0.05); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; margin-bottom: 10px; font-size: 14px;">Model Interpretation</div>
                            <div style="color: #8b949e; font-size: 13px; line-height: 1.5;">
                                ‚Ä¢ <strong>R¬≤ Score:</strong> ${((r2 || 0) * 100).toFixed(1)}% of variance in target variable is explained by the model<br>
                                ‚Ä¢ <strong>RMSE:</strong> Typical prediction error is ¬±${(rmse || 0).toFixed(2)} units<br>
                                ‚Ä¢ <strong>MAE:</strong> Average absolute difference between predicted and actual values is ${(mae || 0).toFixed(2)} units
                            </div>
                        </div>
                    </div>
                `;
                console.log('‚úÖ ML (regression) card updated with enhanced visualization');
                
                // Chart generation removed - using detailed text information instead
                return;
            }

            if (isSegmentation) {
                const nClusters = result.n_clusters ?? (result.cluster_sizes ? Object.keys(result.cluster_sizes).length : 'N/A');
                const totalCustomers = result.total_customers ?? 'N/A';
                const sizes = result.cluster_sizes || {};
                const sizesList = Object.entries(sizes).sort((a,b)=>a[0]-b[0]);
                const analysis = Array.isArray(result.cluster_analysis) ? result.cluster_analysis : [];

                // Explainable insights built from real data
                let insightsHtml = '';
                try {
                    if (typeof totalCustomers === 'number' && sizesList.length) {
                        const sorted = [...sizesList].sort((a,b)=>b[1]-a[1]);
                        const [largestKey, largestVal] = sorted[0];
                        const [smallestKey, smallestVal] = sorted[sorted.length-1];
                        const largestPct = (largestVal / totalCustomers) * 100;
                        const smallestPct = (smallestVal / totalCustomers) * 100;
                        insightsHtml += `<li>Largest group: Cluster ${largestKey} (~${largestPct.toFixed(1)}% of customers)</li>`;
                        insightsHtml += `<li>Smallest group: Cluster ${smallestKey} (~${smallestPct.toFixed(1)}%)</li>`;
                    }
                    if (analysis.length) {
                        const monetaryMeans = analysis.map(r => ({ id: r.Cluster ?? r.cluster ?? '?', val: Number(r['Monetary_mean'] ?? r['Monetary'] ?? 0) }));
                        monetaryMeans.sort((a,b)=>b.val-a.val);
                        if (monetaryMeans[0]) {
                            insightsHtml += `<li>Highest average spend: Cluster ${monetaryMeans[0].id} (‚âà ${Number(monetaryMeans[0].val).toLocaleString()})</li>`;
                        }
                    }
                } catch (_) {}

                cardContent.innerHTML = `
                    <div style="padding: 20px;">
                        <h3 style="color: #58a6ff; margin-bottom: 15px;">Customer Segmentation</h3>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background:#161b22; padding:15px; border-radius:8px; text-align:center;">
                                <div style="color:#3fb950; font-size:1.5em; font-weight:600;">${nClusters}</div>
                                <div style="color:#8b949e; font-size:0.9em;">Clusters</div>
                            </div>
                            <div style="background:#161b22; padding:15px; border-radius:8px; text-align:center;">
                                <div style="color:#58a6ff; font-size:1.5em; font-weight:600;">${totalCustomers}</div>
                                <div style="color:#8b949e; font-size:0.9em;">Customers</div>
                            </div>
                        </div>
                        <div style="background:#0d1117; padding:15px; border-radius:8px; border:1px solid #30363d; margin-bottom:15px;">
                            <h4 style="color:#58a6ff; margin-bottom:10px;">Insights</h4>
                            <ul style="color:#c9d1d9; margin:0; padding-left:18px;">${insightsHtml || '<li>Clusters identified. Review sizes and means below.</li>'}</ul>
                        </div>
                        <div style="background:#0d1117; padding:15px; border-radius:8px; border:1px solid #30363d; margin-bottom: 15px;">
                            <h4 style="color:#58a6ff; margin-bottom:10px;">Cluster Sizes</h4>
                            <div class="card-scroll">
                                ${sizesList.length ? sizesList.map(([k,v]) => `<div style=\"display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #30363d;\"><div style=\"color:#f0f6fc;\">Cluster ${k}</div><div style=\"color:#8b949e;\">${v}</div></div>`).join('') : '<div style="color:#8b949e;">No size data</div>'}
                            </div>
                        </div>
                        <div style="background:#0d1117; padding:15px; border-radius:8px; border:1px solid #30363d;">
                            <h4 style="color:#58a6ff; margin-bottom:10px;">Cluster Summary (mean/std)</h4>
                            <div class="card-scroll">
                                ${analysis.length ? analysis.map(row => {
                                    const id = row.Cluster ?? row.cluster ?? '?';
                                    const mMean = row['Monetary_mean'] ?? row['Monetary'] ?? 'N/A';
                                    const fMean = row['Frequency_mean'] ?? row['Frequency'] ?? 'N/A';
                                    const rMean = row['Recency_mean'] ?? row['Recency'] ?? 'N/A';
                                    const mStd = row['Monetary_std'] ?? 'N/A';
                                    const fStd = row['Frequency_std'] ?? 'N/A';
                                    const rStd = row['Recency_std'] ?? 'N/A';
                                    return `<div style=\"padding:8px 0; border-bottom:1px solid #30363d;\"><div style=\"color:#f0f6fc; font-weight:600;\">Cluster ${id}</div><div style=\"color:#8b949e; font-size:0.9em;\">Monetary: ${mMean} (¬±${mStd}) ‚Ä¢ Frequency: ${fMean} (¬±${fStd}) ‚Ä¢ Recency: ${rMean} (¬±${rStd})</div></div>`;
                                }).join('') : '<div style="color:#8b949e;">No analysis data</div>'}
                            </div>
                        </div>
                    </div>`;
                console.log('‚úÖ ML (segmentation) card updated');
                
                return;
            }

            if (isAnomaly) {
                const anomalyRateNum = typeof result.anomaly_rate === 'number' ? (result.anomaly_rate * 100) : null;
                const anomalyRate = anomalyRateNum !== null ? anomalyRateNum.toFixed(2) + '%' : 'N/A';
                const totalAnomalies = result.total_anomalies ?? 0;
                const totalNormal = result.total_normal ?? 0;
                const examples = Array.isArray(result.anomaly_examples) ? result.anomaly_examples : [];

                const totalPoints = (typeof totalAnomalies === 'number' && typeof totalNormal === 'number') ? (totalAnomalies + totalNormal) : null;
                const featureList = examples[0] ? Object.keys(examples[0]) : (result.feature_columns || []);

                cardContent.innerHTML = `
                    <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">
                        <h3 style="color: #58a6ff; margin-bottom: 20px; font-size: 18px; font-weight: 700;">Anomaly Detection Results</h3>
                        
                        <!-- Anomaly Statistics with Visual Indicators -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Detection Summary</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="background: rgba(248, 81, 73, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.3); text-align: center;">
                                    <div style="color: #f85149; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${anomalyRate}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Anomaly Rate</div>
                                </div>
                                <div style="background: rgba(248, 81, 73, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.3); text-align: center;">
                                    <div style="color: #f85149; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${totalAnomalies.toLocaleString()}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Anomalies Found</div>
                                    <div style="color: #8b949e; font-size: 10px; margin-top: 4px;">Suspicious Records</div>
                                </div>
                                <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3); text-align: center;">
                                    <div style="color: #3fb950; font-weight: bold; font-size: 24px; margin-bottom: 5px;">${totalNormal.toLocaleString()}</div>
                                    <div style="color: #8b949e; font-size: 12px;">Normal Records</div>
                                    <div style="color: #8b949e; font-size: 10px; margin-top: 4px;">Valid Data Points</div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Insights and Analysis -->
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-bottom: 20px;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Analysis Insights</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Data Quality Assessment</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${anomalyRateNum !== null ? (anomalyRateNum > 10 ? '‚ö†Ô∏è High anomaly rate detected - review data quality' : '‚úÖ Anomaly rate within normal range') : 'Data quality assessment available'}
                                    </div>
                                </div>
                                <div style="background: rgba(88, 166, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                    <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Features Analyzed</div>
                                    <div style="color: #8b949e; font-size: 12px; line-height: 1.4;">
                                        ${featureList.length ? `${featureList.length} features: ${featureList.slice(0, 3).join(', ')}${featureList.length > 3 ? '...' : ''}` : 'Feature analysis available'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sample Anomalies -->
                        ${examples.length > 0 ? `
                        <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d;">
                            <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Sample Anomalies</h4>
                            <div class="card-scroll">
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${examples.slice(0, 8).map((row, i) => `
                                    <div style="background: rgba(248, 81, 73, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.2); margin-bottom: 12px;">
                                        <div style="color: #f85149; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Anomaly ${i + 1}</div>
                                        <div style="color: #f0f6fc; font-size: 13px; line-height: 1.4; margin-bottom: 8px;">
                                            ${Object.entries(row).slice(0, 4).map(([k, v]) => `<span style="color: #58a6ff;">${k}:</span> <span style="color: #f0f6fc;">${v}</span>`).join(' ‚Ä¢ ')}
                                            ${Object.entries(row).length > 4 ? '<span style="color: #8b949e;">... and more</span>' : ''}
                                        </div>
                                        <div style="color: #8b949e; font-size: 11px;">Suspicious data pattern detected</div>
                                    </div>
                                `).join('')}
                            </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #0d1117; padding: 20px; border-radius: 12px; border: 1px solid #30363d; margin-top: 20px;">
                        <h4 style="color: #f0f6fc; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Anomaly Detection Analysis</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: rgba(248, 81, 73, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(248, 81, 73, 0.3);">
                                <div style="color: #f85149; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Anomalies Detected</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${totalAnomalies}</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">Suspicious records</div>
                            </div>
                            <div style="background: rgba(63, 185, 80, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(63, 185, 80, 0.3);">
                                <div style="color: #3fb950; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Normal Records</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${totalNormal}</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">Valid data points</div>
                            </div>
                            <div style="background: rgba(88, 166, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.3);">
                                <div style="color: #58a6ff; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Anomaly Rate</div>
                                <div style="color: #f0f6fc; font-size: 24px; font-weight: 600;">${((totalAnomalies / (totalAnomalies + totalNormal)) * 100).toFixed(2)}%</div>
                                <div style="color: #8b949e; font-size: 12px; margin-top: 5px;">${((totalAnomalies / (totalAnomalies + totalNormal)) * 100) < 5 ? 'Normal range' : 'High alert'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(88, 166, 255, 0.05); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                            <div style="color: #58a6ff; font-weight: bold; margin-bottom: 10px; font-size: 14px;">Detection Summary</div>
                            <div style="color: #8b949e; font-size: 13px; line-height: 1.5;">
                                ‚Ä¢ <strong>Total Records:</strong> ${totalAnomalies + totalNormal} data points analyzed<br>
                                ‚Ä¢ <strong>Anomaly Rate:</strong> ${((totalAnomalies / (totalAnomalies + totalNormal)) * 100).toFixed(2)}% of records flagged as suspicious<br>
                                ‚Ä¢ <strong>Detection Method:</strong> Isolation Forest algorithm with ${result.contamination || 0.1} contamination parameter<br>
                                ‚Ä¢ <strong>Data Quality:</strong> ${((totalNormal / (totalAnomalies + totalNormal)) * 100).toFixed(1)}% of data appears normal
                            </div>
                        </div>
                    </div>
                `;
                console.log('‚úÖ ML (anomaly) card updated with enhanced visualization');
                
                // Chart generation removed - using detailed text information instead
                return;
            }

            cardContent.innerHTML = `<div style="padding:20px; color:#8b949e;">No model metrics available</div>`;
        }


        function completeAnalysis(cardId, analysisType, result = null) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const statusElement = card.querySelector('.card-status');
            const progressBar = card.querySelector('.progress-fill');
            
            if (statusElement) {
                statusElement.textContent = 'Completed';
                statusElement.className = 'card-status status-completed';
            }
            
            if (progressBar) {
                progressBar.style.width = '100%';
            }

            // ML model metrics are already updated in updateMLModelCard function
            // No need for additional metrics update

            // Store result
            analysisResults[analysisType] = {
                status: 'completed',
                timestamp: new Date().toISOString(),
                type: analysisType,
                result: result
            };

            // Update overview card with new results and export button state
            updateOverviewCard();
            
            // Apply compact styling to any new KPI values
            setTimeout(() => {
                applyCompactKpiStyling();
            }, 100);
            
            console.log('üîç DEBUG: Updated overview card after analysis completion');
        }

        // Removed outdated updateMLModelMetrics function
        // ML model metrics are now properly handled in updateMLModelCard function

        function goBack() {
            window.history.back();
        }

        function forceReload() {
            console.log('üîÑ FORCE RELOAD - Completely resetting page...');
            
            // Clear all localStorage
            try {
                localStorage.clear();
                sessionStorage.clear();
            } catch (error) {
                console.warn('‚ö†Ô∏è Error clearing storage:', error);
            }
            
            // Force reload the page
            window.location.reload(true);
        }

        // Chart instances storage
        const chartInstances = new Map();

        /* ====== Chart-ready helper (global) ======
           Ensures callbacks run once Chart.js is loaded.
           This must be in the global scope (not nested inside initializeDashboard).
        */
        function whenChartReady(cb, interval = 100) {
            console.log('üîç whenChartReady - checking Chart availability', { hasChart: !!window.Chart, readyState: document.readyState });
            if (window.Chart && document.readyState !== 'loading') {
                // Chart already available
                try { cb(); } catch(e) { console.error('Error in chart-ready callback', e); }
                return;
            }

            // If DOM still loading, wait for DOMContentLoaded first
            const onDom = () => {
                const check = setInterval(() => {
                    if (window.Chart) {
                        clearInterval(check);
                        try { cb(); } catch(e) { console.error('Error in chart-ready callback', e); }
                    }
                }, interval);
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', onDom, { once: true });
            } else {
                onDom();
            }
        }

        /* ====== Safe chart creation wrapper ======
           Wraps chart creation with error handling to prevent single chart failures
           from affecting other charts.
        */
        function safeCreateChart(canvasId, config) {
            whenChartReady(() => {
                try {
                    // assume createSimpleChart is your existing factory
                    createSimpleChart(canvasId, config);
                } catch (err) {
                    console.error('safeCreateChart error for', canvasId, err);
                    // optionally show a tiny placeholder message on the card
                    try {
                        const c = document.getElementById(canvasId);
                        if (c && c.parentElement) {
                            c.parentElement.classList.add('chart-error');
                            c.style.display = 'none';
                            const msg = document.createElement('div');
                            msg.textContent = 'Chart unavailable';
                            msg.style.color = '#f85149';
                            msg.style.padding = '12px';
                            c.parentElement.appendChild(msg);
                        }
                    } catch(_) {}
                }
            });
        }
        
        // Global chart management
        window.chartManager = {
            instances: new Map(),
            enabled: false,
            
            enable: function() {
                this.enabled = true;
                console.log('‚úÖ Chart creation enabled');
            },
            
            disable: function() {
                this.enabled = false;
                console.log('üö´ Chart creation disabled');
            },
            
            createChart: function(id, config) {
                if (!this.enabled) {
                    console.warn('üö´ Chart creation disabled - use chartManager.enable() first');
                    return null;
                }
                
                // Destroy existing chart with same ID
                this.destroyChart(id);
                
                // Create new chart
                const canvas = document.getElementById(id);
                if (!canvas) {
                    console.error(`Canvas element with ID '${id}' not found`);
                    return null;
                }
                
                try {
                    const chart = new Chart(canvas, config);
                    this.instances.set(id, chart);
                    chartInstances.set(id, chart);
                    return chart;
                } catch (error) {
                    console.error(`Error creating chart ${id}:`, error);
                    return null;
                }
            },
            
            destroyChart: function(id) {
                if (this.instances.has(id)) {
                    try {
                        this.instances.get(id).destroy();
                        this.instances.delete(id);
                        chartInstances.delete(id);
                        console.log(`‚úÖ Destroyed chart ${id}`);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error destroying chart ${id}:`, error);
                    }
                }
            },
            
            destroyAll: function() {
                this.instances.forEach((chart, id) => {
                    try {
                        chart.destroy();
                        console.log(`‚úÖ Destroyed chart ${id}`);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error destroying chart ${id}:`, error);
                    }
                });
                this.instances.clear();
                chartInstances.clear();
            }
        };

        // Removed refreshDashboard function - no longer needed

        function destroyAllCharts() {
            console.log('üóëÔ∏è Destroying all chart instances...');
            
            // Destroy all stored chart instances
            chartInstances.forEach((chart, id) => {
                try {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                        console.log(`‚úÖ Destroyed chart ${id}`);
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error destroying chart ${id}:`, error);
                }
            });
            
            // Clear the instances map
            chartInstances.clear();
            
            // Also try to destroy any charts that might exist on canvas elements
            const canvasElements = document.querySelectorAll('canvas');
            canvasElements.forEach(canvas => {
                try {
                    // Try to get Chart.js instance from canvas
                    if (canvas.chart) {
                        canvas.chart.destroy();
                        delete canvas.chart;
                    }
                    
                    // Also try to destroy any Chart.js instances that might be attached
                    if (window.Chart && Chart.instances) {
                        Object.keys(Chart.instances).forEach(key => {
                            try {
                                Chart.instances[key].destroy();
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è Error destroying Chart.js instance ${key}:`, error);
                            }
                        });
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error destroying canvas chart:', error);
                }
            });
            
            // Clear any global Chart.js instances
            if (window.Chart && Chart.instances) {
                Object.keys(Chart.instances).forEach(key => {
                    try {
                        Chart.instances[key].destroy();
                        delete Chart.instances[key];
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error destroying global chart ${key}:`, error);
                    }
                });
            }
        }

        function storeChartInstance(id, chart) {
            // Destroy existing chart with same ID if it exists
            if (chartInstances.has(id)) {
                try {
                    chartInstances.get(id).destroy();
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error destroying existing chart ${id}:`, error);
                }
            }
            
            // Store new chart instance
            chartInstances.set(id, chart);
        }

        // Chart creation functions for ML models
        function createRegressionChart(canvasId, r2, rmse, mae) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.log('Canvas not found:', canvasId);
                return;
            }
            
            console.log('Creating regression chart with data:', {r2, rmse, mae});
            
            safeCreateChart(canvasId, {
                type: 'bar',
                data: {
                    labels: ['R¬≤ Score', 'RMSE', 'MAE'],
                    datasets: [{
                        label: 'Model Metrics',
                        data: [r2, rmse, mae],
                        backgroundColor: [
                            'rgba(63, 185, 80, 0.8)',
                            'rgba(248, 81, 73, 0.8)',
                            'rgba(88, 166, 255, 0.8)'
                        ],
                        borderColor: [
                            '#3fb950',
                            '#f85149',
                            '#58a6ff'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const label = context.label;
                                    if (label === 'R¬≤ Score') {
                                        return `${label}: ${value.toFixed(3)}`;
                                    } else {
                                        return `${label}: ${value.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(88, 166, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createRecommendationChart(canvasId, productsData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.log('Canvas not found:', canvasId);
                return;
            }
            
            console.log('Creating recommendation chart with data:', productsData);
            
            // Take top 10 products for the chart
            const topProducts = productsData.slice(0, 10);
            const labels = topProducts.map(([name, count]) => name.length > 20 ? name.substring(0, 20) + '...' : name);
            const data = topProducts.map(([name, count]) => count);
            
            safeCreateChart(canvasId, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Purchase Count',
                        data: data,
                        backgroundColor: 'rgba(88, 166, 255, 0.8)',
                        borderColor: '#58a6ff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Purchases: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(88, 166, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 9
                                },
                                maxRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createAnomalyChart(canvasId, anomalies, normal) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.log('Canvas not found:', canvasId);
                return;
            }
            
            console.log('Creating anomaly chart with data:', {anomalies, normal});
            
            safeCreateChart(canvasId, {
                type: 'doughnut',
                data: {
                    labels: ['Anomalies', 'Normal'],
                    datasets: [{
                        data: [anomalies, normal],
                        backgroundColor: [
                            'rgba(248, 81, 73, 0.8)',
                            'rgba(63, 185, 80, 0.8)'
                        ],
                        borderColor: [
                            '#f85149',
                            '#3fb950'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8b949e',
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createClassificationChart(canvasId, accuracy, precision, recall, f1Score) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.log('Canvas not found:', canvasId);
                return;
            }
            
            console.log('Creating classification chart with data:', {accuracy, precision, recall, f1Score});
            
            safeCreateChart(canvasId, {
                type: 'radar',
                data: {
                    labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score'],
                    datasets: [{
                        label: 'Model Performance',
                        data: [accuracy, precision, recall, f1Score],
                        backgroundColor: 'rgba(88, 166, 255, 0.2)',
                        borderColor: '#58a6ff',
                        borderWidth: 2,
                        pointBackgroundColor: '#58a6ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${(context.parsed.r * 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(88, 166, 255, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(88, 166, 255, 0.1)'
                            },
                            pointLabels: {
                                color: '#8b949e',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Navigation function
        function goBack() {
            window.history.back();
        }

        async function exportAllResults() {
            console.log('üìä Exporting all analysis results...');
            
            // Check if any analyses have been run
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            const hasSelected = selectedAnalyses && selectedAnalyses.size > 0;
            
            if (!hasResults && !hasSelected) {
                alert('‚ö†Ô∏è No analysis results available!\n\nPlease run at least one analysis task before exporting.\n\n1. Select analyses from the control panel\n2. Click "Run Selected Analysis"\n3. Wait for results to generate\n4. Then you can export the results');
                return;
            }
            
            if (!hasResults) {
                alert('‚ö†Ô∏è No results generated yet!\n\nAnalyses are still running. Please wait for results to complete before exporting.');
                return;
            }
            
            // Show export options modal
            const exportType = await showExportOptions();
            
            if (!exportType) {
                return; // User cancelled
            }
            
            try {
                switch(exportType) {
                    case 'data':
                        await exportAnalyticsDataCSV();
                        break;
                    case 'summary':
                        exportAnalyticsSummaryJSON();
                        break;
                    case 'charts':
                        await exportAnalyticsCharts();
                        break;
                    case 'pdf':
                        await exportAnalyticsPDFReport();
                        break;
                    case 'all':
                        await exportAllAnalyticsData();
                        break;
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
            }
        }

        function showExportOptions() {
            return new Promise((resolve) => {
                // Check what's available for export
                const hasResults = Object.keys(analysisResults || {}).length > 0;
                const hasCharts = document.querySelectorAll('canvas').length > 0;
                const resultsCount = Object.keys(analysisResults || {}).length;
                
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: #1e293b;
                    border: 2px solid #58a6ff;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    color: #f0f6fc;
                `;
                
                // Build export options based on available data
                let exportOptionsHTML = `
                    <h2 style="margin: 0 0 20px 0; color: #58a6ff; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-download"></i> Export Analytics Data
                    </h2>
                    <p style="margin-bottom: 10px; color: #94a3b8;">
                        <i class="fas fa-info-circle"></i> ${resultsCount} analysis result(s) available for export
                    </p>
                    <p style="margin-bottom: 20px; color: #94a3b8; font-size: 0.9em;">
                        Choose what you want to export:
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                `;
                
                // Always show data export (if results exist)
                exportOptionsHTML += `
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='data'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.2); border: 1px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-csv"></i> <span>Analysis Data (CSV)</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='summary'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.2); border: 1px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-alt"></i> <span>Summary Report (JSON) - ${resultsCount} result(s)</span>
                        </button>
                `;
                
                // Show charts option only if charts exist
                if (hasCharts) {
                    exportOptionsHTML += `
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='charts'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.2); border: 1px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-image"></i> <span>Charts as Images (ZIP)</span>
                        </button>
                    `;
                } else {
                    exportOptionsHTML += `
                        <button disabled
                                style="padding: 12px; background: rgba(107, 114, 128, 0.2); border: 1px solid rgba(107, 114, 128, 0.3); border-radius: 8px; color: #6b7280; cursor: not-allowed; text-align: left; display: flex; align-items: center; gap: 10px; opacity: 0.5;">
                            <i class="fas fa-image"></i> <span>Charts as Images (ZIP) - No charts available</span>
                        </button>
                    `;
                }
                
                exportOptionsHTML += `
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='pdf'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <i class="fas fa-file-pdf"></i> <span>Complete PDF Report</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='all'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.3); border: 2px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <i class="fas fa-file-archive"></i> <span>Export Everything (ZIP)</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export=''; this.closest('div').parentElement.parentElement.remove()" 
                                style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 8px; color: #f0f6fc; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                `;
                
                content.innerHTML = exportOptionsHTML;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
                
                // Wait for button click
                const checkExport = setInterval(() => {
                    if (modal.dataset.export !== undefined) {
                        clearInterval(checkExport);
                        const exportType = modal.dataset.export || null;
                        modal.remove();
                        resolve(exportType);
                    }
                }, 100);
            });
        }

        async function exportAnalyticsDataCSV() {
            console.log('üìä Exporting analytics data as CSV...');
            
            // Check if any analyses have been run
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            if (!hasResults) {
                alert('‚ö†Ô∏è No analysis results available!\n\nPlease run at least one analysis task before exporting data.');
                return;
            }
            
            try {
                const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
                const transformedData = JSON.parse(localStorage.getItem('transformedData') || '{}');
                const filename = mergedData?.merged_file?.filename || transformedData?.filename || 'analytics_data.csv';
                
                // Try backend download first
                try {
                    const downloadFilename = transformedData?.transformed_file?.filename || `transformed_${filename}` || filename;
                    const downloadUrl = `http://localhost:5000/api/download/${downloadFilename}`;
                    const response = await fetch(downloadUrl);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = downloadFilename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        alert('CSV file downloaded successfully!');
                        return;
                    }
                } catch (error) {
                    console.log('Backend download failed, generating CSV from data...');
                }
                
                // Fallback: Generate CSV from data
                let dataToExport = transformedData.data || transformedData.preview_data || [];
                if (Array.isArray(dataToExport) && dataToExport.length > 0) {
                    const headers = Object.keys(dataToExport[0]);
                    let csvContent = headers.join(',') + '\n';
                    dataToExport.forEach(row => {
                        const values = headers.map(header => {
                            const value = row[header] || '';
                            return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                        });
                        csvContent += values.join(',') + '\n';
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analytics_data_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    alert('CSV file generated and downloaded successfully!');
                } else {
                    alert('No data available for export');
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }

        function exportAnalyticsSummaryJSON() {
            console.log('üìä Exporting analytics summary as JSON...');
            
            // Check if any analyses have been run
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            if (!hasResults) {
                alert('‚ö†Ô∏è No analysis results available!\n\nPlease run at least one analysis task before exporting summary.');
                return;
            }
            
            try {
                const summary = {
                    export_date: new Date().toISOString(),
                    selected_analyses: Array.from(selectedAnalyses || []),
                    analysis_results: analysisResults || {},
                    results_count: Object.keys(analysisResults || {}).length,
                timestamp: new Date().toISOString()
            };
            
                const jsonContent = JSON.stringify(summary, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
                a.download = `analytics_summary_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
            a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('JSON summary report downloaded successfully!');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                alert('Error exporting JSON: ' + error.message);
            }
        }

        async function exportAnalyticsCharts() {
            console.log('üìä Exporting analytics charts as images...');
            
            // Check if any analyses have been run
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            if (!hasResults) {
                alert('‚ö†Ô∏è No analysis results available!\n\nPlease run at least one analysis task before exporting charts.');
                return;
            }
            
            try {
                // Find all chart canvas elements
                const chartCanvases = document.querySelectorAll('canvas');
                const chartImages = [];
                
                if (chartCanvases.length === 0) {
                    alert('‚ö†Ô∏è No charts available to export!\n\nThe selected analyses did not generate any visualizations.');
                    return;
                }
                
                // Load JSZip if needed
                if (typeof JSZip === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    document.head.appendChild(script);
                    await new Promise((resolve) => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000);
                    });
                }
                
                // Capture each chart
                for (let i = 0; i < chartCanvases.length; i++) {
                    const canvas = chartCanvases[i];
                    try {
                        const imageData = canvas.toDataURL('image/png');
                        const chartId = canvas.id || `chart_${i}`;
                        chartImages.push({
                            name: `${chartId}.png`,
                            data: imageData
                        });
                    } catch (error) {
                        console.error(`Error capturing chart ${i}:`, error);
                    }
                }
                
                if (chartImages.length === 0) {
                    alert('‚ö†Ô∏è No charts could be captured!\n\nSome charts may not be ready yet. Please wait a moment and try again.');
                    return;
                }
                
                // Create ZIP file
                const zip = new JSZip();
                chartImages.forEach(({ name, data }) => {
                    const base64Data = data.split(',')[1];
                    zip.file(name, base64Data, { base64: true });
                });
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_charts_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert(`${chartImages.length} chart(s) exported as ZIP file!`);
            } catch (error) {
                console.error('Error exporting charts:', error);
                alert('Error exporting charts: ' + error.message);
            }
        }

        async function exportAnalyticsPDFReport() {
            console.log('üìä Exporting PDF report...');
            
            // Check if any analyses have been run
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            if (!hasResults) {
                alert('‚ö†Ô∏è No analysis results available!\n\nPlease run at least one analysis task before exporting PDF.');
                return;
            }
            
            try {
                // Show loading state
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                `;
                loadingOverlay.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Generating PDF Report...</div>
                    <div style="font-size: 14px; color: #ccc;">Please wait while we capture your analysis results</div>
                `;
                document.body.appendChild(loadingOverlay);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                pdf.setFont('helvetica');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;
                
                // Helper functions
                function addText(text, x, y, maxWidth, fontSize = 12, color = '#000000', align = 'left') {
                    pdf.setFontSize(fontSize);
                    pdf.setTextColor(color);
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    pdf.text(lines, x, y, { align: align });
                    return y + (lines.length * fontSize * 0.4) + 2;
                }
                
                function addLine(x1, y1, x2, y2, color = '#000000', width = 0.5) {
                    pdf.setDrawColor(color);
                    pdf.setLineWidth(width);
                    pdf.line(x1, y1, x2, y2);
                }
                
                function checkNewPage(requiredSpace) {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }
                
                function addSectionHeader(title, y) {
                    pdf.setFontSize(16);
                    pdf.setTextColor('#1f2937');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(title, margin, y);
                    addLine(margin, y + 2, pageWidth - margin, y + 2, '#1f2937', 1);
                    return y + 8;
                }
                
                async function addChartToPDF(canvasId, title) {
                    try {
                        pdf.addPage();
                        let y = margin;
                        
                        pdf.setFontSize(16);
                        pdf.setTextColor('#1f2937');
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(title, margin, y);
                        y += 10;
                        
                        const chartElement = document.getElementById(canvasId);
                        if (chartElement) {
                            // Temporarily hide other charts
                            const allCharts = document.querySelectorAll('canvas');
                            allCharts.forEach(chart => {
                                if (chart.id !== canvasId) {
                                    chart.style.display = 'none';
                                }
                            });
                            
                            const canvas = await html2canvas(chartElement, {
                                backgroundColor: '#161b22',
                                scale: 1.5,
                                useCORS: true,
                                allowTaint: true,
                                logging: false
                            });
                            
                            // Restore charts
                            allCharts.forEach(chart => {
                                chart.style.display = '';
                            });
                            
                            const imgData = canvas.toDataURL('image/png', 0.9);
                            const maxWidth = pageWidth - 2*margin;
                            const maxHeight = pageHeight - 2*margin - 20;
                            const aspectRatio = canvas.width / canvas.height;
                            
                            let imgWidth = maxWidth;
                            let imgHeight = imgWidth / aspectRatio;
                            
                            if (imgHeight > maxHeight) {
                                imgHeight = maxHeight;
                                imgWidth = imgHeight * aspectRatio;
                            }
                            
                            const xOffset = (pageWidth - imgWidth) / 2;
                            pdf.addImage(imgData, 'PNG', xOffset, y, imgWidth, imgHeight);
                            
                            return y + imgHeight + 10;
                        }
                    } catch (error) {
                        console.error('Error capturing chart:', error);
                    }
                    return margin + 20;
                }
                
                // Title Page
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');
                
                yPosition = addText('DataWhiz Advanced Analytics Report', pageWidth/2, 30, pageWidth - 2*margin, 20, '#1f2937', 'center');
                yPosition = addText('Comprehensive Analysis Results', pageWidth/2, yPosition, pageWidth - 2*margin, 14, '#6b7280', 'center');
                yPosition = addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth/2, yPosition, pageWidth - 2*margin, 12, '#9ca3af', 'center');
                
                yPosition += 20;
                addLine(margin, yPosition, pageWidth - margin, yPosition, '#1f2937', 1);
                yPosition += 15;
                
                // Executive Summary
                yPosition = addSectionHeader('EXECUTIVE SUMMARY', yPosition);
                const resultsCount = Object.keys(analysisResults || {}).length;
                const summaryText = `This comprehensive analytics report contains ${resultsCount} analysis result(s) covering various aspects of your business data. Each analysis has been processed and includes detailed insights, metrics, and visualizations to support data-driven decision making.`;
                yPosition = addText(summaryText, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                yPosition += 15;
                
                // Analysis Summary
                checkNewPage(100);
                yPosition = addSectionHeader('ANALYSIS SUMMARY', yPosition);
                
                const selectedAnalysesList = Array.from(selectedAnalyses || []);
                yPosition = addText(`Total Analyses Selected: ${selectedAnalysesList.length}`, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                yPosition = addText(`Total Results Generated: ${resultsCount}`, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                yPosition += 10;
                
                if (selectedAnalysesList.length > 0) {
                    yPosition = addText('Selected Analyses:', margin, yPosition, pageWidth - 2*margin, 12, '#1f2937', 'left');
                    pdf.setFont('helvetica', 'bold');
                    selectedAnalysesList.forEach((analysis, index) => {
                        const status = analysisResults[analysis] ? '‚úì Completed' : '‚è≥ Pending';
                        // Format analysis name properly - convert to readable format
                        const analysisName = analysis.replace(/_/g, ' ')
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        yPosition = addText(`${index + 1}. ${analysisName}: ${status}`, margin + 10, yPosition, pageWidth - 2*margin - 10, 11, '#374151');
                    });
                    pdf.setFont('helvetica', 'normal');
                }
                yPosition += 15;
                
                // Format analysis result as readable text
                function formatResultForPDF(result, analysisType) {
                    if (!result || typeof result !== 'object') return 'No data available';
                    
                    // Helper function to safely convert to number for toFixed()
                    const safeToFixed = (value, decimals = 2) => {
                        const num = Number(value);
                        return isNaN(num) ? '0.00' : num.toFixed(decimals);
                    };
                    
                    const lines = [];
                    const resultObj = result.result || result;
                    
                    // Format based on analysis type
                    switch (analysisType) {
                        case 'total_revenue':
                        case 'avg_order_value':
                            if (resultObj.total_revenue !== undefined) {
                                lines.push(`Total Revenue: $${(resultObj.total_revenue || 0).toLocaleString()}`);
                            }
                            if (resultObj.total_profit !== undefined) {
                                lines.push(`Total Profit: $${(resultObj.total_profit || 0).toLocaleString()}`);
                            }
                            if (resultObj.profit_margin !== undefined) {
                                lines.push(`Profit Margin: ${safeToFixed(resultObj.profit_margin, 1)}%`);
                            }
                            if (resultObj.revenue_growth !== undefined) {
                                lines.push(`Revenue Growth: ${safeToFixed(resultObj.revenue_growth, 1)}%`);
                            }
                            if (resultObj.average_order_value !== undefined) {
                                lines.push(`Average Order Value: $${(resultObj.average_order_value || 0).toLocaleString()}`);
                            }
                            if (resultObj.operating_margin !== undefined) {
                                lines.push(`Operating Margin: ${safeToFixed(resultObj.operating_margin, 1)}%`);
                            }
                            if (resultObj.net_margin !== undefined) {
                                lines.push(`Net Margin: ${safeToFixed(resultObj.net_margin, 1)}%`);
                            }
                            if (resultObj.avg_revenue_per_transaction !== undefined) {
                                lines.push(`Avg Revenue per Transaction: $${safeToFixed(resultObj.avg_revenue_per_transaction, 2)}`);
                            }
                            if (resultObj.total_transactions !== undefined) {
                                lines.push(`Total Transactions: ${(resultObj.total_transactions || 0).toLocaleString()}`);
                            }
                            if (resultObj.order_frequency !== undefined) {
                                lines.push(`Order Frequency: ${safeToFixed(resultObj.order_frequency, 2)} per month`);
                            }
                            if (resultObj.order_value_trend !== undefined) {
                                lines.push(`Order Value Trend: ${resultObj.order_value_trend}`);
                            }
                            if (resultObj.revenue_volatility !== undefined) {
                                lines.push(`Revenue Volatility: ${safeToFixed(resultObj.revenue_volatility, 1)}%`);
                            }
                            if (resultObj.high_value_orders !== undefined) {
                                lines.push(`High Value Orders: ${(resultObj.high_value_orders || 0).toLocaleString()}`);
                            }
                            break;
                            
                        case 'revenue_trends':
                        case 'daily_patterns':
                            if (resultObj.daily_trends) {
                                const dt = resultObj.daily_trends;
                                if (dt.growth_rate !== undefined) {
                                    lines.push(`Daily Growth Rate: ${safeToFixed(dt.growth_rate, 2)}%`);
                                }
                                if (dt.revenue && Array.isArray(dt.revenue)) {
                                    const avgDaily = dt.revenue.reduce((a, b) => Number(a) + Number(b), 0) / dt.revenue.length;
                                    lines.push(`Average Daily Revenue: $${safeToFixed(avgDaily, 2)}`);
                                    lines.push(`Daily Data Points: ${dt.revenue.length}`);
                                }
                            }
                            if (resultObj.weekly_trends) {
                                const wt = resultObj.weekly_trends;
                                if (wt.growth_rate !== undefined) {
                                    lines.push(`Weekly Growth Rate: ${safeToFixed(wt.growth_rate, 2)}%`);
                                }
                                if (wt.revenue && Array.isArray(wt.revenue)) {
                                    const avgWeekly = wt.revenue.reduce((a, b) => Number(a) + Number(b), 0) / wt.revenue.length;
                                    lines.push(`Average Weekly Revenue: $${safeToFixed(avgWeekly, 2)}`);
                                }
                            }
                            if (resultObj.monthly_trends) {
                                const mt = resultObj.monthly_trends;
                                if (mt.growth_rate !== undefined) {
                                    lines.push(`Monthly Growth Rate: ${safeToFixed(mt.growth_rate, 2)}%`);
                                }
                                if (mt.revenue && Array.isArray(mt.revenue)) {
                                    const avgMonthly = mt.revenue.reduce((a, b) => Number(a) + Number(b), 0) / mt.revenue.length;
                                    lines.push(`Average Monthly Revenue: $${safeToFixed(avgMonthly, 2)}`);
                                }
                            }
                            if (resultObj.volatility !== undefined) {
                                lines.push(`Overall Volatility: ${safeToFixed(resultObj.volatility, 2)}%`);
                            }
                            break;
                            
                        case 'rfm_analysis':
                        case 'customer_segmentation':
                            if (resultObj.rfm_analysis && resultObj.rfm_analysis.segments) {
                                lines.push('Customer Segments:');
                                Object.entries(resultObj.rfm_analysis.segments).forEach(([segment, count]) => {
                                    lines.push(`  ‚Ä¢ ${segment}: ${(count || 0).toLocaleString()} customers`);
                                });
                            }
                            if (resultObj.segments) {
                                lines.push('Customer Segments:');
                                Object.entries(resultObj.segments).forEach(([segment, count]) => {
                                    lines.push(`  ‚Ä¢ ${segment}: ${(count || 0).toLocaleString()} customers`);
                                });
                            }
                            if (resultObj.n_clusters !== undefined) {
                                lines.push(`Number of Clusters: ${resultObj.n_clusters}`);
                            }
                            if (resultObj.cluster_sizes) {
                                lines.push('Cluster Sizes:');
                                Object.entries(resultObj.cluster_sizes).forEach(([cluster, size]) => {
                                    lines.push(`  ‚Ä¢ Cluster ${cluster}: ${(size || 0).toLocaleString()} customers`);
                                });
                            }
                            break;
                            
                        case 'top_products':
                        case 'cross_selling_opportunities':
                        case 'category_analysis':
                            if (resultObj.top_products && Array.isArray(resultObj.top_products)) {
                                lines.push(`Top Products (${resultObj.top_products.length}):`);
                                resultObj.top_products.slice(0, 10).forEach((product, idx) => {
                                    if (typeof product === 'string') {
                                        lines.push(`  ${idx + 1}. ${product}`);
                                    } else if (product.name) {
                                        lines.push(`  ${idx + 1}. ${product.name}: $${(product.revenue || 0).toLocaleString()}`);
                                    }
                                });
                            }
                            if (resultObj.top_categories && Array.isArray(resultObj.top_categories)) {
                                lines.push(`Top Categories (${resultObj.top_categories.length}):`);
                                resultObj.top_categories.slice(0, 10).forEach((cat, idx) => {
                                    if (typeof cat === 'string') {
                                        lines.push(`  ${idx + 1}. ${cat}`);
                                    } else if (cat.name) {
                                        lines.push(`  ${idx + 1}. ${cat.name}: $${(cat.revenue || 0).toLocaleString()}`);
                                    }
                                });
                            }
                            break;
                            
                        case 'revenue_by_country':
                        case 'geographic_customer_analysis':
                        case 'market_concentration':
                            if (resultObj.country_data) {
                                lines.push('Revenue by Country:');
                                Object.entries(resultObj.country_data).slice(0, 10).forEach(([country, revenue]) => {
                                    lines.push(`  ‚Ä¢ ${country}: $${(revenue || 0).toLocaleString()}`);
                                });
                            }
                            if (resultObj.market_share) {
                                lines.push('Market Share:');
                                Object.entries(resultObj.market_share).slice(0, 10).forEach(([country, share]) => {
                                    lines.push(`  ‚Ä¢ ${country}: ${safeToFixed(share, 1)}%`);
                                });
                            }
                            break;
                            
                        default:
                            // Generic formatting for unknown types
                            Object.entries(resultObj).forEach(([key, value]) => {
                                if (typeof value === 'object' && !Array.isArray(value) && value !== null) {
                                    lines.push(`${key.replace(/_/g, ' ').toUpperCase()}:`);
                                    Object.entries(value).slice(0, 5).forEach(([subKey, subValue]) => {
                                        if (typeof subValue === 'number') {
                                            if (subValue > 1000) {
                                                lines.push(`  ‚Ä¢ ${subKey.replace(/_/g, ' ')}: ${subValue.toLocaleString()}`);
                                            } else {
                                                lines.push(`  ‚Ä¢ ${subKey.replace(/_/g, ' ')}: ${safeToFixed(subValue, 2)}`);
                                            }
                                        } else if (typeof subValue === 'string') {
                                            lines.push(`  ‚Ä¢ ${subKey.replace(/_/g, ' ')}: ${subValue}`);
                                        }
                                    });
                                } else if (Array.isArray(value)) {
                                    lines.push(`${key.replace(/_/g, ' ').toUpperCase()}: ${value.length} items`);
                                } else if (typeof value === 'number') {
                                    if (value > 1000 || key.includes('revenue') || key.includes('profit') || key.includes('value')) {
                                        lines.push(`${key.replace(/_/g, ' ').toUpperCase()}: $${value.toLocaleString()}`);
                                    } else if (key.includes('margin') || key.includes('growth') || key.includes('rate') || key.includes('percent')) {
                                        lines.push(`${key.replace(/_/g, ' ').toUpperCase()}: ${safeToFixed(value, 2)}%`);
                                    } else {
                                        lines.push(`${key.replace(/_/g, ' ').toUpperCase()}: ${value.toLocaleString()}`);
                                    }
                                } else if (typeof value === 'string' && value.length < 100) {
                                    lines.push(`${key.replace(/_/g, ' ').toUpperCase()}: ${value}`);
                                }
                            });
                    }
                    
                    return lines.length > 0 ? lines.join('\n') : 'Analysis completed. See visualizations for detailed insights.';
                }
                
                // Analysis Results Details
                if (resultsCount > 0) {
                    checkNewPage(100);
                    yPosition = addSectionHeader('DETAILED ANALYSIS RESULTS', yPosition);
                    
                    let resultIndex = 1;
                    for (const [analysisType, resultData] of Object.entries(analysisResults)) {
                        checkNewPage(80);
                        pdf.setFontSize(14);
                        pdf.setTextColor('#1f2937');
                        pdf.setFont('helvetica', 'bold');
                        
                        // Format analysis name properly
                        const analysisName = analysisType.replace(/_/g, ' ')
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                        
                        yPosition = addText(`${resultIndex}. ${analysisName}`, margin, yPosition, pageWidth - 2*margin, 14, '#1f2937');
                        
                        if (resultData.result) {
                            pdf.setFontSize(11);
                            pdf.setTextColor('#374151');
                            pdf.setFont('helvetica', 'normal');
                            
                            // Format result as readable text instead of JSON
                            const formattedResult = formatResultForPDF(resultData.result || resultData, analysisType);
                            const lines = formattedResult.split('\n');
                            
                            yPosition += 5;
                            lines.forEach(line => {
                                if (line.trim()) {
                                    pdf.setFontSize(line.startsWith('  ‚Ä¢') ? 10 : 11);
                                    pdf.setTextColor(line.startsWith('  ‚Ä¢') ? '#6b7280' : '#374151');
                                    yPosition = addText(line, margin + (line.startsWith('  ‚Ä¢') ? 10 : 0), yPosition, pageWidth - 2*margin - (line.startsWith('  ‚Ä¢') ? 10 : 0), line.startsWith('  ‚Ä¢') ? 10 : 11, line.startsWith('  ‚Ä¢') ? '#6b7280' : '#374151');
                                }
                            });
                        }
                        
                        if (resultData.timestamp) {
                            yPosition += 5;
                            pdf.setFontSize(9);
                            pdf.setTextColor('#9ca3af');
                            yPosition = addText(`Generated: ${new Date(resultData.timestamp).toLocaleString()}`, margin, yPosition, pageWidth - 2*margin, 9, '#9ca3af');
                        }
                        
                        yPosition += 10;
                        resultIndex++;
                    }
                }
                
                // Charts Section
                const chartCanvases = document.querySelectorAll('canvas');
                if (chartCanvases.length > 0) {
                    checkNewPage(100);
                    yPosition = addSectionHeader('ANALYSIS VISUALIZATIONS', yPosition);
                    
                    for (let i = 0; i < chartCanvases.length; i++) {
                        const canvas = chartCanvases[i];
                        const chartId = canvas.id || `chart_${i}`;
                        const chartTitle = chartId.replace(/_/g, ' ').replace(/chart/gi, '').trim() || `Chart ${i + 1}`;
                        
                        await new Promise(resolve => setTimeout(resolve, 300));
                        await addChartToPDF(chartId, chartTitle.charAt(0).toUpperCase() + chartTitle.slice(1));
                    }
                }
                
                // Footer
                checkNewPage(40);
                addLine(margin, yPosition, pageWidth - margin, yPosition, '#1f2937', 0.5);
                yPosition += 10;
                yPosition = addText('Generated by DataWhiz Advanced Analytics Platform', pageWidth/2, yPosition, pageWidth - 2*margin, 10, '#6b7280', 'center');
                yPosition = addText('For more insights, visit your DataWhiz dashboard', pageWidth/2, yPosition, pageWidth - 2*margin, 10, '#6b7280', 'center');
                
                // Save PDF
                const fileName = `DataWhiz_Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                console.log('‚úÖ PDF exported successfully!');
                
                // Remove loading overlay
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.parentNode.removeChild(loadingOverlay);
                }
                
                alert(`PDF report generated successfully with ${resultsCount} analysis result(s)! Check your downloads folder.`);
                
            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                
                // Remove loading overlay on error
                const loadingOverlay = document.querySelector('div[style*="position: fixed"]');
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.parentNode.removeChild(loadingOverlay);
                }
                
                alert('Error generating PDF report: ' + error.message);
            }
        }

        async function exportAllAnalyticsData() {
            console.log('üìä Exporting all analytics data...');
            
            // Check if any analyses have been run
            const hasResults = Object.keys(analysisResults || {}).length > 0;
            if (!hasResults) {
                alert('‚ö†Ô∏è No analysis results available!\n\nPlease run at least one analysis task before exporting.');
                return;
            }
            
            try {
                alert(`Preparing complete export package with ${Object.keys(analysisResults || {}).length} analysis result(s). This may take a moment...`);
                
                // Load JSZip if needed
                if (typeof JSZip === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    document.head.appendChild(script);
                    await new Promise((resolve) => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000);
                    });
                }
                
                const zip = new JSZip();
                
                // Export CSV
                try {
                    const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
                    const transformedData = JSON.parse(localStorage.getItem('transformedData') || '{}');
                    let dataToExport = transformedData.data || transformedData.preview_data || [];
                    
                    if (Array.isArray(dataToExport) && dataToExport.length > 0) {
                        const headers = Object.keys(dataToExport[0]);
                        let csvContent = headers.join(',') + '\n';
                        dataToExport.forEach(row => {
                            const values = headers.map(header => {
                                const value = row[header] || '';
                                return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                            });
                            csvContent += values.join(',') + '\n';
                        });
                        zip.file('analytics_data.csv', csvContent);
                    }
                } catch (error) {
                    console.error('Error adding CSV to ZIP:', error);
                }
                
                // Export JSON Summary
                try {
                    const summary = {
                        export_date: new Date().toISOString(),
                        selected_analyses: Array.from(selectedAnalyses || []),
                        analysis_results: analysisResults || {},
                        timestamp: new Date().toISOString()
                    };
                    zip.file('analytics_summary.json', JSON.stringify(summary, null, 2));
                } catch (error) {
                    console.error('Error adding JSON to ZIP:', error);
                }
                
                // Export Charts
                try {
                    const chartCanvases = document.querySelectorAll('canvas');
                    for (let i = 0; i < chartCanvases.length; i++) {
                        const canvas = chartCanvases[i];
                        try {
                            const imageData = canvas.toDataURL('image/png');
                            const base64Data = imageData.split(',')[1];
                            const chartId = canvas.id || `chart_${i}`;
                            zip.file(`${chartId}.png`, base64Data, { base64: true });
                        } catch (error) {
                            console.error(`Error capturing chart ${i}:`, error);
                        }
                    }
                } catch (error) {
                    console.error('Error adding charts to ZIP:', error);
                }
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_export_all_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Complete export package downloaded successfully!');
            } catch (error) {
                console.error('Error exporting all data:', error);
                alert('Error exporting all data: ' + error.message);
            }
        }

        // EDA Chart Creation Functions
        function createBoxPlotsChart(canvasId, chartData) {
            console.log('Creating box plots chart with data:', chartData);
            safeCreateChart(canvasId, {
                type: 'bar',
                data: {
                    labels: Object.keys(chartData.box_plots || {}),
                    datasets: [{
                        label: 'Box Plot Data',
                        data: Object.values(chartData.box_plots || {}).map(data => data.median || 0),
                        backgroundColor: 'rgba(88, 166, 255, 0.6)',
                        borderColor: '#58a6ff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        }
                    }
                }
            });
        }

        function createScatterPlotsChart(canvasId, chartData) {
            console.log('Creating scatter plots chart with data:', chartData);
            safeCreateChart(canvasId, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Scatter Plot',
                        data: Object.values(chartData.scatter_plots || {}).map(data => ({
                            x: data.correlation || 0,
                            y: data.correlation || 0
                        })),
                        backgroundColor: 'rgba(88, 166, 255, 0.6)',
                        borderColor: '#58a6ff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#8b949e'
                            }
                        }
                    }
                }
            });
        }

        function createCategoricalChart(canvasId, chartData) {
            console.log('Creating categorical chart with data:', chartData);
            safeCreateChart(canvasId, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(chartData.categorical || {}),
                    datasets: [{
                        data: Object.values(chartData.categorical || {}),
                        backgroundColor: [
                            'rgba(88, 166, 255, 0.8)',
                            'rgba(63, 185, 80, 0.8)',
                            'rgba(248, 81, 73, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(138, 43, 226, 0.8)'
                        ],
                        borderColor: [
                            '#58a6ff',
                            '#3fb950',
                            '#f85149',
                            '#ffc107',
                            '#8a2be2'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#8b949e',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

