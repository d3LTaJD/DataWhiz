<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DataWhiz - Business Analysis</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/theme.css">
  <style>
    :root {
      --primary: #8b5cf6;
      --primary-2: #7c3aed;
      --surface: #1a1a1a;
      --surface-2: #262626;
      --surface-3: #333333;
      --text: #ffffff;
      --muted: #a3a3a3;
      --muted-2: #737373;
      --border: #404040;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--surface);
      color: var(--text);
      line-height: 1.6;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-button:hover {
      background: var(--primary);
      color: white;
      transform: translateX(-2px);
    }

    .analysis-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 20px 20px;
    }

    .analysis-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .analysis-title {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 12px;
    }

    .analysis-subtitle {
      font-size: 1.1rem;
      color: var(--muted);
      margin-bottom: 30px;
    }

    .data-info-card {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .data-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--surface-3);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .analysis-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      background: var(--surface-2);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .tab-button {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background: var(--primary);
      color: white;
    }

    .tab-button:hover:not(.active) {
      background: var(--surface-3);
      color: var(--text);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .feature-card {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .feature-card:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
    }

    .feature-icon {
      font-size: 2rem;
      margin-bottom: 16px;
    }

    .feature-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .feature-description {
      color: var(--muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .feature-button {
      width: 100%;
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .feature-button:hover {
      background: var(--primary-2);
      transform: translateY(-1px);
    }

    .feature-button:disabled {
      background: var(--muted-2);
      cursor: not-allowed;
      transform: none;
    }

    .progress-section {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .progress-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: var(--border);
      z-index: 1;
    }

    .progress-step.completed:not(:last-child)::after {
      background: var(--success);
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--surface-3);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--muted);
      position: relative;
      z-index: 2;
    }

    .progress-step.completed .step-circle {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .progress-step.active .step-circle {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .step-label {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--muted);
      text-align: center;
    }

    .progress-step.completed .step-label {
      color: var(--success);
    }

    .progress-step.active .step-label {
      color: var(--primary);
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 30px;
    }

    .action-btn {
      padding: 14px 28px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-decoration: none;
      display: inline-block;
      font-size: 1rem;
    }

    .action-btn.primary {
      background: var(--primary);
      color: white;
    }

    .action-btn.primary:hover {
      background: var(--primary-2);
      transform: translateY(-2px);
    }

    .action-btn.secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .action-btn.secondary:hover {
      background: var(--surface-3);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .status-message.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .status-message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .status-message.info {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .auto-processing-status {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .status-header h3 {
      color: var(--text);
      margin-bottom: 8px;
      font-size: 1.3rem;
    }

    .status-header p {
      color: var(--muted);
      margin-bottom: 20px;
    }

    .processing-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .processing-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface-3);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .processing-step.completed {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--success);
    }

    .processing-step.active {
      background: rgba(139, 92, 246, 0.1);
      border-color: var(--primary);
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .processing-step.completed .step-icon {
      background: var(--success);
      color: white;
    }

    .processing-step.active .step-icon {
      background: var(--primary);
      color: white;
    }

    .processing-step.pending .step-icon {
      background: var(--surface-3);
      color: var(--muted);
    }

    .step-text {
      flex: 1;
      color: var(--text);
      font-weight: 500;
    }

    .processing-step.completed .step-text {
      color: var(--success);
    }

    .processing-step.active .step-text {
      color: var(--primary);
    }

    .auto-processing-message {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .auto-processing-message h3 {
      color: var(--text);
      font-size: 1.5rem;
      margin-bottom: 16px;
    }

    .auto-processing-message p {
      color: var(--muted);
      font-size: 1.1rem;
      line-height: 1.6;
    }

    .main-processing-section {
      margin-bottom: 30px;
    }

    .processing-card {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 32px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .processing-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .processing-header h3 {
      color: var(--text);
      font-size: 1.8rem;
      margin-bottom: 12px;
    }

    .processing-header p {
      color: var(--muted);
      font-size: 1.1rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .info-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 20px;
      background: var(--surface-3);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .info-icon {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .info-text h4 {
      color: var(--text);
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .info-text p {
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .processing-actions {
      text-align: center;
    }

    .process-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .process-btn:hover {
      background: var(--primary-2);
      transform: translateY(-2px);
    }

    .process-btn:disabled {
      background: var(--muted-2);
      cursor: not-allowed;
      transform: none;
    }

    .btn-icon {
      font-size: 1.2rem;
    }

    .processing-status {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 32px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .status-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .status-header h3 {
      color: var(--text);
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .status-header p {
      color: var(--muted);
      font-size: 1rem;
    }

    .processing-summary {
      background: var(--surface-2);
      border-radius: 12px;
      padding: 32px;
      border: 1px solid var(--success);
      margin-bottom: 20px;
    }

    .summary-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .summary-header h3 {
      color: var(--success);
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .summary-header p {
      color: var(--muted);
      font-size: 1rem;
    }

    .summary-content {
      margin-bottom: 24px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--text);
      font-weight: 500;
    }

    .summary-value {
      color: var(--primary);
      font-weight: 600;
    }

    .summary-actions {
      text-align: center;
    }

    .analysis-btn {
      background: var(--success);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .analysis-btn:hover {
      background: #059669;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <a href="../data-preview.html" class="back-button">‚Üê Back to Data Preview</a>
  
  <div class="analysis-container">
    <div class="analysis-header">
      <h1 class="analysis-title">üè¢ Business Analysis Workspace</h1>
      <p class="analysis-subtitle">Clean, transform, and analyze your business data for actionable insights</p>
    </div>

    <!-- Data Information Card -->
    <div class="data-info-card" id="dataInfoCard">
      <h3 style="margin-bottom: 16px; color: var(--text);">üìä Your Dataset</h3>
      <div class="data-stats" id="dataStats">
        <!-- Stats will be populated by JavaScript -->
      </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section">
      <h3 class="progress-title">Analysis Progress</h3>
      <div class="progress-steps">
        <div class="progress-step active" id="step1">
          <div class="step-circle">1</div>
          <div class="step-label">Data Loaded</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="step-circle">2</div>
          <div class="step-label">Data Cleaning</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="step-circle">3</div>
          <div class="step-label">Data Transformation</div>
        </div>
        <div class="progress-step" id="step4">
          <div class="step-circle">4</div>
          <div class="step-label">Business Analysis</div>
        </div>
      </div>
    </div>

    <!-- Main Processing Section -->
    <div class="main-processing-section">
      <div class="processing-card" id="processingCard">
        <div class="processing-header">
          <h3>üßπ Data Cleaning & Transformation</h3>
          <p>Clean your data and add business metrics automatically</p>
        </div>
        
        <div class="processing-info">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-icon">üîç</div>
              <div class="info-text">
                <h4>Data Quality Check</h4>
                <p>Analyze missing values, duplicates, and data consistency</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon">üßΩ</div>
              <div class="info-text">
                <h4>Clean Missing Data</h4>
                <p>Handle missing values with smart imputation</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon">üîÑ</div>
              <div class="info-text">
                <h4>Remove Duplicates</h4>
                <p>Eliminate duplicate records for accuracy</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon">‚ûï</div>
              <div class="info-text">
                <h4>Add Business Metrics</h4>
                <p>Calculate profit margins, revenue, and KPIs</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon">üìÖ</div>
              <div class="info-text">
                <h4>Date Features</h4>
                <p>Extract year, month, day, weekday from dates</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon">üè∑Ô∏è</div>
              <div class="info-text">
                <h4>Encode Categories</h4>
                <p>Convert text data to numbers for analysis</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="processing-actions">
          <button class="process-btn" id="processBtn" onclick="startProcessing()">
            <span class="btn-icon">üöÄ</span>
            <span class="btn-text">Clean & Transform Data</span>
          </button>
        </div>
      </div>

      <!-- Processing Status -->
      <div class="processing-status" id="processingStatus" style="display: none;">
        <div class="status-header">
          <h3>ü§ñ Processing Your Data...</h3>
          <p>DataWhiz is automatically cleaning and transforming your data</p>
        </div>
        <div class="processing-steps" id="processingSteps">
          <!-- Processing steps will be populated by JavaScript -->
        </div>
      </div>

      <!-- Processing Summary -->
      <div class="processing-summary" id="processingSummary" style="display: none;">
        <div class="summary-header">
          <h3>‚úÖ Processing Complete!</h3>
          <p>Here's what DataWhiz has done to your data:</p>
        </div>
        <div class="summary-content" id="summaryContent">
          <!-- Summary will be populated by JavaScript -->
        </div>
        <div class="summary-actions">
          <button class="analysis-btn" id="analysisBtn" onclick="proceedToAnalysis()">
            <span class="btn-icon">üìä</span>
            <span class="btn-text">View Transformed Data</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Section -->
    <div class="loading" id="loadingSection">
      <div class="spinner"></div>
      <p>Processing your data...</p>
    </div>

    <!-- Status Messages -->
    <div id="statusMessages"></div>

  </div>

  <script>
    // Get data from localStorage
    const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
    let currentStep = 1;
    let analysisResults = {};
    let processingSummaryResults = {}; // Global object to store summary results

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Business Analysis page loaded');
      console.log('üìä Merged data:', mergedData);
      
      // Set analysis type in localStorage
      if (mergedData.merged_file) {
        mergedData.analysis_type = 'business';
        localStorage.setItem('mergedData', JSON.stringify(mergedData));
        console.log('üìä Set analysis type to business');
      }
      
      populateDataInfo();
      updateProgress();
      
      // Don't auto-start - wait for user to click the button
    });

    function populateDataInfo() {
      if (!mergedData.merged_file) {
        showStatus('No data found. Please go back and upload files.', 'error');
        return;
      }

      const statsContainer = document.getElementById('dataStats');
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${mergedData.merged_file.total_rows.toLocaleString()}</div>
          <div class="stat-label">Total Rows</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${mergedData.merged_file.total_columns}</div>
          <div class="stat-label">Total Columns</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${mergedData.uploaded_files.length}</div>
          <div class="stat-label">Files Merged</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">Business</div>
          <div class="stat-label">Analysis Type</div>
        </div>
      `;
    }

    function switchTab(tabName) {
      // Remove active class from all tabs and content
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to selected tab and content
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    function updateProgress() {
      // Update progress steps based on current step
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (i < currentStep) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (i === currentStep) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      }
    }

    function showLoading(show = true) {
      const loadingSection = document.getElementById('loadingSection');
      if (show) {
        loadingSection.classList.add('active');
      } else {
        loadingSection.classList.remove('active');
      }
    }

    function showStatus(message, type = 'info') {
      const statusContainer = document.getElementById('statusMessages');
      const statusDiv = document.createElement('div');
      statusDiv.className = `status-message ${type}`;
      statusDiv.textContent = message;
      statusContainer.appendChild(statusDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        statusDiv.remove();
      }, 5000);
    }

    // Auto-run data cleaning sequence
    function autoRunDataCleaning() {
      console.log('üßπ Starting auto data cleaning sequence...');
      showLoading(true);
      showAutoProcessingStatus();
      
      // Step 1: Quality Check
      console.log('‚è∞ Step 1: Quality check in 1 second...');
      setTimeout(() => {
        console.log('üîç Running quality check...');
        updateProcessingStep('quality-check', 'active');
        runDataQualityCheck();
      }, 1000);
    }

    // Auto-run data transformation
    function autoRunDataTransformation() {
      console.log('üîÑ Starting auto data transformation...');
      updateProcessingStep('transform', 'active');
      
      // Call the actual backend transformation API
      const filename = mergedData.merged_file.filename;
      console.log('üìÅ Transforming file:', filename);
      
      // Send transformation options to actually generate new columns
      const transformOptions = {
        add_business_metrics: true,
        add_date_features: true,
        encode_categoricals: true
      };
      
      fetch('http://localhost:5000/api/business/transform-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: filename, options: transformOptions })
      })
      .then(response => {
        console.log('üì° Transform data response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('üìä Transform data response:', data);
        if (data.success) {
          console.log('‚úÖ Data transformation completed:', data);
          
          // Store REAL transformation results
          processingSummaryResults.newMetrics = data.new_columns ? data.new_columns.length : 0;
          processingSummaryResults.totalColumns = data.total_columns || 'N/A';
          processingSummaryResults.dateFeatures = data.date_features_count || 0;
          processingSummaryResults.categoriesEncoded = data.categories_encoded_count || 0;
          
          console.log('üìä REAL transformation results stored:');
          console.log('- New columns added:', data.new_columns ? data.new_columns.length : 0);
          console.log('- Total columns:', data.total_columns || 'N/A');
          console.log('- Date features extracted:', data.date_features_count || 0);
          console.log('- Categories encoded:', data.categories_encoded_count || 0);
          
          // CRITICAL FIX: Update the filename to use the transformed file for subsequent steps
          if (data.transformed_file) {
            mergedData.merged_file.filename = data.transformed_file;
            mergedData.merged_file.total_columns = data.total_columns;
            console.log('üîÑ Updated filename to transformed file:', data.transformed_file);
            console.log('üìä Updated column count to:', data.total_columns);
            
            // Store the transformed filename for later use
            mergedData.transformed_file = {
              filename: data.transformed_file,
              total_rows: mergedData.merged_file.total_rows,
              total_columns: data.total_columns
            };
            
            // Update localStorage to persist the change
            localStorage.setItem('mergedData', JSON.stringify(mergedData));
            console.log('üíæ Updated mergedData in localStorage');
          }
          
          // Move to final step: Business Analysis
          console.log('‚è∞ Moving to final step: Business analysis in 2 seconds...');
          setTimeout(() => {
            console.log('üìä Starting business analysis...');
            updateProcessingStep('transform', 'completed');
            updateProcessingStep('analyze', 'active');
            autoRunBusinessAnalysis();
          }, 2000);
        } else {
          console.error('‚ùå Data transformation failed:', data.error);
          showStatus('Data transformation failed: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('‚ùå Data transformation error:', error);
        showStatus('Failed to transform data: ' + error.message, 'error');
      });
    }

    // Auto-run business analysis
    function autoRunBusinessAnalysis() {
      console.log('üìä Starting auto business analysis...');
      updateProcessingStep('analyze', 'active');
      
      // Call the actual backend business analysis API
      const filename = mergedData.merged_file.filename;
      console.log('üìÅ Analyzing file:', filename);
      
      fetch('http://localhost:5000/api/business/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          filename: filename,
          analysis_type: 'business'
        })
      })
      .then(response => {
        console.log('üì° Business analysis response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('üìä Business analysis response:', data);
        if (data.success) {
          console.log('‚úÖ Business analysis completed:', data);
          updateProcessingStep('analyze', 'completed');
          
          // Show processing summary with REAL results from processingSummaryResults
          console.log('üìä Showing processing summary with REAL accumulated results:', processingSummaryResults);
          console.log('üîç DEBUG: Final processingSummaryResults before display:', {
            qualityScore: processingSummaryResults.qualityScore,
            missingCleaned: processingSummaryResults.missingCleaned,
            duplicatesRemoved: processingSummaryResults.duplicatesRemoved,
            newMetrics: processingSummaryResults.newMetrics,
            totalColumns: processingSummaryResults.totalColumns
          });
          showProcessingSummary(processingSummaryResults);
        } else {
          console.error('‚ùå Business analysis failed:', data.error);
          showStatus('Business analysis failed: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('‚ùå Business analysis error:', error);
        showStatus('Failed to run business analysis: ' + error.message, 'error');
      });
    }

    // Data Cleaning Functions
    function runDataQualityCheck() {
      console.log('üîç Starting data quality check...');
      showLoading(true);
      
      const filename = mergedData.merged_file.filename;
      console.log('üìÅ Using filename:', filename);
      
      fetch('http://localhost:5000/api/business/quality-check', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: filename })
      })
      .then(response => {
        console.log('üì° Quality check response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('üìä Quality check response:', data);
        showLoading(false);
        if (data.success) {
          const report = data.quality_report;
          console.log('‚úÖ Quality check completed:', report);
          
          // Store REAL quality check results
          processingSummaryResults.qualityScore = report.quality_score + '%';
          processingSummaryResults.totalColumns = report.total_columns;
          
          // Store initial counts for reference
          processingSummaryResults.initialMissingValues = Object.values(report.missing_values).reduce((a, b) => a + b, 0);
          processingSummaryResults.initialDuplicateRows = report.duplicate_rows;
          
          console.log('üîç DEBUG: Quality check results stored:', {
            qualityScore: processingSummaryResults.qualityScore,
            initialMissingValues: processingSummaryResults.initialMissingValues,
            initialDuplicateRows: processingSummaryResults.initialDuplicateRows,
            totalColumns: processingSummaryResults.totalColumns
          });
          
          currentStep = 2;
          updateProgress();
          
          // Move to next step: Clean Missing Values
          console.log('‚è∞ Moving to next step: Clean missing values in 2 seconds...');
          setTimeout(() => {
            console.log('üßΩ Cleaning missing values...');
            updateProcessingStep('quality-check', 'completed');
            updateProcessingStep('clean-missing', 'active');
            cleanMissingValues();
          }, 2000);
        } else {
          console.error('‚ùå Quality check failed:', data.error);
          showStatus('Quality check failed: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('‚ùå Quality check error:', error);
        showLoading(false);
        showStatus('Failed to run quality check: ' + error.message, 'error');
      });
    }

    function cleanMissingValues() {
      showLoading(true);
      
      const filename = mergedData.merged_file.filename;
      const options = {
        handle_missing: 'fill',
        fill_method: 'mean',
        remove_duplicates: true,
        standardize_formats: true
      };
      
      fetch('http://localhost:5000/api/business/clean-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: filename, options: options })
      })
      .then(response => response.json())
      .then(data => {
        console.log('üìä Clean data response:', data);
        console.log('üîç DEBUG: Clean data response details:', {
          success: data.success,
          rows_removed: data.rows_removed,
          missing_values_found: data.missing_values_found,
          duplicate_rows_found: data.duplicate_rows_found,
          cleaned_file: data.cleaned_file,
          cleaned_rows: data.cleaned_rows
        });
        showLoading(false);
        if (data.success) {
          console.log('‚úÖ Data cleaning completed:', data);
          
          // Store REAL cleaning results with separate counts
          processingSummaryResults.missingCleaned = data.missing_values_found || 0;
          processingSummaryResults.duplicatesRemoved = data.duplicate_rows_found || 0;
          
          // CRITICAL FIX: Update the filename to use the cleaned file for subsequent steps
          if (data.cleaned_file) {
            mergedData.merged_file.filename = data.cleaned_file;
            mergedData.merged_file.total_rows = data.cleaned_rows;
            console.log('üîÑ Updated filename to cleaned file:', data.cleaned_file);
            console.log('üìä Updated row count to:', data.cleaned_rows);
            
            // Update localStorage to persist the change
            localStorage.setItem('mergedData', JSON.stringify(mergedData));
            console.log('üíæ Updated mergedData in localStorage');
          }
          
          console.log('üîç DEBUG: Cleaning results stored:', {
            missingCleaned: processingSummaryResults.missingCleaned,
            duplicatesRemoved: processingSummaryResults.duplicatesRemoved
          });
          
          // DEBUG: Check if the values are actually being set
          console.log('üîç DEBUG: processingSummaryResults after cleaning:', processingSummaryResults);
          
          // Move to next step: Remove Duplicates
          console.log('‚è∞ Moving to next step: Remove duplicates in 2 seconds...');
          setTimeout(() => {
            console.log('üîÑ Removing duplicates...');
            updateProcessingStep('clean-missing', 'completed');
            updateProcessingStep('remove-duplicates', 'active');
            removeDuplicates();
          }, 2000);
        } else {
          console.error('‚ùå Data cleaning failed:', data.error);
          showStatus('Data cleaning failed: ' + data.error, 'error');
        }
      })
      .catch(error => {
        showLoading(false);
        showStatus('Failed to clean data: ' + error.message, 'error');
      });
    }

    function removeDuplicates() {
      console.log('üîÑ Starting duplicate removal...');
      showLoading(true);
      
      // This is handled by the clean-data API, so we just mark it as completed
      setTimeout(() => {
        console.log('‚úÖ Duplicate removal completed (handled by clean-data API)');
        showLoading(false);
        
        // Move to next step: Standardize Formats
        console.log('‚è∞ Moving to next step: Standardize formats in 2 seconds...');
        setTimeout(() => {
          console.log('üìè Standardizing formats...');
          updateProcessingStep('remove-duplicates', 'completed');
          updateProcessingStep('standardize', 'active');
          standardizeFormats();
        }, 2000);
      }, 1200);
    }

    function standardizeFormats() {
      console.log('üìè Starting format standardization...');
      showLoading(true);
      
      // This is also handled by the clean-data API, so we just mark it as completed
      setTimeout(() => {
        console.log('‚úÖ Format standardization completed (handled by clean-data API)');
        showLoading(false);
        
        // Move to next step: Data Transformation
        console.log('‚è∞ Moving to next step: Data transformation in 2 seconds...');
        setTimeout(() => {
          console.log('üîÑ Starting data transformation...');
          updateProcessingStep('standardize', 'completed');
          updateProcessingStep('transform', 'active');
          autoRunDataTransformation();
        }, 2000);
      }, 1800);
    }

    // Data Transformation Functions
    function addBusinessMetrics() {
      showLoading(true);
      
      const filename = mergedData.merged_file.filename;
      const options = {
        add_business_metrics: true,
        add_date_features: true,
        encode_categoricals: true
      };
      
      fetch('http://localhost:5000/api/business/transform-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: filename, options: options })
      })
      .then(response => response.json())
      .then(data => {
        showLoading(false);
        if (data.success) {
          currentStep = 3;
          updateProgress();
        } else {
          showStatus('Transformation failed: ' + data.error, 'error');
        }
      })
      .catch(error => {
        showLoading(false);
        showStatus('Failed to transform data: ' + error.message, 'error');
      });
    }

    function addDateTimeFeatures() {
      showLoading(true);
      
      setTimeout(() => {
        showLoading(false);
      }, 2000);
    }

    function encodeCategoricals() {
      showLoading(true);
      
      setTimeout(() => {
        showLoading(false);
      }, 1600);
    }

    function aggregateData() {
      showLoading(true);
      
      setTimeout(() => {
        showLoading(false);
      }, 2200);
    }

    // Business Analysis Functions
    function runSalesAnalytics() {
      showLoading(true);
      
      const filename = mergedData.merged_file.filename;
      
      fetch('http://localhost:5000/api/business/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: filename, analysis_type: 'sales' })
      })
      .then(response => response.json())
      .then(data => {
        showLoading(false);
        if (data.success) {
          const results = data.results;
          currentStep = 4;
          updateProgress();
          document.getElementById('proceedBtn').disabled = false;
        } else {
          showStatus('Sales analysis failed: ' + data.error, 'error');
        }
      })
      .catch(error => {
        showLoading(false);
        showStatus('Failed to run sales analytics: ' + error.message, 'error');
      });
    }

    function runCustomerAnalysis() {
      showLoading(true);
      
      setTimeout(() => {
        showLoading(false);
      }, 2800);
    }

    function runRevenueAnalysis() {
      showLoading(true);
      
      setTimeout(() => {
        showLoading(false);
      }, 2600);
    }

    function createKPIDashboard() {
      showLoading(true);
      
      setTimeout(() => {
        showLoading(false);
      }, 3200);
    }


    function showAutoProcessingStatus() {
      console.log('üîß Setting up processing status display...');
      
      const statusDiv = document.getElementById('processingStatus');
      const stepsDiv = document.getElementById('processingSteps');
      
      // Check if elements exist
      if (!statusDiv) {
        console.error('‚ùå processingStatus element not found!');
        return;
      }
      
      if (!stepsDiv) {
        console.error('‚ùå processingSteps element not found!');
        return;
      }
      
      console.log('‚úÖ Processing status elements found');
      statusDiv.style.display = 'block';
      
      stepsDiv.innerHTML = `
        <div class="processing-step pending" id="quality-check">
          <div class="step-icon">1</div>
          <div class="step-text">Running data quality check...</div>
        </div>
        <div class="processing-step pending" id="clean-missing">
          <div class="step-icon">2</div>
          <div class="step-text">Cleaning missing values...</div>
        </div>
        <div class="processing-step pending" id="remove-duplicates">
          <div class="step-icon">3</div>
          <div class="step-text">Removing duplicate records...</div>
        </div>
        <div class="processing-step pending" id="standardize">
          <div class="step-icon">4</div>
          <div class="step-text">Standardizing data formats...</div>
        </div>
        <div class="processing-step pending" id="transform">
          <div class="step-icon">5</div>
          <div class="step-text">Adding business metrics and features...</div>
        </div>
        <div class="processing-step pending" id="analyze">
          <div class="step-icon">6</div>
          <div class="step-text">Finalizing data transformation...</div>
        </div>
      `;
      
      console.log('‚úÖ Processing steps HTML created');
    }

    function updateProcessingStep(stepId, status) {
      const step = document.getElementById(stepId);
      if (step) {
        step.className = `processing-step ${status}`;
        
        if (status === 'completed') {
          step.querySelector('.step-icon').textContent = '‚úì';
        } else if (status === 'active') {
          step.querySelector('.step-icon').textContent = '‚ü≥';
        }
      }
    }

    // New simplified workflow functions
    function startProcessing() {
      console.log('üéØ Starting processing workflow...');
      
      // Check if we have data
      if (!mergedData.merged_file) {
        console.error('‚ùå No merged data found!');
        showStatus('No data found. Please go back and upload files.', 'error');
        return;
      }
      
      console.log('‚úÖ Merged data found:', mergedData.merged_file);
      
      // Hide processing card and show status
      document.getElementById('processingCard').style.display = 'none';
      document.getElementById('processingStatus').style.display = 'block';
      
      // Show processing steps immediately
      showAutoProcessingStatus();
      
      // Start the processing sequence
      console.log('üöÄ Starting data cleaning sequence...');
      autoRunDataCleaning();
    }

    function showProcessingSummary(results) {
      console.log('üîç DEBUG: showProcessingSummary received results:', results);
      console.log('üîç DEBUG: processingSummaryResults global object:', processingSummaryResults);
      console.log('üîç DEBUG: Individual values being passed:');
      console.log('- qualityScore:', results.qualityScore);
      console.log('- missingCleaned:', results.missingCleaned);
      console.log('- duplicatesRemoved:', results.duplicatesRemoved);
      console.log('- newMetrics:', results.newMetrics);
      console.log('- totalColumns:', results.totalColumns);
      
      // Store processing results in localStorage for the preview page
      localStorage.setItem('processingSummaryResults', JSON.stringify(results));
      console.log('üíæ Stored processing results in localStorage:', results);
      
      // Hide processing status and show summary
      document.getElementById('processingStatus').style.display = 'none';
      document.getElementById('processingSummary').style.display = 'block';
      
      // Populate summary content with ONLY real data - NO FAKE VALUES
      console.log('üìä Summary results received:', results);
      const summaryContent = document.getElementById('summaryContent');
      summaryContent.innerHTML = `
        <div class="summary-item">
          <span class="summary-label">Data Quality Score</span>
          <span class="summary-value">${results.qualityScore || 'N/A'}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Missing Values Cleaned</span>
          <span class="summary-value">${results.missingCleaned || 'N/A'}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Duplicate Rows Removed</span>
          <span class="summary-value">${results.duplicatesRemoved || 'N/A'}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">New Business Metrics Added</span>
          <span class="summary-value">${results.newMetrics || 'N/A'}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Date Features Extracted</span>
          <span class="summary-value">${results.dateFeatures || 'N/A'}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Categories Encoded</span>
          <span class="summary-value">${results.categoriesEncoded || 'N/A'}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Columns</span>
          <span class="summary-value">${results.totalColumns || 'N/A'}</span>
        </div>
      `;
      
      console.log('üìä Summary values set:');
      console.log('- Quality Score:', results.qualityScore || 'N/A');
      console.log('- Missing Cleaned:', results.missingCleaned || 'N/A');
      console.log('- Duplicates Removed:', results.duplicatesRemoved || 'N/A');
      console.log('- New Metrics:', results.newMetrics || 'N/A');
      console.log('- Total Columns:', results.totalColumns || 'N/A');
    }


             function proceedToAnalysis() {
                 setTimeout(() => {
                     window.location.href = '../transformed-data-preview.html';
                 }, 1000);
             }

  </script>
</body>
</html>
