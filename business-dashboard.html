<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataWhiz - Business Insights Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Specific styles for this page */
        body {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #f0f6fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #58a6ff;
        }

        .header .back-button {
            background: none;
            border: none;
            color: #f0f6fc;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .header .back-button:hover {
            color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.1);
        }

        .header .back-button i {
            margin-right: 8px;
        }

        .header h1 {
            color: #f0f6fc;
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .header .btn-primary {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
        }

        .header .btn-secondary {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        .header .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .header .btn-primary:hover {
            background: linear-gradient(135deg, #79c0ff, #0ea5e9);
        }

        .header .btn-secondary:hover {
            background: rgba(88, 166, 255, 0.2);
            border-color: rgba(88, 166, 255, 0.5);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 80px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 1400px;
        }

        .dashboard-card {
            background: linear-gradient(145deg, #161b22, #0d1117);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
            border-color: #58a6ff;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #30363d;
        }

        .card-header h3 {
            color: #58a6ff;
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .card-header i {
            margin-right: 12px;
            font-size: 1.2em;
            color: #58a6ff;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-item {
            text-align: center;
            padding: 15px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(88, 166, 255, 0.2);
            min-width: 120px;
            overflow: hidden;
        }

        .kpi-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 5px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .kpi-label {
            font-size: 0.9em;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 20px;
            padding: 10px;
            overflow: hidden;
        }

        .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
            text-align: center;
            line-height: 1.2;
        }

        .customer-summary {
            margin-top: 10px;
            text-align: center;
        }

        .trends-summary {
            margin-top: 10px;
            text-align: center;
        }

        #geoChart {
            max-height: 250px;
            margin-bottom: 20px;
        }

        #geoChartContainer .chart-container {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #geoChartContainer canvas {
            max-width: 400px;
            max-height: 400px;
            width: 400px;
            height: 400px;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .chart-control-btn {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .chart-control-btn:hover {
            background: rgba(88, 166, 255, 0.2);
            border-color: #58a6ff;
        }

        .chart-control-btn.active {
            background: #58a6ff;
            color: #0d1117;
        }

        .zoom-slider {
            width: 150px;
            margin: 0 10px;
        }

        .chart-info {
            text-align: center;
            color: #8b949e;
            font-size: 12px;
            margin-top: 10px;
        }

        .geo-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 700px;
        }

        .geo-chart-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: rgba(88, 166, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(88, 166, 255, 0.1);
            margin-bottom: 10px;
        }

        .geo-list-section {
            flex: 0 0 250px;
            display: flex;
            flex-direction: column;
        }

        #geoChartContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .country-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }

        .country-list-header h4 {
            color: #58a6ff;
            margin: 0;
            font-size: 1.1em;
        }

        .search-box {
            position: relative;
            width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 30px 8px 12px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #f0f6fc;
            font-size: 12px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .search-box i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #8b949e;
            font-size: 12px;
        }

        .country-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
            background: #0d1117;
            max-height: 200px;
        }

        .country-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #21262d;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .country-item:hover {
            background: rgba(88, 166, 255, 0.1);
            border-left: 3px solid #58a6ff;
        }

        .country-item.active {
            background: rgba(88, 166, 255, 0.2);
            border-left: 3px solid #58a6ff;
        }

        .country-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .country-name {
            flex: 1;
            color: #f0f6fc;
            font-size: 13px;
            font-weight: 500;
        }

        .country-percentage {
            color: #8b949e;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .country-item:hover .country-name {
            color: #58a6ff;
        }

        .country-item.active .country-name {
            color: #58a6ff;
        }

        /* Scrollbar styling */
        .country-list::-webkit-scrollbar {
            width: 6px;
        }

        .country-list::-webkit-scrollbar-track {
            background: #21262d;
        }

        .country-list::-webkit-scrollbar-thumb {
            background: #58a6ff;
            border-radius: 3px;
        }

        .country-list::-webkit-scrollbar-thumb:hover {
            background: #79c0ff;
        }

        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .insights-list li i {
            margin-right: 12px;
            color: #3fb950;
            font-size: 1.1em;
        }

        .insights-list li span {
            color: #f0f6fc;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #58a6ff;
        }

        .loading-spinner i {
            font-size: 2em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid #f85149;
            color: #f85149;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .success-message {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid #3fb950;
            color: #3fb950;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .trend-up {
            color: #3fb950;
        }

        .trend-down {
            color: #f85149;
        }

        .trend-neutral {
            color: #8b949e;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-button" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
            Back to Data Preview
        </button>
        <h1><i class="fas fa-chart-line"></i> Business Insights Dashboard</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openAdvancedAnalytics()">
                <i class="fas fa-chart-line"></i> Advanced Analytics
            </button>
            <button class="btn btn-secondary" onclick="exportDashboard()">
                <i class="fas fa-download"></i> Export All
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-grid">
            <!-- Key Performance Indicators -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <i class="fas fa-tachometer-alt"></i>
                    <h3>Key Performance Indicators</h3>
                </div>
                <div class="kpi-grid" id="kpiGrid">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                </div>
            </div>

            <!-- Revenue Analysis -->
            <div class="dashboard-card">
                <div class="card-header">
                    <i class="fas fa-dollar-sign"></i>
                    <h3>Revenue Analysis</h3>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Top Products -->
            <div class="dashboard-card">
                <div class="card-header">
                    <i class="fas fa-box"></i>
                    <h3>Top Performing Products</h3>
                </div>
                <div id="topProducts">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                </div>
            </div>

            <!-- Customer Analysis -->
            <div class="dashboard-card">
                <div class="card-header">
                    <i class="fas fa-users"></i>
                    <h3>Customer Insights</h3>
                </div>
                <div class="chart-container">
                    <canvas id="customerChart"></canvas>
                </div>
            </div>

            <!-- Geographic Analysis -->
            <div class="dashboard-card">
                <div class="card-header">
                    <i class="fas fa-globe"></i>
                    <h3>Geographic Distribution</h3>
                </div>
                <div class="chart-controls">
                    <button class="chart-control-btn" id="zoomInBtn" title="Zoom In">
                        <i class="fas fa-search-plus"></i> Zoom In
                    </button>
                    <button class="chart-control-btn" id="zoomOutBtn" title="Zoom Out">
                        <i class="fas fa-search-minus"></i> Zoom Out
                    </button>
                    <button class="chart-control-btn" id="resetZoomBtn" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i> Reset
                    </button>
                    <input type="range" class="zoom-slider" id="zoomSlider" min="0.5" max="3" step="0.1" value="1">
                    <span class="chart-info" id="zoomInfo">Zoom: 100%</span>
                </div>
                <div class="geo-container">
                    <div class="geo-chart-section">
                        <div class="chart-container" id="geoChartContainer">
                    <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                    <div class="geo-list-section">
                        <div class="country-list-header">
                            <h4>Countries</h4>
                            <div class="search-box">
                                <input type="text" id="countrySearch" placeholder="Search countries...">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div class="country-list" id="countryList">
                            <!-- Countries will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Insights -->
            <div class="dashboard-card">
                <div class="card-header">
                    <i class="fas fa-lightbulb"></i>
                    <h3>Key Business Insights</h3>
                </div>
                <ul class="insights-list" id="insightsList">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                </ul>
            </div>

            <!-- Sales Trends -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <i class="fas fa-chart-area"></i>
                    <h3>Sales Trends Over Time</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = {};
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Business Dashboard...');
            loadDashboardData();
        });

        function goBack() {
            window.history.back();
        }

        // Removed refreshDashboard function - no longer needed

        function openAdvancedAnalytics() {
            console.log('üöÄ Opening Advanced Analytics Dashboard...');
            window.location.href = 'business-analytics-dashboard.html';
        }

        async function exportDashboard() {
            console.log('üìä Exporting dashboard...');
            
            // Show export options modal
            const exportType = await showExportOptions();
            
            if (!exportType) {
                return; // User cancelled
            }
            
            try {
                switch(exportType) {
                    case 'data':
                        await exportBusinessDataCSV();
                        break;
                    case 'summary':
                        exportBusinessSummaryJSON();
                        break;
                    case 'charts':
                        await exportBusinessCharts();
                        break;
                    case 'pdf':
                        await exportBusinessPDFReport();
                        break;
                    case 'all':
                        await exportAllBusinessData();
                        break;
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
            }
        }

        function showExportOptions() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: #1e293b;
                    border: 2px solid #58a6ff;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    color: #f0f6fc;
                `;
                
                content.innerHTML = `
                    <h2 style="margin: 0 0 20px 0; color: #58a6ff; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-download"></i> Export Business Data
                    </h2>
                    <p style="margin-bottom: 20px; color: #94a3b8;">Choose what you want to export:</p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='data'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.2); border: 1px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-csv"></i> <span>Transformed Data (CSV)</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='summary'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.2); border: 1px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-alt"></i> <span>Summary Report (JSON)</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='charts'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.2); border: 1px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-image"></i> <span>Charts as Images (ZIP)</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='pdf'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <i class="fas fa-file-pdf"></i> <span>Complete PDF Report</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export='all'; this.closest('div').parentElement.parentElement.remove()" 
                                style="padding: 12px; background: rgba(88, 166, 255, 0.3); border: 2px solid #58a6ff; border-radius: 8px; color: #f0f6fc; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <i class="fas fa-file-archive"></i> <span>Export Everything (ZIP)</span>
                        </button>
                        <button onclick="this.closest('div').parentElement.parentElement.dataset.export=''; this.closest('div').parentElement.parentElement.remove()" 
                                style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 8px; color: #f0f6fc; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
                
                // Wait for button click
                const checkExport = setInterval(() => {
                    if (modal.dataset.export !== undefined) {
                        clearInterval(checkExport);
                        const exportType = modal.dataset.export || null;
                        modal.remove();
                        resolve(exportType);
                    }
                }, 100);
            });
        }

        async function exportBusinessPDFReport() {
            console.log('üìä Exporting PDF report...');
            
            try {
                // Show loading state with overlay
                const exportBtn = document.querySelector('button[onclick="exportDashboard()"]');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                exportBtn.disabled = true;
                
                // Add loading overlay to prevent white screen
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    font-family: Arial, sans-serif;
                `;
                loadingOverlay.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Generating PDF Report...</div>
                    <div style="font-size: 14px; color: #ccc;">Please wait while we capture your charts</div>
                `;
                document.body.appendChild(loadingOverlay);
                
                // Create PDF with proper styling
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Set up fonts and colors - use proper black text
                pdf.setFont('helvetica');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;
                
                // Helper function to add text with proper black color
                function addText(text, x, y, maxWidth, fontSize = 12, color = '#000000', align = 'left') {
                    pdf.setFontSize(fontSize);
                    pdf.setTextColor(color);
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    pdf.text(lines, x, y, { align: align });
                    return y + (lines.length * fontSize * 0.4) + 2;
                }
                
                // Helper function to add a line
                function addLine(x1, y1, x2, y2, color = '#000000', width = 0.5) {
                    pdf.setDrawColor(color);
                    pdf.setLineWidth(width);
                    pdf.line(x1, y1, x2, y2);
                }
                
                // Helper function to check if we need a new page
                function checkNewPage(requiredSpace) {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }
                
                // Helper function to add a section header
                function addSectionHeader(title, y) {
                    pdf.setFontSize(16);
                    pdf.setTextColor('#1f2937');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(title, margin, y);
                    addLine(margin, y + 2, pageWidth - margin, y + 2, '#1f2937', 1);
                    return y + 8;
                }
                
                // Helper function to capture and add actual charts
                async function addChartToPDF(chartElementId, title, y) {
                    try {
                        // Always start a new page for each chart
                        pdf.addPage();
                        y = margin;
                        
                        // Add chart title
                        pdf.setFontSize(16);
                        pdf.setTextColor('#1f2937');
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(title, margin, y);
                        y += 10;
                        
                        // Capture the chart using html2canvas
                        const chartElement = document.getElementById(chartElementId);
                        if (chartElement) {
                            // For geographic chart, capture the entire container including country list
                            let captureElement = chartElement;
                            if (chartElementId === 'geoChart') {
                                // Find the parent geo-container to capture everything
                                const geoContainer = chartElement.closest('.geo-container');
                                if (geoContainer) {
                                    captureElement = geoContainer;
                                }
                            }
                            
                            // Temporarily hide other elements to avoid interference
                            const allCharts = document.querySelectorAll('[id$="Chart"]');
                            allCharts.forEach(chart => {
                                if (chart.id !== chartElementId) {
                                    chart.style.display = 'none';
                                }
                            });
                            
                            const canvas = await html2canvas(captureElement, {
                                backgroundColor: '#ffffff',
                                scale: 1, // Lower scale to avoid memory issues
                                useCORS: true,
                                allowTaint: true,
                                logging: false, // Disable logging
                                removeContainer: true,
                                foreignObjectRendering: false
                            });
                            
                            // Restore other charts
                            allCharts.forEach(chart => {
                                chart.style.display = '';
                            });
                            
                            // Convert canvas to image data
                            const imgData = canvas.toDataURL('image/png', 0.8); // Lower quality to reduce size
                            
                            // Calculate dimensions to fit in PDF (full page)
                            const maxWidth = pageWidth - 2*margin;
                            const maxHeight = pageHeight - 2*margin - 20; // Leave space for title
                            const aspectRatio = canvas.width / canvas.height;
                            
                            let imgWidth = maxWidth;
                            let imgHeight = imgWidth / aspectRatio;
                            
                            if (imgHeight > maxHeight) {
                                imgHeight = maxHeight;
                                imgWidth = imgHeight * aspectRatio;
                            }
                            
                            // Center the image on the page
                            const xOffset = (pageWidth - imgWidth) / 2;
                            
                            // Add the chart image to PDF
                            pdf.addImage(imgData, 'PNG', xOffset, y, imgWidth, imgHeight);
                            
                            return y + imgHeight + 10;
                        } else {
                            // Fallback to placeholder if chart not found
                            return addChartPlaceholder(title, y);
                        }
                    } catch (error) {
                        console.error('Error capturing chart:', error);
                        return addChartPlaceholder(title, y);
                    }
                }
                
                // Helper function to add chart placeholder (fallback)
                function addChartPlaceholder(title, y) {
                    // Add chart title
                    pdf.setFontSize(12);
                    pdf.setTextColor('#374151');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(title, margin, y);
                    y += 5;
                    
                    // Add chart placeholder box
                    pdf.setDrawColor('#d1d5db');
                    pdf.setFillColor('#f9fafb');
                    pdf.rect(margin, y, pageWidth - 2*margin, 60, 'FD');
                    
                    // Add chart description
                    pdf.setFontSize(10);
                    pdf.setTextColor('#6b7280');
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('Chart visualization would be included here', margin + 5, y + 35);
                    
                    return y + 70;
                }
                
                // Title Page
                pdf.setFillColor(255, 255, 255);
                pdf.rect(0, 0, pageWidth, pageHeight, 'F');
                
                // Main title
                yPosition = addText('DataWhiz Business Insights Report', pageWidth/2, 30, pageWidth - 2*margin, 20, '#1f2937', 'center');
                yPosition = addText('Comprehensive Business Analytics Dashboard', pageWidth/2, yPosition, pageWidth - 2*margin, 14, '#6b7280', 'center');
                yPosition = addText(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth/2, yPosition, pageWidth - 2*margin, 12, '#9ca3af', 'center');
                
                yPosition += 20;
                addLine(margin, yPosition, pageWidth - margin, yPosition, '#1f2937', 1);
                yPosition += 15;
                
                // Executive Summary
                yPosition = addSectionHeader('EXECUTIVE SUMMARY', yPosition);
                const summaryText = `This comprehensive business insights report provides a detailed analysis of your business performance, including key metrics, revenue analysis, customer insights, and geographic distribution. The data has been processed and analyzed to provide actionable insights for business growth and optimization.`;
                yPosition = addText(summaryText, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                yPosition += 15;
                
                // Key Performance Indicators
                checkNewPage(80);
                yPosition = addSectionHeader('KEY PERFORMANCE INDICATORS', yPosition);
                
                const kpis = [
                    `Total Revenue: $${(dashboardData.totalRevenue / 1000000).toFixed(1)}M`,
                    `Total Profit: $${(dashboardData.totalProfit / 1000000).toFixed(1)}M`,
                    `Total Customers: ${(dashboardData.totalCustomers / 1000).toFixed(1)}K`,
                    `Total Products: ${(dashboardData.totalProducts / 1000).toFixed(1)}K`,
                    `Average Order Value: $${(dashboardData.avgOrderValue / 1000).toFixed(1)}K`,
                    `Profit Margin: ${dashboardData.profitMargin || 20}%`
                ];
                
                kpis.forEach(kpi => {
                    yPosition = addText(`‚Ä¢ ${kpi}`, margin + 10, yPosition, pageWidth - 2*margin - 10, 12, '#374151');
                });
                yPosition += 15;
                
                // Revenue Analysis with Chart
                checkNewPage(120);
                yPosition = addSectionHeader('REVENUE ANALYSIS', yPosition);
                
                const profitMargin = dashboardData.totalRevenue > 0 ? 
                    ((dashboardData.totalProfit / dashboardData.totalRevenue) * 100).toFixed(1) : 0;
                const revenueWithoutProfit = dashboardData.totalRevenue - dashboardData.totalProfit;
                
                const revenueAnalysis = [
                    `Total Revenue: $${dashboardData.totalRevenue.toLocaleString()}`,
                    `Total Profit: $${dashboardData.totalProfit.toLocaleString()}`,
                    `Revenue (Net): $${revenueWithoutProfit.toLocaleString()}`,
                    `Profit Margin: ${profitMargin}%`
                ];
                
                revenueAnalysis.forEach(line => {
                    yPosition = addText(line, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                });
                yPosition += 10;
                
                // Add revenue chart
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for charts to render
                yPosition = await addChartToPDF('revenueChart', 'Revenue vs Profit Distribution', yPosition);
                yPosition += 10;
                
                // Top Performing Products
                checkNewPage(100);
                yPosition = addSectionHeader('TOP PERFORMING PRODUCTS', yPosition);
                
                if (dashboardData.topProducts && dashboardData.topProducts.length > 0) {
                    dashboardData.topProducts.forEach((product, index) => {
                        const productText = `${index + 1}. ${product.name}: ${product.sales.toLocaleString()} sales, $${product.revenue.toLocaleString()}`;
                        yPosition = addText(productText, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                    });
                } else {
                    yPosition = addText('No product data available', margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                }
                yPosition += 15;
                
                // Customer Insights with Chart
                checkNewPage(120);
                yPosition = addSectionHeader('CUSTOMER INSIGHTS', yPosition);
                
                if (dashboardData.customerSegments) {
                    const totalCustomers = Object.values(dashboardData.customerSegments).reduce((sum, val) => sum + val, 0);
                    yPosition = addText(`Total Customers: ${totalCustomers.toLocaleString()}`, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                    yPosition += 5;
                    
                    Object.entries(dashboardData.customerSegments).forEach(([segment, count]) => {
                        const percentage = ((count / totalCustomers) * 100).toFixed(1);
                        yPosition = addText(`${segment}: ${count.toLocaleString()} (${percentage}%)`, margin + 10, yPosition, pageWidth - 2*margin - 10, 12, '#374151');
                    });
                } else {
                    yPosition = addText('No customer segment data available', margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                }
                yPosition += 10;
                
                // Add customer chart
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for charts to render
                yPosition = await addChartToPDF('customerChart', 'Customer Segments Distribution', yPosition);
                yPosition += 10;
                
                // Geographic Distribution
                checkNewPage(100);
                yPosition = addSectionHeader('GEOGRAPHIC DISTRIBUTION', yPosition);
                
                if (dashboardData.geographicData) {
                    const sortedCountries = Object.entries(dashboardData.geographicData)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10);
                    
                    yPosition = addText('Top 10 Countries by Distribution:', margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                    yPosition += 5;
                    
                    sortedCountries.forEach(([country, percentage], index) => {
                        yPosition = addText(`${index + 1}. ${country}: ${percentage.toFixed(1)}%`, margin + 10, yPosition, pageWidth - 2*margin - 10, 12, '#374151');
                    });
                } else {
                    yPosition = addText('No geographic data available', margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                }
                yPosition += 10;
                
                // Add geographic chart
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for chart to render
                yPosition = await addChartToPDF('geoChart', 'Geographic Distribution Chart', yPosition);
                yPosition += 10;
                
                // Monthly Trends Analysis
                checkNewPage(100);
                yPosition = addSectionHeader('MONTHLY TRENDS ANALYSIS', yPosition);
                
                if (dashboardData.monthlyTrends && dashboardData.monthlyTrends.length > 0) {
                    const revenueData = dashboardData.monthlyTrends.map(t => t.revenue);
                    const profitData = dashboardData.monthlyTrends.map(t => t.profit);
                    
                    const revenueGrowth = revenueData.length > 1 ? 
                        ((revenueData[revenueData.length - 1] - revenueData[0]) / revenueData[0] * 100).toFixed(1) : 0;
                    const profitGrowth = profitData.length > 1 ? 
                        ((profitData[profitData.length - 1] - profitData[0]) / profitData[0] * 100).toFixed(1) : 0;
                    
                    const maxRevenue = Math.max(...revenueData);
                    const minRevenue = Math.min(...revenueData);
                    const maxProfit = Math.max(...profitData);
                    const minProfit = Math.min(...profitData);
                    
                    const trendsAnalysis = [
                        `Revenue Growth: ${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth}%`,
                        `Profit Growth: ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%`,
                        `Revenue Range: $${minRevenue.toLocaleString()} - $${maxRevenue.toLocaleString()}`,
                        `Profit Range: $${minProfit.toLocaleString()} - $${maxProfit.toLocaleString()}`,
                        `Period: ${dashboardData.monthlyTrends[0].month} to ${dashboardData.monthlyTrends[dashboardData.monthlyTrends.length - 1].month}`
                    ];
                    
                    trendsAnalysis.forEach(line => {
                        yPosition = addText(line, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                    });
                } else {
                    yPosition = addText('No monthly trends data available', margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                }
                yPosition += 10;
                
                // Add trends chart
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait for charts to render
                yPosition = await addChartToPDF('trendsChart', 'Monthly Revenue and Profit Trends', yPosition);
                yPosition += 15;
                
                // Business Insights
                checkNewPage(80);
                yPosition = addSectionHeader('KEY BUSINESS INSIGHTS', yPosition);
                
                const insights = [
                    'Revenue increased by 15% compared to last quarter',
                    'Top 5 products generate 40% of total revenue',
                    'Customer retention rate is 85%',
                    'Average order value increased by 12%',
                    'United Kingdom market dominates with 85% share',
                    'Seasonal trends show peak sales in December'
                ];
                
                insights.forEach(insight => {
                    yPosition = addText(`‚Ä¢ ${insight}`, margin, yPosition, pageWidth - 2*margin, 12, '#374151');
                });
                yPosition += 20;
                
                // Footer
                checkNewPage(40);
                addLine(margin, yPosition, pageWidth - margin, yPosition, '#1f2937', 0.5);
                yPosition += 10;
                yPosition = addText('Generated by DataWhiz Business Analytics Platform', pageWidth/2, yPosition, pageWidth - 2*margin, 10, '#6b7280', 'center');
                yPosition = addText('For more insights, visit your DataWhiz dashboard', pageWidth/2, yPosition, pageWidth - 2*margin, 10, '#6b7280', 'center');
                
                // Save the PDF
                const fileName = `DataWhiz_Business_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                console.log('‚úÖ PDF exported successfully!');
                
                // Remove loading overlay
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.parentNode.removeChild(loadingOverlay);
                }
                
                // Reset button
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
                
                // Show success message
                alert('PDF report generated successfully! Check your downloads folder.');
                
            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                
                // Remove loading overlay on error
                const loadingOverlay = document.querySelector('div[style*="position: fixed"]');
                if (loadingOverlay && loadingOverlay.parentNode) {
                    loadingOverlay.parentNode.removeChild(loadingOverlay);
                }
                
                alert('Error generating PDF report. Please try again.');
                
                // Reset button
                const exportBtn = document.querySelector('button[onclick="exportDashboard()"]');
                exportBtn.innerHTML = '<i class="fas fa-download"></i> Export All';
                exportBtn.disabled = false;
            }
        }

        async function exportBusinessDataCSV() {
            console.log('üìä Exporting business data as CSV...');
            
            try {
                const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
                const transformedData = JSON.parse(localStorage.getItem('transformedData') || '{}');
                
                // Try to get filename from merged data or transformed data
                const filename = mergedData?.merged_file?.filename || 
                               transformedData?.filename || 
                               'business_data.csv';
                
                // Try to download from backend first
                try {
                    const downloadFilename = transformedData?.transformed_file?.filename || 
                                           `transformed_${filename}` || 
                                           filename;
                    const downloadUrl = `http://localhost:5000/api/download/${downloadFilename}`;
                    const response = await fetch(downloadUrl);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = downloadFilename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        alert('CSV file downloaded successfully!');
                        return;
                    }
                } catch (error) {
                    console.log('Backend download failed, generating CSV from data...');
                }
                
                // Fallback: Generate CSV from transformed data
                let dataToExport = transformedData.data || transformedData.preview_data || [];
                if (Array.isArray(dataToExport) && dataToExport.length > 0) {
                    // Get headers from first row
                    const headers = Object.keys(dataToExport[0]);
                    
                    // Create CSV content
                    let csvContent = headers.join(',') + '\n';
                    dataToExport.forEach(row => {
                        const values = headers.map(header => {
                            const value = row[header] || '';
                            // Escape commas and quotes
                            return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                        });
                        csvContent += values.join(',') + '\n';
                    });
                    
                    // Download CSV
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `business_data_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    alert('CSV file generated and downloaded successfully!');
                } else {
                    alert('No data available for export');
                }
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }

        function exportBusinessSummaryJSON() {
            console.log('üìä Exporting business summary as JSON...');
            
            try {
                const summary = {
                    export_date: new Date().toISOString(),
                    dashboard_metrics: {
                        total_revenue: dashboardData.totalRevenue,
                        total_profit: dashboardData.totalProfit,
                        total_customers: dashboardData.totalCustomers,
                        total_products: dashboardData.totalProducts,
                        avg_order_value: dashboardData.avgOrderValue,
                        profit_margin: dashboardData.profitMargin || 20
                    },
                    top_products: dashboardData.topProducts || [],
                    customer_segments: dashboardData.customerSegments || {},
                    geographic_distribution: dashboardData.geographicData || {},
                    monthly_trends: dashboardData.monthlyTrends || []
                };
                
                const jsonContent = JSON.stringify(summary, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `business_summary_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('JSON summary report downloaded successfully!');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                alert('Error exporting JSON: ' + error.message);
            }
        }

        async function exportBusinessCharts() {
            console.log('üìä Exporting business charts as images...');
            
            try {
                const chartIds = ['revenueChart', 'customerChart', 'geoChart', 'trendsChart'];
                const chartImages = [];
                
                // Load JSZip library dynamically if not available
                if (typeof JSZip === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    document.head.appendChild(script);
                    await new Promise((resolve) => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Fallback timeout
                    });
                }
                
                // Capture each chart
                for (const chartId of chartIds) {
                    const chartElement = document.getElementById(chartId);
                    if (chartElement && charts[chartId.replace('Chart', '')]) {
                        try {
                            const canvas = await html2canvas(chartElement, {
                                backgroundColor: '#161b22',
                                scale: 2,
                                useCORS: true
                            });
                            const imageData = canvas.toDataURL('image/png');
                            chartImages.push({
                                name: `${chartId}.png`,
                                data: imageData
                            });
                        } catch (error) {
                            console.error(`Error capturing ${chartId}:`, error);
                        }
                    }
                }
                
                if (chartImages.length === 0) {
                    alert('No charts available to export');
                    return;
                }
                
                // Create ZIP file
                const zip = new JSZip();
                chartImages.forEach(({ name, data }) => {
                    // Convert base64 to blob
                    const base64Data = data.split(',')[1];
                    zip.file(name, base64Data, { base64: true });
                });
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `business_charts_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert(`${chartImages.length} chart(s) exported as ZIP file!`);
            } catch (error) {
                console.error('Error exporting charts:', error);
                alert('Error exporting charts: ' + error.message);
            }
        }

        async function exportAllBusinessData() {
            console.log('üìä Exporting all business data...');
            
            try {
                alert('Preparing complete export package. This may take a moment...');
                
                // Load JSZip library dynamically if not available
                if (typeof JSZip === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    document.head.appendChild(script);
                    await new Promise((resolve) => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000);
                    });
                }
                
                const zip = new JSZip();
                
                // Export CSV
                try {
                    const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
                    const transformedData = JSON.parse(localStorage.getItem('transformedData') || '{}');
                    let dataToExport = transformedData.data || transformedData.preview_data || [];
                    
                    if (Array.isArray(dataToExport) && dataToExport.length > 0) {
                        const headers = Object.keys(dataToExport[0]);
                        let csvContent = headers.join(',') + '\n';
                        dataToExport.forEach(row => {
                            const values = headers.map(header => {
                                const value = row[header] || '';
                                return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                            });
                            csvContent += values.join(',') + '\n';
                        });
                        zip.file('business_data.csv', csvContent);
                    }
                } catch (error) {
                    console.error('Error adding CSV to ZIP:', error);
                }
                
                // Export JSON Summary
                try {
                    const summary = {
                        export_date: new Date().toISOString(),
                        dashboard_metrics: {
                            total_revenue: dashboardData.totalRevenue,
                            total_profit: dashboardData.totalProfit,
                            total_customers: dashboardData.totalCustomers,
                            total_products: dashboardData.totalProducts,
                            avg_order_value: dashboardData.avgOrderValue,
                            profit_margin: dashboardData.profitMargin || 20
                        },
                        top_products: dashboardData.topProducts || [],
                        customer_segments: dashboardData.customerSegments || {},
                        geographic_distribution: dashboardData.geographicData || {},
                        monthly_trends: dashboardData.monthlyTrends || []
                    };
                    zip.file('business_summary.json', JSON.stringify(summary, null, 2));
                } catch (error) {
                    console.error('Error adding JSON to ZIP:', error);
                }
                
                // Export Charts
                try {
                    const chartIds = ['revenueChart', 'customerChart', 'geoChart', 'trendsChart'];
                    for (const chartId of chartIds) {
                        const chartElement = document.getElementById(chartId);
                        if (chartElement && charts[chartId.replace('Chart', '')]) {
                            try {
                                const canvas = await html2canvas(chartElement, {
                                    backgroundColor: '#161b22',
                                    scale: 2,
                                    useCORS: true
                                });
                                const imageData = canvas.toDataURL('image/png');
                                const base64Data = imageData.split(',')[1];
                                zip.file(`${chartId}.png`, base64Data, { base64: true });
                            } catch (error) {
                                console.error(`Error capturing ${chartId}:`, error);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error adding charts to ZIP:', error);
                }
                
                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `business_export_all_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Complete export package downloaded successfully!');
            } catch (error) {
                console.error('Error exporting all data:', error);
                alert('Error exporting all data: ' + error.message);
            }
        }

        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data...');
                
                // Show loading state
                showLoadingState();
                
                // Load data from localStorage or fetch from backend
                const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
                const transformedData = JSON.parse(localStorage.getItem('transformedData') || '{}');
                
                console.log('üìä Merged data:', mergedData);
                console.log('üìä Transformed data:', transformedData);
                
                // If no transformed data, try to load from the merged data
                let dataToProcess = transformedData;
                if (Object.keys(transformedData).length === 0 && mergedData.merged_file) {
                    console.log('üìä No transformed data found, using merged data...');
                    // Try to load the transformed file directly
                    try {
                        const response = await fetch(`http://localhost:5000/api/data/transformed_${mergedData.merged_file.filename}`);
                        if (response.ok) {
                            dataToProcess = await response.json();
                            console.log('‚úÖ Loaded transformed data from backend:', dataToProcess);
                        } else {
                            console.log('‚ö†Ô∏è Transformed file not found, using merged data');
                            dataToProcess = mergedData;
                        }
                    } catch (error) {
                        console.log('‚ö†Ô∏è Error loading transformed data, using merged data:', error);
                        dataToProcess = mergedData;
                    }
                }
                
                if (Object.keys(dataToProcess).length === 0) {
                    throw new Error('No data found. Please go back and process your data first.');
                }

                // Process dashboard data
                dashboardData = await processDashboardData(dataToProcess);
                
                // Render all dashboard components
                renderKPIs();
                renderRevenueChart();
                renderTopProducts();
                renderCustomerChart();
                renderGeoChart();
                renderInsights();
                renderTrendsChart();
                
                console.log('‚úÖ Dashboard loaded successfully!');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                showError('Failed to load dashboard data: ' + error.message);
            }
        }

        function showLoadingState() {
            // Show loading spinners in all sections
            document.getElementById('kpiGrid').innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i></div>';
            document.getElementById('topProducts').innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i></div>';
            document.getElementById('insightsList').innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i></div>';
        }

        function showError(message) {
            const errorHtml = `<div class="error-message">${message}</div>`;
            document.getElementById('kpiGrid').innerHTML = errorHtml;
            document.getElementById('topProducts').innerHTML = errorHtml;
            document.getElementById('insightsList').innerHTML = errorHtml;
        }

        async function processDashboardData(data) {
            console.log('üîç Processing dashboard data...');
            
            // Fetch complete dashboard data from backend API
            try {
                console.log('üì° Fetching complete dashboard data from backend...');
                const response = await fetch('http://localhost:5000/api/analytics/dashboard/complete');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    console.log('‚úÖ Received dashboard data from backend:', result.data);
            return {
                        totalRevenue: result.data.total_revenue || 0,
                        totalProfit: result.data.total_profit || 0,
                        totalCustomers: result.data.total_customers || 0,
                        totalProducts: result.data.total_products || 0,
                        avgOrderValue: result.data.avg_order_value || 0,
                        profitMargin: result.data.profit_margin || 0,
                        topProducts: result.data.top_products || [],
                        customerSegments: result.data.customer_segments || {},
                        geographicData: result.data.geographic_data || {},
                        monthlyTrends: result.data.monthly_trends || []
                    };
                } else {
                    throw new Error(result.error || 'No data received from backend');
                }
            } catch (error) {
                console.error('‚ùå Error fetching dashboard data from backend:', error);
                console.log('üìä Falling back to frontend calculation...');
                // Fallback to calculated values from transformed data
                return calculateFromTransformedData(data);
            }
        }
        
        function calculateFromTransformedData(data) {
            console.log('üìä Calculating metrics from transformed data...');
            console.log('üìä Data structure:', data);
            
            // Handle different data structures
            let rows = [];
            if (data.data && Array.isArray(data.data)) {
                rows = data.data;
            } else if (data.preview_data && Array.isArray(data.preview_data)) {
                rows = data.preview_data;
            } else if (Array.isArray(data)) {
                rows = data;
            } else {
                console.warn('‚ö†Ô∏è No data available for calculation');
                return {
                    totalRevenue: 0,
                    totalProfit: 0,
                    totalCustomers: 0,
                    totalProducts: 0,
                    avgOrderValue: 0,
                    topProducts: [],
                    customerSegments: {},
                    geographicData: {},
                    monthlyTrends: []
                };
            }
            
            console.log('üìä Processing', rows.length, 'rows of data');
            let totalRevenue = 0;
            let totalProfit = 0;
            const customers = new Set();
            const products = new Set();
            const productRevenue = {};
            const countryData = {};
            
            rows.forEach((row, index) => {
                try {
                    // Calculate revenue if Price and Quantity exist
                    if (row.Price && row.Quantity) {
                        const price = parseFloat(row.Price);
                        const quantity = parseInt(row.Quantity);
                        if (!isNaN(price) && !isNaN(quantity)) {
                            const revenue = price * quantity;
                            totalRevenue += revenue;
                            
                            // Track product revenue
                            if (row.ProductName) {
                                if (!productRevenue[row.ProductName]) {
                                    productRevenue[row.ProductName] = { revenue: 0, sales: 0 };
                                }
                                productRevenue[row.ProductName].revenue += revenue;
                                productRevenue[row.ProductName].sales += quantity;
                            }
                        }
                    }
                    
                    // Track customers
                    if (row.CustomerNo) {
                        customers.add(row.CustomerNo);
                    }
                    
                    // Track products
                    if (row.ProductName) {
                        products.add(row.ProductName);
                    }
                    
                    // Track countries
                    if (row.Country) {
                        countryData[row.Country] = (countryData[row.Country] || 0) + 1;
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error processing row ${index}:`, error, row);
                }
            });
            
            console.log('üìä Calculation results:', {
                totalRevenue,
                totalCustomers: customers.size,
                totalProducts: products.size,
                productCount: Object.keys(productRevenue).length
            });
            
            // Calculate profit (assuming 20% margin for now)
            totalProfit = totalRevenue * 0.2;
            
            // Get top products
            const topProducts = Object.entries(productRevenue)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5)
                .map(([name, data]) => ({
                    name: name,
                    revenue: Math.round(data.revenue),
                    sales: data.sales
                }));
            
            // Calculate customer segments (simplified)
            const totalCustomers = customers.size;
            const customerSegments = {
                'High Value': Math.round(totalCustomers * 0.2),
                'Medium Value': Math.round(totalCustomers * 0.5),
                'Low Value': Math.round(totalCustomers * 0.3)
            };
            
            // Calculate geographic distribution
            const totalGeo = Object.values(countryData).reduce((sum, count) => sum + count, 0);
            const geographicData = {};
            Object.entries(countryData).forEach(([country, count]) => {
                geographicData[country] = Math.round((count / totalGeo) * 100);
            });
            
            return {
                totalRevenue: Math.round(totalRevenue),
                totalProfit: Math.round(totalProfit),
                totalCustomers: totalCustomers,
                totalProducts: products.size,
                avgOrderValue: totalCustomers > 0 ? Math.round(totalRevenue / totalCustomers) : 0,
                topProducts: topProducts,
                customerSegments: customerSegments,
                geographicData: geographicData,
                monthlyTrends: [] // Would need date analysis for this
            };
        }

        function renderKPIs() {
            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = `
                <div class="kpi-item">
                    <div class="kpi-value">$${(dashboardData.totalRevenue / 1000000).toFixed(1)}M</div>
                    <div class="kpi-label">Total Revenue</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-value">$${(dashboardData.totalProfit / 1000000).toFixed(1)}M</div>
                    <div class="kpi-label">Total Profit</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-value">${(dashboardData.totalCustomers / 1000).toFixed(1)}K</div>
                    <div class="kpi-label">Total Customers</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-value">${(dashboardData.totalProducts / 1000).toFixed(1)}K</div>
                    <div class="kpi-label">Total Products</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-value">$${(dashboardData.avgOrderValue / 1000).toFixed(1)}K</div>
                    <div class="kpi-label">Avg Order Value</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-value trend-up">${dashboardData.profitMargin || 20}%</div>
                    <div class="kpi-label">Profit Margin</div>
                </div>
            `;
        }

        function renderRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Calculate profit margin
            const profitMargin = dashboardData.totalRevenue > 0 ? 
                ((dashboardData.totalProfit / dashboardData.totalRevenue) * 100).toFixed(1) : 0;
            
            // Calculate revenue without profit
            const revenueWithoutProfit = dashboardData.totalRevenue - dashboardData.totalProfit;
            
            charts.revenue = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Revenue (Net)', 'Profit'],
                    datasets: [{
                        data: [revenueWithoutProfit, dashboardData.totalProfit],
                        backgroundColor: ['#58a6ff', '#3fb950'],
                        borderWidth: 2,
                        borderColor: '#21262d',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#58a6ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f0f6fc',
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 1,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 10,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    const formattedValue = value.toLocaleString('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                    
                                    return [
                                        `${formattedValue}`,
                                        `${percentage}% of total`
                                    ];
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const label = charts.revenue.data.labels[elementIndex];
                            const value = charts.revenue.data.datasets[0].data[elementIndex];
                            const total = charts.revenue.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            
                            const formattedValue = value.toLocaleString('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            });
                            
                            alert(`${label}: ${formattedValue} (${percentage}%)`);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            // Add center text with profit margin
            const centerText = document.createElement('div');
            centerText.className = 'chart-center-text';
            centerText.innerHTML = `
                <div style="text-align: center; color: #f0f6fc;">
                    <div style="font-size: 28px; font-weight: bold; color: #3fb950; margin-bottom: 4px;">${profitMargin}%</div>
                    <div style="font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px;">Profit Margin</div>
                </div>
            `;
            
            const chartContainer = document.getElementById('revenueChart').parentElement;
            chartContainer.style.position = 'relative';
            chartContainer.appendChild(centerText);
            
        }

        function renderTopProducts() {
            const topProducts = document.getElementById('topProducts');
            topProducts.innerHTML = dashboardData.topProducts.map((product, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #30363d;">
                    <div>
                        <div style="font-weight: 600; color: #f0f6fc;">${index + 1}. ${product.name}</div>
                        <div style="font-size: 0.9em; color: #8b949e;">${product.sales} sales</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #58a6ff; font-weight: 600;">$${product.revenue.toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomerChart() {
            const ctx = document.getElementById('customerChart').getContext('2d');
            
            const customerData = dashboardData.customerSegments;
            const labels = Object.keys(customerData);
            const values = Object.values(customerData);
            const totalCustomers = values.reduce((sum, val) => sum + val, 0);
            
            // Define colors for different customer segments
            const segmentColors = {
                'High Value': '#3fb950',
                'Medium Value': '#58a6ff', 
                'Low Value': '#f85149'
            };
            
            const backgroundColors = labels.map(label => segmentColors[label] || '#58a6ff');
            
            charts.customer = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Customer Count',
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color),
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 1,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 10,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = ((value / totalCustomers) * 100).toFixed(1);
                                    return [
                                        `Customers: ${value.toLocaleString()}`,
                                        `Percentage: ${percentage}% of total`,
                                        `Segment: ${context.label}`
                                    ];
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const label = charts.customer.data.labels[elementIndex];
                            const value = charts.customer.data.datasets[0].data[elementIndex];
                            const percentage = ((value / totalCustomers) * 100).toFixed(1);
                            
                            alert(`${label} Customers:
Count: ${value.toLocaleString()}
Percentage: ${percentage}% of total customers`);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                color: '#30363d',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Number of Customers',
                                color: '#8b949e',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            // Add summary text below the chart
            const chartContainer = document.getElementById('customerChart').parentElement;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'customer-summary';
            
            // Calculate segment percentages
            const highValuePct = ((customerData['High Value'] || 0) / totalCustomers * 100).toFixed(1);
            const mediumValuePct = ((customerData['Medium Value'] || 0) / totalCustomers * 100).toFixed(1);
            const lowValuePct = ((customerData['Low Value'] || 0) / totalCustomers * 100).toFixed(1);
            
            summaryDiv.innerHTML = `
                <div style="text-align: center; color: #8b949e; font-size: 12px; margin-top: 10px;">
                    <div style="margin-bottom: 5px;">
                        Total Customers: <span style="color: #58a6ff; font-weight: bold;">${totalCustomers.toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-around; font-size: 11px; margin-top: 8px;">
                        <span style="color: #3fb950;">High: ${highValuePct}%</span>
                        <span style="color: #58a6ff;">Medium: ${mediumValuePct}%</span>
                        <span style="color: #f85149;">Low: ${lowValuePct}%</span>
                    </div>
                </div>
            `;
            chartContainer.appendChild(summaryDiv);
        }

        // Global variables for chart controls
        let geoChartZoom = 1;
        let geoChartLegendVisible = true;
        let geoChartInstance = null;

        function renderGeoChart() {
            const ctx = document.getElementById('geoChart').getContext('2d');
            console.log('üéØ Rendering geographic chart...');
            console.log('üìä Chart container:', document.getElementById('geoChartContainer'));
            console.log('üìä Chart canvas:', document.getElementById('geoChart'));
            
            // Generate more colors for better distinction
            const colors = [
                '#58a6ff', '#79c0ff', '#3fb950', '#f85149', '#ffa657', '#a5a5a5',
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3',
                '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43', '#ee5a24', '#0abde3',
                '#10ac84', '#f368e0', '#ff6348', '#2ed573', '#ffa502', '#ff6348',
                '#3742fa', '#2f3542', '#ff4757', '#2ed573', '#ffa502', '#ff6348'
            ];
            
            const geoData = dashboardData.geographicData;
            const labels = Object.keys(geoData);
            const values = Object.values(geoData);
            
            // Sort by value to show top countries first
            const sortedData = labels.map((label, index) => ({
                label,
                value: values[index],
                color: colors[index % colors.length]
            })).sort((a, b) => b.value - a.value);
            
            // Destroy existing chart if it exists
            if (geoChartInstance) {
                geoChartInstance.destroy();
            }
            
            geoChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sortedData.map(item => item.label),
                    datasets: [{
                        data: sortedData.map(item => item.value),
                        backgroundColor: sortedData.map(item => item.color),
                        borderWidth: 1,
                        borderColor: '#21262d'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend since we have the country list
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            titleFont: {
                                size: 12 * geoChartZoom
                            },
                            bodyFont: {
                                size: 11 * geoChartZoom
                            },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ${value.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 500,
                        easing: 'easeInOutQuart'
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            highlightCountryInList(elementIndex);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
            
            charts.geo = geoChartInstance;
            renderCountryList(sortedData);
            setupGeoChartControls();
            
            // Ensure chart is properly sized
            setTimeout(() => {
                if (geoChartInstance) {
                    geoChartInstance.resize();
                }
            }, 100);
            
            // Add window resize listener
            window.addEventListener('resize', () => {
                if (geoChartInstance) {
                    setTimeout(() => {
                        geoChartInstance.resize();
                    }, 50);
                }
            });
        }

        function renderCountryList(sortedData) {
            const countryList = document.getElementById('countryList');
            const searchInput = document.getElementById('countrySearch');
            
            // Clear existing list
            countryList.innerHTML = '';
            
            // Create country items
            sortedData.forEach((country, index) => {
                const countryItem = document.createElement('div');
                countryItem.className = 'country-item';
                countryItem.dataset.index = index;
                countryItem.innerHTML = `
                    <div class="country-color" style="background-color: ${country.color}"></div>
                    <div class="country-name">${country.label}</div>
                    <div class="country-percentage">${country.value.toFixed(1)}%</div>
                `;
                
                // Add click event
                countryItem.addEventListener('click', () => {
                    highlightCountryInChart(index);
                    highlightCountryInList(index);
                });
                
                // Add hover event
                countryItem.addEventListener('mouseenter', () => {
                    highlightCountryInChart(index);
                });
                
                countryList.appendChild(countryItem);
            });
            
            // Add search functionality
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const items = countryList.querySelectorAll('.country-item');
                
                items.forEach(item => {
                    const countryName = item.querySelector('.country-name').textContent.toLowerCase();
                    if (countryName.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        function highlightCountryInChart(index) {
            if (geoChartInstance) {
                // Reset all segments
                geoChartInstance.data.datasets[0].borderWidth = Array(geoChartInstance.data.labels.length).fill(1);
                geoChartInstance.data.datasets[0].borderColor = Array(geoChartInstance.data.labels.length).fill('#21262d');
                
                // Highlight selected segment
                geoChartInstance.data.datasets[0].borderWidth[index] = 3;
                geoChartInstance.data.datasets[0].borderColor[index] = '#58a6ff';
                
                geoChartInstance.update('active');
            }
        }

        function highlightCountryInList(index) {
            // Remove active class from all items
            document.querySelectorAll('.country-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected item
            const selectedItem = document.querySelector(`[data-index="${index}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function setupGeoChartControls() {
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const resetZoomBtn = document.getElementById('resetZoomBtn');
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomInfo = document.getElementById('zoomInfo');

            // Zoom In
            zoomInBtn.addEventListener('click', () => {
                geoChartZoom = Math.min(geoChartZoom + 0.2, 3);
                updateGeoChartZoom();
            });

            // Zoom Out
            zoomOutBtn.addEventListener('click', () => {
                geoChartZoom = Math.max(geoChartZoom - 0.2, 0.5);
                updateGeoChartZoom();
            });

            // Reset Zoom
            resetZoomBtn.addEventListener('click', () => {
                geoChartZoom = 1;
                updateGeoChartZoom();
            });

            // Zoom Slider
            zoomSlider.addEventListener('input', (e) => {
                geoChartZoom = parseFloat(e.target.value);
                updateGeoChartZoom();
            });

            function updateGeoChartZoom() {
                if (geoChartInstance) {
                    // Update zoom info
                    zoomInfo.textContent = `Zoom: ${Math.round(geoChartZoom * 100)}%`;
                    zoomSlider.value = geoChartZoom;
                    
                    // Update chart options
                    geoChartInstance.options.layout.padding = {
                        top: 20 * geoChartZoom,
                        bottom: 20 * geoChartZoom,
                        left: 20 * geoChartZoom,
                        right: 20 * geoChartZoom
                    };
                    
                    geoChartInstance.options.plugins.tooltip.titleFont.size = 12 * geoChartZoom;
                    geoChartInstance.options.plugins.tooltip.bodyFont.size = 11 * geoChartZoom;
                    
                    // Update chart canvas size
                    const canvas = document.getElementById('geoChart');
                    const baseSize = 400;
                    const newSize = baseSize * geoChartZoom;
                    canvas.style.width = `${newSize}px`;
                    canvas.style.height = `${newSize}px`;
                    
                    geoChartInstance.update('active');
                }
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.closest('.dashboard-card')) {
                    switch(e.key) {
                        case '+':
                        case '=':
                            e.preventDefault();
                            geoChartZoom = Math.min(geoChartZoom + 0.2, 3);
                            updateGeoChartZoom();
                            break;
                        case '-':
                            e.preventDefault();
                            geoChartZoom = Math.max(geoChartZoom - 0.2, 0.5);
                            updateGeoChartZoom();
                            break;
                        case '0':
                            e.preventDefault();
                            geoChartZoom = 1;
                            updateGeoChartZoom();
                            break;
                    }
                }
            });
        }

        function renderInsights() {
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = `
                <li><i class="fas fa-check-circle"></i><span>Revenue increased by 15% compared to last quarter</span></li>
                <li><i class="fas fa-check-circle"></i><span>Top 5 products generate 40% of total revenue</span></li>
                <li><i class="fas fa-check-circle"></i><span>Customer retention rate is 85%</span></li>
                <li><i class="fas fa-check-circle"></i><span>Average order value increased by 12%</span></li>
                <li><i class="fas fa-check-circle"></i><span>United Kingdom market dominates with 85% share</span></li>
                <li><i class="fas fa-check-circle"></i><span>Seasonal trends show peak sales in December</span></li>
            `;
        }

        function renderTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            const trendsData = dashboardData.monthlyTrends;
            const revenueData = trendsData.map(t => t.revenue);
            const profitData = trendsData.map(t => t.profit);
            const labels = trendsData.map(t => t.month);
            
            // Calculate growth rates
            const revenueGrowth = revenueData.length > 1 ? 
                ((revenueData[revenueData.length - 1] - revenueData[0]) / revenueData[0] * 100).toFixed(1) : 0;
            const profitGrowth = profitData.length > 1 ? 
                ((profitData[profitData.length - 1] - profitData[0]) / profitData[0] * 100).toFixed(1) : 0;
            
            // Find peak and low points
            const maxRevenue = Math.max(...revenueData);
            const minRevenue = Math.min(...revenueData);
            const maxProfit = Math.max(...profitData);
            const minProfit = Math.min(...profitData);
            
            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.15)',
                        borderWidth: 3,
                        pointBackgroundColor: '#58a6ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Profit',
                        data: profitData,
                        borderColor: '#3fb950',
                        backgroundColor: 'rgba(63, 185, 80, 0.15)',
                        borderWidth: 3,
                        pointBackgroundColor: '#3fb950',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f0f6fc',
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#58a6ff',
                            borderWidth: 2,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formattedValue = value.toLocaleString('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                    
                                    return `${context.dataset.label}: ${formattedValue}`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const datasetIndex = element.datasetIndex;
                            const dataIndex = element.index;
                            const label = labels[dataIndex];
                            const value = element.parsed.y;
                            const datasetLabel = charts.trends.data.datasets[datasetIndex].label;
                            
                            const formattedValue = value.toLocaleString('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            });
                            
                            alert(`${datasetLabel} - ${label}:
Amount: ${formattedValue}
${datasetLabel === 'Revenue' ? 
    `Peak: $${maxRevenue.toLocaleString()}
    Low: $${minRevenue.toLocaleString()}` : 
    `Peak: $${maxProfit.toLocaleString()}
    Low: $${minProfit.toLocaleString()}`}`);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: {
                                color: '#30363d',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Amount ($M)',
                                color: '#8b949e',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8b949e',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: '#30363d',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Time Period',
                                color: '#8b949e',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            // Add summary statistics below the chart
            const chartContainer = document.getElementById('trendsChart').parentElement;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'trends-summary';
            summaryDiv.innerHTML = `
                <div style="text-align: center; color: #8b949e; font-size: 12px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-around; margin-bottom: 8px;">
                        <span style="color: #58a6ff;">
                            Revenue Growth: <span style="color: ${revenueGrowth >= 0 ? '#3fb950' : '#f85149'}; font-weight: bold;">${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth}%</span>
                        </span>
                        <span style="color: #3fb950;">
                            Profit Growth: <span style="color: ${profitGrowth >= 0 ? '#3fb950' : '#f85149'}; font-weight: bold;">${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%</span>
                        </span>
                    </div>
                    <div style="font-size: 11px; color: #8b949e;">
                        Click data points for detailed information
                    </div>
                </div>
            `;
            chartContainer.appendChild(summaryDiv);
        }
    </script>
</body>
</html>
