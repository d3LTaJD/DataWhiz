<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DataWhiz - Data Preview</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/theme.css">
  <style>
    /* Map theme variables for compatibility */
    :root {
      --text: var(--muted);
      --border: var(--divider);
      --card-bg: var(--surface);
    }
    
    .preview-container {
      max-width: 100%;
      margin: 0;
      padding: 24px;
      min-height: 100vh;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .preview-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }
    
    .preview-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px 24px;
      text-align: center;
      min-width: 140px;
      flex: 1;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-color: var(--primary);
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--muted-2);
    }
    
    .back-button {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-button:hover {
      background: var(--primary);
      color: white;
      transform: translateX(-2px);
    }
    
    .data-table-container {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 30px;
      box-shadow: var(--card-shadow);
    }
    
    .table-header {
      background: var(--surface);
      padding: 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .table-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 8px 0;
    }
    
    .table-subtitle {
      color: var(--muted-2);
      font-size: 0.9rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 100%;
    }
    
    .data-table th {
      background: var(--surface-2);
      color: var(--text);
      font-weight: 600;
      padding: 16px 12px;
      text-align: left;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
      min-width: 120px;
      text-transform: capitalize;
      letter-spacing: 0.3px;
    }
    
    .data-table td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--muted-2);
      min-width: 100px;
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
      position: relative;
    }
    
    .data-table td:hover {
      background: var(--surface);
      color: var(--muted);
    }
    
    .data-table td[title]:hover {
      cursor: help;
    }
    
    .data-table tr:hover {
      background: var(--surface);
    }
    
    .data-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }
    
    .data-table tr:nth-child(even):hover {
      background: var(--surface);
    }
    
    .table-scroll {
      max-height: 65vh;
      overflow: auto;
      background: var(--surface);
    }
    
    .table-scroll-wrapper {
      position: relative;
    }
    
    .table-scroll::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    .table-scroll::-webkit-scrollbar-track {
      background: var(--surface-2);
      border-radius: 6px;
    }
    
    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 6px;
    }
    
    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--primary-2);
    }
    
    .table-scroll::-webkit-scrollbar-corner {
      background: var(--surface-2);
    }
    
    .table-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    
    .load-more-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(108, 99, 255, 0.2);
    }
    
    .load-more-btn:hover {
      background: var(--primary-2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
    }
    
    .load-more-btn:active {
      transform: translateY(0);
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-2);
      color: var(--accent);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid var(--border);
    }
    
    .status-badge::before {
      content: "‚úì";
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 11px;
      font-weight: 700;
    }
    
    .data-info {
      color: var(--muted-2);
      font-size: 0.9rem;
      font-weight: 500;
      padding: 8px 12px;
      background: var(--surface-2);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .action-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 40px;
      padding: 30px 0;
      border-top: 1px solid var(--border);
    }
    
    .action-btn {
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }
    
    .action-btn.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
    }
    
    .action-btn.primary:hover {
      background: var(--primary-2);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(108, 99, 255, 0.4);
    }
    
    .action-btn.primary:active {
      transform: translateY(0);
    }
    
    .action-btn.secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .action-btn.secondary:hover {
      background: var(--surface-2);
      transform: translateY(-1px);
    }
    
    .column-info {
      background: var(--surface);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }
    
    .column-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
    }
    
    .column-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .column-tag {
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="preview-container">
    <div class="preview-header">
      <div>
        <h1 class="preview-title">üìä Data Preview</h1>
        <p style="color: var(--muted-2); margin: 8px 0 0 0;">Review your merged data before proceeding to analysis</p>
      </div>
      <a href="upload.html" class="back-button">‚Üê Back to Upload</a>
    </div>
    
    <div class="preview-stats" id="previewStats">
      <!-- Stats will be populated by JavaScript -->
    </div>
    
    <div class="column-info">
      <div class="column-title">Column Information:</div>
      <div class="column-tags" id="columnTags">
        <!-- Column tags will be populated by JavaScript -->
      </div>
    </div>
    
    <div class="data-table-container">
      <div class="table-header">
        <h3 class="table-title">Data Preview</h3>
        <p class="table-subtitle">Showing data from your merged files</p>
        <div class="table-controls">
          <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreData()">Load More Rows</button>
          <span class="data-info" id="dataInfo">Showing 50 of 536,350 rows</span>
          <span class="status-badge" id="statusBadge" style="display: none;">All Preview Data Loaded</span>
        </div>
      </div>
      <div class="table-scroll">
        <table class="data-table" id="dataTable">
          <!-- Table will be populated by JavaScript -->
        </table>
      </div>
    </div>
    
      <div class="action-buttons">
      <button class="action-btn secondary" onclick="goBack()">‚Üê Back to Upload</button>
      <button class="action-btn primary" onclick="proceedToAnalysis()">Continue to Analysis ‚Üí</button>
    </div>
  </div>

  <script>
    // Get data from localStorage (passed from upload page)
    const mergedData = JSON.parse(localStorage.getItem('mergedData') || '{}');
    let currentRowsShown = 0;
    const rowsPerLoad = 50;
    
    function populatePreview() {
      if (!mergedData.merged_file) {
        alert('No data found. Please go back and upload files.');
        return;
      }
      
      // Populate stats
      const statsContainer = document.getElementById('previewStats');
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${mergedData.merged_file.total_rows.toLocaleString()}</div>
          <div class="stat-label">Total Rows</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${mergedData.merged_file.total_columns}</div>
          <div class="stat-label">Total Columns</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${mergedData.uploaded_files.length}</div>
          <div class="stat-label">Files Merged</div>
        </div>
      `;
      
      // Populate column tags
      const columnTags = document.getElementById('columnTags');
      columnTags.innerHTML = mergedData.merged_file.column_names.map(col => 
        `<span class="column-tag">${col}</span>`
      ).join('');
      
      // Populate data table
      const table = document.getElementById('dataTable');
      if (mergedData.preview_data && mergedData.preview_data.length > 0) {
        // Create header
        const headerRow = document.createElement('tr');
        mergedData.merged_file.column_names.forEach(col => {
          const th = document.createElement('th');
          th.textContent = col;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        
        // Show initial data
        currentRowsShown = Math.min(mergedData.preview_data.length, rowsPerLoad);
        showDataRows(0, currentRowsShown);
        
        // Update data info
        updateDataInfo();
      } else {
        table.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: var(--muted-2);">No preview data available</td></tr>';
      }
    }
    
    function showDataRows(startIndex, endIndex) {
      const table = document.getElementById('dataTable');
      // Remove existing data rows (keep header)
      const existingRows = table.querySelectorAll('tr:not(:first-child)');
      existingRows.forEach(row => row.remove());
      
        // Add new data rows
        for (let i = startIndex; i < endIndex && i < mergedData.preview_data.length; i++) {
          const row = mergedData.preview_data[i];
          const tr = document.createElement('tr');
          mergedData.merged_file.column_names.forEach(col => {
            const td = document.createElement('td');
            const cellValue = row[col] !== null && row[col] !== undefined ? String(row[col]) : 'N/A';
            td.textContent = cellValue;
            
            // Add tooltip for truncated cells
            if (cellValue.length > 30) {
              td.title = cellValue;
            }
            
            tr.appendChild(td);
          });
          table.appendChild(tr);
        }
    }
    
    function updateDataInfo() {
      const dataInfo = document.getElementById('dataInfo');
      const statusBadge = document.getElementById('statusBadge');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      const totalRows = mergedData.merged_file.total_rows;
      
      dataInfo.textContent = `Showing ${currentRowsShown.toLocaleString()} of ${totalRows.toLocaleString()} rows`;
      
      // Show status badge and hide button if all preview data is loaded
      if (currentRowsShown >= mergedData.preview_data.length) {
        loadMoreBtn.style.display = 'none';
        statusBadge.style.display = 'inline-flex';
      } else {
        loadMoreBtn.style.display = 'inline-block';
        statusBadge.style.display = 'none';
      }
    }
    
    function loadMoreData() {
      if (currentRowsShown < mergedData.preview_data.length) {
        const newEndIndex = Math.min(currentRowsShown + rowsPerLoad, mergedData.preview_data.length);
        showDataRows(0, newEndIndex);
        currentRowsShown = newEndIndex;
        updateDataInfo();
      }
    }
    
    function goBack() {
      window.location.href = 'upload.html';
    }
    
    function proceedToAnalysis() {
      // Store the merged filename for use in analysis
      localStorage.setItem('mergedDataFile', mergedData.merged_file.filename);
      
      // Get the selected analysis type
      const analysisType = localStorage.getItem('selectedAnalysisType') || 'business';
      
      // Redirect to the appropriate analysis page
      switch(analysisType) {
        case 'business':
          window.location.href = 'business-analysis/index.html';
          break;
        case 'healthcare':
          window.location.href = 'healthcare-analysis/index.html';
          break;
        case 'finance':
          window.location.href = 'finance-analysis/index.html';
          break;
        default:
          window.location.href = 'business-analysis/index.html';
      }
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      populatePreview();
      
      // Restore theme preference
      const savedTheme = localStorage.getItem('dw-theme');
      if (savedTheme === 'light') {
        document.documentElement.classList.add('light');
      }
    });
  </script>
</body>
</html>
